<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cl√≠nicaSys Pro v6.0 - TV Integrada</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#10b981" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="apple-touch-icon" href="/icon-192.png" />

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          // Registra na raiz para ter controle total
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((reg) =>
              console.log("‚úÖ Service Worker registrado na raiz!", reg)
            )
            .catch((err) => console.log("‚ùå Erro no Service Worker:", err));
        });
      }
    </script>
    <style>
      :root {
        --bg-main: #111827;
        --bg-card: #1f2937;
        --bg-input: #374151;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --primary: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --border: #4b5563;
      }
      .prof-row {
        transition: background 0.2s;
      }
      .prof-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .prof-avatar-small {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border);
      }

      .prof-main-info {
        display: flex;
        flex-direction: column;
      }

      .prof-name {
        font-weight: 700;
        color: white;
        font-size: 0.95rem;
      }

      .prof-sub {
        font-size: 0.8rem;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .color-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .badge-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-on {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid #10b981;
      }
      .status-off {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
      }
      .lista-historico-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 10px;
        max-height: 70vh; /* Garante scroll se tiver muita coisa */
        overflow-y: auto;
      }

      /* Scrollbar bonita */
      .lista-historico-container::-webkit-scrollbar {
        width: 6px;
      }
      .lista-historico-container::-webkit-scrollbar-track {
        background: transparent;
      }
      .lista-historico-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      .card-historico {
        display: grid;
        grid-template-columns: 85px 1fr 40px; /* Data | Conte√∫do | Seta */
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .card-historico:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        background: #1f2937;
      }

      /* Coluna da Data (Esquerda) */
      .card-hist-date {
        background: var(--bg-input);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 1px solid var(--border);
        padding: 10px;
        text-align: center;
      }

      .ch-dia {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
      }
      .ch-mes {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 600;
        margin-top: 2px;
      }
      .ch-ano {
        font-size: 0.7rem;
        color: var(--muted);
        opacity: 0.7;
      }
      .th-matriz {
        background: #374151;
        color: white;
        padding: 15px 10px;
        border-bottom: 1px solid #4b5563;
        border-right: 1px solid #4b5563;
        font-weight: bold;
        text-align: center;
        min-width: 120px;
      }
      .th-fixo {
        position: sticky;
        left: 0;
        z-index: 20;
        background: #1f2937;
        text-align: left;
        min-width: 250px;
        border-right: 2px solid var(--primary);
      }
      .td-matriz {
        padding: 0;
        border-right: 1px solid #333;
        border-bottom: 1px solid #333;
      }
      .input-matriz {
        width: 100%;
        height: 45px;
        background: transparent;
        border: none;
        color: #ccc;
        text-align: center;
        font-size: 0.9rem;
        margin: 0;
        border-radius: 0;
      }
      .input-matriz:focus {
        background: #1f2937;
        color: white;
        box-shadow: inset 0 0 0 2px var(--primary);
      }
      .input-changed {
        background: rgba(245, 158, 11, 0.1) !important;
        color: #f59e0b !important;
        font-weight: bold;
      }

      /* Coluna do Conte√∫do (Centro) */
      .card-hist-content {
        padding: 12px 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
      }

      .ch-prof {
        font-size: 0.8rem;
        color: var(--primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .ch-resumo {
        font-size: 0.95rem;
        font-weight: 500;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .ch-tags {
        display: flex;
        gap: 8px;
        margin-top: 4px;
      }

      .tag-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: #374151;
        color: #ccc;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Coluna da Seta (Direita) */
      .card-hist-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.02);
      }
      .card-historico:hover .card-hist-arrow {
        color: var(--primary);
        background: rgba(16, 185, 129, 0.1);
      }

      .lista-historico-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 10px;
        max-height: 70vh;
        /* Garante scroll se tiver muita coisa */
        overflow-y: auto;
      }

      /* Scrollbar bonita */
      .lista-historico-container::-webkit-scrollbar {
        width: 6px;
      }

      .lista-historico-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .lista-historico-container::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      .card-historico {
        display: grid;
        grid-template-columns: 85px 1fr 40px;
        /* Data | Conte√∫do | Seta */
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .card-historico:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        background: #1f2937;
      }

      /* Coluna da Data (Esquerda) */
      .card-hist-date {
        background: var(--bg-input);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 1px solid var(--border);
        padding: 10px;
        text-align: center;
      }

      .ch-dia {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--text);
        line-height: 1;
      }

      .ch-mes {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 600;
        margin-top: 2px;
      }

      .ch-ano {
        font-size: 0.7rem;
        color: var(--muted);
        opacity: 0.7;
      }

      /* Coluna do Conte√∫do (Centro) */
      .card-hist-content {
        padding: 12px 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
      }

      .ch-prof {
        font-size: 0.8rem;
        color: var(--primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .ch-resumo {
        font-size: 0.95rem;
        font-weight: 500;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .ch-tags {
        display: flex;
        gap: 8px;
        margin-top: 4px;
      }

      .tag-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: #374151;
        color: #ccc;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Coluna da Seta (Direita) */
      .card-hist-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.02);
      }

      .card-historico:hover .card-hist-arrow {
        color: var(--primary);
        background: rgba(16, 185, 129, 0.1);
      }

      .hist-card:hover .hist-arrow {
        color: var(--primary);
        transform: translateX(5px);
      }

      /* --- COCKPIT M√âDICO --- */
      .med-stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .med-stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s;
      }

      .med-stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
      }

      .med-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .patient-row {
        display: flex;
        align-items: center;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        transition: all 0.2s;
        border-left: 4px solid transparent;
      }

      .patient-row:hover {
        background: var(--bg-card);
        transform: translateX(5px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .p-time {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--text);
        width: 70px;
        text-align: center;
        border-right: 1px solid var(--border);
        margin-right: 15px;
      }

      .p-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border);
        margin-right: 15px;
      }

      .p-info {
        flex: 1;
      }

      .p-name {
        font-weight: bold;
        font-size: 1rem;
        color: white;
        display: block;
      }

      .p-detail {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .p-badges {
        display: flex;
        gap: 5px;
        margin-top: 3px;
      }

      .p-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: #333;
        color: #ccc;
      }

      .status-wait {
        border-left-color: #f59e0b;
      }

      /* Esperando */
      .status-done {
        border-left-color: #10b981;
        opacity: 0.7;
      }

      /* Finalizado */
      .status-active {
        border-left-color: #ec4899;
        background: rgba(236, 72, 153, 0.1);
      }

      /* Em Atendimento */

      .timeline-item {
        position: relative;
        padding-left: 20px;
        margin-bottom: 15px;
        border-left: 2px solid var(--border);
        cursor: pointer;
        transition: all 0.2s;
      }

      .timeline-item:hover {
        border-left-color: var(--primary);
        background: rgba(255, 255, 255, 0.05);
      }

      .timeline-dot {
        position: absolute;
        left: -6px;
        top: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--muted);
        transition: 0.2s;
      }

      .timeline-item:hover .timeline-dot {
        background: var(--primary);
        transform: scale(1.3);
      }

      .hist-date {
        font-size: 0.8rem;
        color: var(--primary);
        font-weight: bold;
      }

      .hist-doc {
        font-size: 0.75rem;
        color: var(--muted);
        margin-bottom: 3px;
      }

      .hist-resumo {
        font-size: 0.85rem;
        color: white;
        line-height: 1.3;
      }

      /* --- MODAL ESPELHO (READ-ONLY) --- */
      .field-read {
        background: #1f2937 !important;
        border: 1px solid #374151 !important;
        color: #e5e7eb !important;
        cursor: default;
      }

      .label-read {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: bold;
        margin-bottom: 2px;
      }

      .soap-box {
        padding: 10px;
        border-radius: 6px;
        background: #111827;
        border-left: 4px solid #555;
        margin-bottom: 10px;
        white-space: pre-wrap;
        /* Mant√©m quebras de linha */
      }

      .btn-icon {
        width: 34px;
        height: 34px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        margin-left: 4px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: 0.2s;
        color: white;
      }

      .paciente-foto-wrapper {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: var(--bg-input);
        border: 3px solid var(--primary);
        overflow: hidden;
        margin: 0 auto 15px auto;
        position: relative;
        cursor: pointer;
      }

      .paciente-foto-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .paciente-foto-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        font-size: 0.7rem;
        text-align: center;
        padding: 3px;
      }

      .btn-icon:hover {
        transform: scale(1.1);
        filter: brightness(1.1);
      }

      .anexo-box {
        border: 2px dashed var(--border);
        padding: 20px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 10px;
        transition: 0.2s;
      }

      .anexo-box:hover {
        border-color: var(--primary);
        background: rgba(16, 185, 129, 0.1);
      }

      .thumb-lista {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .thumb-item {
        position: relative;
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #555;
      }

      .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .thumb-remove {
        position: absolute;
        top: 0;
        right: 0;
        background: red;
        color: white;
        font-size: 10px;
        padding: 2px;
        cursor: pointer;
      }

      .btn-modelo {
        font-size: 0.75rem;
        padding: 2px 8px;
        background: var(--info);
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        margin-left: 10px;
      }
      #rel-tab th {
        color: white !important;
        background-color: var(--bg-card) !important;
        border-bottom: 2px solid var(--border);
      }

      #rel-tab td {
        color: #e5e7eb; /* Branco suave */
        border-bottom: 1px solid var(--border);
      }

      /* Mant√©m as cores de status (Verde/Vermelho) se houver */
      #rel-tab td span.status-badge {
        color: white !important;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background: var(--bg-main);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }

      .dash-top-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        /* 50% para cada */
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      @media (max-width: 1000px) {
        .dash-top-row {
          grid-template-columns: 1fr;
        }
      }

      /* Ajuste de altura do Calend√°rio e Gr√°fico */
      .dash-widget {
        height: 400px;
        /* Altura fixa menor */
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Estilo da Nova Grid Completa */
      .dash-grid-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        background: var(--bg-input);
        padding: 10px;
        border-radius: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .dash-grid-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary);
        margin-right: auto;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
      }

      .st-agendado {
        background: #f59e0b;
        color: black;
      }

      .st-confirmado {
        background: #3b82f6;
        color: white;
      }

      .st-atendimento {
        background: #ec4899;
        color: white;
      }

      .st-finalizado {
        background: #10b981;
        color: white;
      }

      .st-cancelado {
        background: #ef4444;
        color: white;
      }

      /* Bot√µes de A√ß√£o na Grid */
      .grid-actions {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
      }

      #login-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: var(--bg-main);
        z-index: 99999;
      }

      .login-box {
        background: var(--bg-card);
        padding: 3rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        width: 400px;
        text-align: center;
      }

      .login-box h2 {
        color: var(--primary);
        margin-bottom: 2rem;
      }

      .login-box input {
        width: 100%;
        padding: 12px;
        margin-bottom: 1rem;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: white;
      }

      .login-box button {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
      }

      .evento-contador {
        text-align: center !important;
        justify-content: center !important;
        font-weight: bold !important;
        font-size: 0.85rem !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        margin-top: 2px !important;
        border: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .evento-contador:hover {
        filter: brightness(1.1);
        transform: scale(1.02);
      }
      #print-frame {
        position: fixed;
        height: 0;
        width: 0;
        border: none;
        visibility: hidden;
      }

      /* Garante que o sistema nunca suma, mesmo se imprimir */
      @media print {
        #app-screen {
          display: flex !important;
        }
        aside {
          display: flex !important;
        }
      }

      #app-screen {
        display: none;
        height: 100vh;
        width: 100%;
        position: relative;
        z-index: 1;
        display: flex;
      }

      aside {
        width: 260px;
        background: var(--bg-card);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 1.5rem 1.5rem 150px 1.5rem;
        transition: width 0.3s;
        flex-shrink: 0;
        overflow-y: auto;
      }

      @media (max-width: 800px) {
        aside {
          width: 70px;
          padding: 1rem 0.5rem 150px 0.5rem;
        }

        aside h2,
        aside small,
        aside button span {
          display: none;
        }

        aside button {
          justify-content: center;
        }
      }
      .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        background: var(--bg-input);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }

      .profile-pic-area {
        position: relative;
        width: 80px;
        height: 80px;
        flex-shrink: 0;
      }

      .profile-pic {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
        background: #000;
      }

      .profile-edit-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--primary);
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        border: 2px solid var(--bg-card);
      }

      .profile-info h3 {
        margin: 0;
        color: white;
        font-size: 1.2rem;
      }

      .profile-info p {
        margin: 5px 0 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* Se√ß√µes do Formul√°rio */
      .form-section {
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--primary);
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 5px;
      }

      /* Grid de Inputs Melhorado */
      .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }

      .input-grid.cols-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .input-grid.cols-2 {
        grid-template-columns: 1fr 1fr;
      }

      /* Estilo dos Inputs */
      .modern-input {
        display: flex;
        flex-direction: column;
      }

      .modern-input label {
        font-size: 0.8rem;
        margin-bottom: 6px;
        color: #ccc;
        font-weight: 500;
      }

      .modern-input input,
      .modern-input select,
      .modern-input textarea {
        background: #18181b; /* Mais escuro que o card */
        border: 1px solid #3f3f46;
        padding: 10px 12px;
        border-radius: 6px;
        color: white;
        transition: all 0.2s;
      }

      .modern-input input:focus {
        border-color: var(--primary);
        background: #27272a;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
      }

      /* √Årea de Upload de Assinatura/Docs */
      .upload-area {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.02);
        transition: 0.2s;
      }

      .upload-area:hover {
        border-color: var(--primary);
        background: rgba(16, 185, 129, 0.05);
      }

      main {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        min-width: 0;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: 0.2s;
        font-size: 0.9rem;
      }

      .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .btn-p {
        background: var(--primary);
      }

      .btn-d {
        background: var(--danger);
      }

      .btn-s {
        background: var(--bg-input);
      }

      .btn-i {
        background: var(--info);
      }

      /* === NOVO: BOT√ÉO DE CHAMAR NA TV === */
      .btn-chamar {
        width: 100%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        padding: 12px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
        margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-chamar:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5);
      }

      .btn-chamar:active {
        transform: scale(0.98);
      }

      .card {
        background: var(--bg-card);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 1.5rem;
        overflow: auto;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .dash-content {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 1.5rem;
      }

      @media (max-width: 1200px) {
        .dash-content {
          grid-template-columns: 2fr 1fr;
        }
      }

      @media (max-width: 1000px) {
        .dash-content {
          grid-template-columns: 1fr;
        }
      }

      /* === SALA DE ESPERA === */
      .espera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .espera-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        position: relative;
        border-left: 6px solid var(--muted);
        display: flex;
        flex-direction: column;
        gap: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
      }

      .espera-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
      }

      .ec-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .ec-time {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -1px;
        line-height: 1;
      }

      .ec-status-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 4px;
        background: var(--bg-input);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
      }

      /* TEMPO DE ESPERA VISUAL */
      .tempo-espera {
        font-size: 0.85rem;
        font-weight: 700;
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        margin-top: 8px;
        animation: pulse 2s ease-in-out infinite;
      }

      .tempo-ok {
        background: #10b981;
        color: white;
      }

      .tempo-alerta {
        background: #f59e0b;
        color: white;
      }

      .tempo-critico {
        background: #ef4444;
        color: white;
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.7;
        }
      }

      .ec-body h3 {
        font-size: 1.2rem;
        color: white;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
      }

      .ec-prof {
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .ec-room {
        font-size: 0.85rem;
        color: var(--primary);
        font-weight: 600;
      }

      /* BORDAS DE STATUS */
      .border-agendado {
        border-left-color: var(--muted);
      }

      .border-confirmado {
        border-left-color: var(--info);
      }

      .border-espera {
        border-left-color: var(--warning);
      }

      .border-atendimento {
        border-left-color: #ec4899;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.3);
      }

      .border-finalizado {
        border-left-color: var(--primary);
      }

      .border-cancelado {
        border-left-color: var(--danger);
        opacity: 0.6;
      }

      /* TIMELINE */
      .timeline-container {
        margin-top: 1.5rem;
      }

      .timeline-header {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .timeline-grid {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 0;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }

      .timeline-hour {
        background: var(--bg-input);
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }

      .timeline-slot {
        background: var(--bg-card);
        padding: 10px;
        border-bottom: 1px solid var(--border);
        min-height: 60px;
        position: relative;
      }

      .timeline-event {
        background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid #047857;
      }

      .timeline-event:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
      }

      .timeline-event-name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .timeline-event-prof {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 2px;
      }

      .timeline-empty {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: italic;
      }

      /* BUSCA */
      .search-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
      }

      .search-input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        background: var(--bg-input);
        border: 2px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 0.95rem;
        transition: all 0.3s;
      }

      .search-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }

      .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }

      .search-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
      }

      .search-result-item:hover {
        background: var(--bg-input);
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .search-highlight {
        background: var(--primary);
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      th {
        padding: 12px;
        background: var(--bg-input);
        color: var(--muted);
        text-align: left;
        font-size: 0.85rem;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }

      input,
      select,
      textarea {
        background: var(--bg-input);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 6px;
        color: white;
        width: 100%;
        outline: none;
        margin-bottom: 10px;
      }

      label {
        display: block;
        color: var(--muted);
        font-size: 0.8rem;
        margin-bottom: 4px;
      }

      nav button {
        width: 100%;
        padding: 12px;
        background: transparent;
        border: none;
        color: var(--muted);
        text-align: left;
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 5px;
        font-weight: 500;
        display: flex;
        gap: 10px;
      }

      nav button:hover,
      nav button.active {
        background: var(--primary);
        color: white;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 1.5rem;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        color: var(--muted);
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        color: var(--primary);
        border-color: var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: flex-start;
        z-index: 100;
        overflow-y: auto;
        padding: 2rem;
        backdrop-filter: blur(3px);
      }

      .modal {
        background: var(--bg-card);
        width: 100%;
        max-width: 700px;
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        position: relative;
      }

      .modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .col {
        flex: 1;
      }

      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #10b981;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 16px;
        position: fixed;
        z-index: 9999;
        /* <--- ALTERE PARA 9999 (Para ficar acima de tudo) */
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        font-weight: bold;
      }

      #toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }

        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }

        to {
          bottom: 0;
          opacity: 0;
        }
      }

      .wa-icon {
        width: 24px;
        height: 24px;
        fill: #25d366;
        vertical-align: middle;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .wa-icon:hover {
        transform: scale(1.2);
      }

      .rel-summary {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .rel-card {
        flex: 1;
        background: var(--bg-input);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .rel-card h3 {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .rel-card h1 {
        font-size: 1.5rem;
        color: white;
      }

      #print-receita {
        display: none;
      }

      #print-frame {
        position: fixed;
        height: 0;
        width: 0;
        border: none;
        visibility: hidden;
      }
    </style>
  </head>

  <body>
    <div id="login-screen">
      <div class="login-box">
        <h2>üè• Cl√≠nicaSys</h2>
        <form onsubmit="event.preventDefault(); doLogin();">
          <input
            type="text"
            id="login-user"
            placeholder="Usu√°rio (admin)"
            required
          />
          <input
            type="password"
            id="login-pass"
            placeholder="Senha (admin123)"
            required
          />
          <button type="submit" id="btn-entrar">Entrar</button>
        </form>
      </div>
    </div>

    <div id="app-screen" style="display: none">
      <aside class="no-print">
        <div style="margin-bottom: 2rem; padding-left: 10px">
          <h2 style="color: var(--primary)">üè• Cl√≠nicaSys</h2>
          <small
            style="
              color: var(--muted);
              font-size: 0.75rem;
              display: block;
              margin-top: 5px;
            "
          >
            Licenciado para:<br /><strong id="header-title" style="color: white"
              >Minha Cl√≠nica</strong
            >
          </small>
        </div>
        <nav>
          <button class="active" onclick="nav('dashboard', this)">
            üìä <span>Dashboard</span>
          </button>
          <button onclick="nav('espera', this)">
            ‚è≥ <span>Sala de Espera</span>
          </button>
          <button onclick="nav('pacientes', this)">
            üë• <span>Pacientes</span>
          </button>
          <button onclick="nav('profissionais', this)">
            üë®‚Äç‚öïÔ∏è <span>Profissionais</span>
          </button>
          <button onclick="nav('agenda', this)">üìÖ <span>Agenda</span></button>
          <button onclick="nav('atendimento', this)">
            ü©∫ <span>Atendimento</span>
          </button>
          <button onclick="nav('financeiro', this)">
            üí∞ <span>Financeiro</span>
          </button>
          <button onclick="nav('relatorios', this)">
            üìà <span>Relat√≥rios</span>
          </button>
          <button onclick="nav('cadastros', this)">
            ‚öôÔ∏è <span>Cadastros</span>
          </button>
        </nav>
        <div
          style="
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
          "
        >
          <button
            class="btn btn-s"
            style="
              width: 100%;
              margin-bottom: 5px;
              background: #059669;
              border: 1px solid #047857;
            "
            onclick="abrirJanelaTV()"
          >
            üñ•Ô∏è <span>Abrir Tela TV</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="abrirModalTV()"
          >
            üì° <span>Conectar Smart TV</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="abrirModalConta()"
          >
            üë§ <span>Minha Conta</span>
          </button>
          <button
            class="btn btn-s"
            style="width: 100%; margin-bottom: 5px"
            onclick="window.open(API+'/backup')"
          >
            üíæ <span>Backup</span>
          </button>
          <button class="btn btn-d" style="width: 100%" onclick="doLogout()">
            <span>Sair</span>
          </button>
        </div>
      </aside>

      <main id="app">
        <div id="v-dashboard" class="view">
          <div class="grid">
            <div class="card">
              <h3>Hoje</h3>
              <h1 id="d-hoje">0</h1>
            </div>
            <div class="card">
              <h3>M√™s</h3>
              <h1 id="d-mes">0</h1>
            </div>
            <div class="card">
              <h3>Faturamento</h3>
              <h1 style="color: var(--primary)" id="d-fat">R$ 0</h1>
            </div>
            <div class="card">
              <h3>Pend√™ncias</h3>
              <h1 style="color: var(--danger)" id="d-pend">0</h1>
            </div>
          </div>

          <div class="dash-top-row">
            <div class="card dash-widget">
              <div id="calendar" style="font-size: 0.85rem"></div>
            </div>
            <div class="card dash-widget">
              <canvas id="chart"></canvas>
            </div>
          </div>

          <div class="card">
            <div class="dash-grid-toolbar">
              <div class="dash-grid-title">
                üìÖ Agenda de:
                <span id="dash-date-display" style="color: white">Hoje</span>
              </div>

              <select
                id="dash-filter-prof"
                onchange="loadDashGrid(); if(calendar) calendar.refetchEvents()"
                style="width: 180px; margin: 0"
              >
                <option value="">Todos Profissionais</option>
              </select>
              <select
                id="dash-filter-status"
                onchange="loadDashGrid()"
                style="width: 150px; margin: 0"
              >
                <option value="">Todos Status</option>
                <option value="Agendado">Agendado</option>
                <option value="Confirmado">Confirmado</option>
                <option value="Finalizado">Finalizado</option>
              </select>
              <button class="btn btn-p" onclick="modAgDash()">
                + Novo Agendamento
              </button>
            </div>

            <table class="full-grid">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Paciente</th>
                  <th>Profissional</th>
                  <th>Status</th>
                  <th>Info</th>
                  <th style="text-align: right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="dash-grid-body">
                <tr>
                  <td
                    colspan="6"
                    style="
                      text-align: center;
                      padding: 20px;
                      color: var(--muted);
                    "
                  >
                    Selecione uma data no calend√°rio...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="v-espera" class="view" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
              flex-wrap: wrap;
              gap: 10px;
            "
          >
            <h2>‚è≥ Sala de Espera (Hoje)</h2>
            <div style="display: flex; gap: 10px">
              <button class="btn btn-i" onclick="toggleTimeline()">
                üìä Timeline
              </button>
              <button class="btn btn-p" onclick="loadEspera()">
                üîÑ Atualizar
              </button>
            </div>
          </div>

          <div id="timeline-view" class="card" style="display: none">
            <div class="timeline-header">
              <h3>üìÖ Timeline do Dia</h3>
              <select
                id="timeline-prof-filter"
                onchange="loadTimeline()"
                style="width: 200px; margin-bottom: 0"
              >
                <option value="">Todos Profissionais</option>
              </select>
            </div>
            <div id="timeline-content" class="timeline-grid"></div>
          </div>

          <div id="espera-lista" class="espera-grid"></div>
        </div>

        <div id="v-pacientes" class="view" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 10px;
              "
            >
              <div class="search-wrapper" style="flex: 1; max-width: 400px">
                <input
                  type="text"
                  id="search-pac"
                  class="search-input"
                  placeholder="üîç Buscar por nome, CPF ou telefone..."
                  onkeyup="searchPacientes(this.value)"
                />
                <span class="search-icon" style="top: 12px; right: 15px"
                  >üîç</span
                >
                <div
                  id="search-results"
                  class="search-results"
                  style="display: none"
                ></div>
              </div>

              <button class="btn btn-p" onclick="modPac()">
                + Novo Paciente
              </button>
            </div>

            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr>
                  <th style="padding-left: 20px">Paciente</th>
                  <th>Documentos</th>
                  <th>Contato</th>
                  <th>Status</th>
                  <th style="text-align: right; padding-right: 20px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="t-pac"></tbody>
            </table>
          </div>
        </div>
        <div id="v-profissionais" class="view" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 10px;
              "
            >
              <div class="search-wrapper" style="flex: 1; max-width: 400px">
                <input
                  type="text"
                  id="search-prof"
                  class="search-input"
                  placeholder="üîç Buscar por nome, CRM ou especialidade..."
                  onkeyup="loadProf(this.value)"
                />
                <span class="search-icon" style="top: 12px; right: 15px"
                  >üîç</span
                >
              </div>

              <button class="btn btn-p" onclick="modProf()">+ Novo</button>
            </div>

            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr>
                  <th style="padding-left: 20px">Profissional</th>
                  <th>Especialidade / CRM</th>
                  <th>Contato</th>
                  <th>Status</th>
                  <th style="text-align: right; padding-right: 20px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="t-prof"></tbody>
            </table>
          </div>
        </div>
        <div id="v-agenda" class="view" style="display: none">
          <div class="card">
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: flex-end;
                flex-wrap: wrap;
                margin-bottom: 15px;
              "
            >
              <div>
                <label>De:</label
                ><input
                  type="date"
                  id="ag-ini"
                  style="width: auto"
                  onchange="loadAgenda()"
                />
              </div>
              <div>
                <label>At√©:</label
                ><input
                  type="date"
                  id="ag-fim"
                  style="width: auto"
                  onchange="loadAgenda()"
                />
              </div>
              <div>
                <label>Profissional:</label
                ><select
                  id="ag-filter-prof"
                  style="width: auto"
                  onchange="loadAgenda()"
                >
                  <option value="">Todos</option>
                </select>
              </div>
              <button
                class="btn btn-i"
                style="margin-bottom: 10px"
                onclick="toggleAgendaView()"
              >
                üìä Alternar Visualiza√ß√£o
              </button>
              <button
                class="btn btn-p"
                style="margin-left: auto; margin-bottom: 10px"
                onclick="modAg()"
              >
                + Agendar
              </button>
            </div>

            <div
              id="agenda-timeline"
              style="display: none"
              class="timeline-container"
            >
              <div id="agenda-timeline-content"></div>
            </div>

            <div id="agenda-table">
              <table>
                <thead>
                  <tr>
                    <th>Data / Hora</th>
                    <th>Paciente</th>
                    <th>Profissional</th>
                    <th>Status</th>
                    <th width="100">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="t-ag"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-atendimento" class="view" style="display: none">
          <div id="atend-sel-area" style="animation: fadein 0.5s">
            <div class="med-stats-row">
              <div
                class="med-stat-card"
                onclick="setFiltroRapido('todos')"
                style="cursor: pointer"
              >
                <div class="med-icon" style="color: #3b82f6">üìÖ</div>
                <div>
                  <h2 id="mc-total">0</h2>
                  <small>Total no Per√≠odo</small>
                </div>
              </div>
              <div
                class="med-stat-card"
                onclick="setFiltroRapido('espera')"
                style="cursor: pointer"
              >
                <div class="med-icon" style="color: #f59e0b">‚è≥</div>
                <div>
                  <h2 id="mc-espera">0</h2>
                  <small>Aguardando</small>
                </div>
              </div>
              <div
                class="med-stat-card"
                onclick="setFiltroRapido('finalizados')"
                style="cursor: pointer"
              >
                <div class="med-icon" style="color: #10b981">‚úÖ</div>
                <div>
                  <h2 id="mc-atendidos">0</h2>
                  <small>Finalizados</small>
                </div>
              </div>
            </div>

            <div class="card" style="padding: 15px; margin-bottom: 20px">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 10px;
                "
              >
                <h2
                  style="
                    color: var(--primary);
                    margin: 0;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                  "
                >
                  ü©∫ Painel de Atendimentos
                </h2>
                <button class="btn btn-s" onclick="exportarListaAtendimentos()">
                  üì• Excel
                </button>
              </div>

              <div
                style="
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
                  align-items: flex-end;
                  background: var(--bg-input);
                  padding: 10px;
                  border-radius: 8px;
                "
              >
                <div style="flex: 1; min-width: 200px">
                  <label>Buscar Paciente</label>
                  <input
                    id="mc-busca"
                    placeholder="üîç Nome, CPF..."
                    onkeyup="filtrarCockpit()"
                    style="margin: 0"
                  />
                </div>
                <div>
                  <label>De:</label>
                  <input
                    type="date"
                    id="mc-ini"
                    onchange="loadCockpit()"
                    style="margin: 0; width: 135px"
                  />
                </div>
                <div>
                  <label>At√©:</label>
                  <input
                    type="date"
                    id="mc-fim"
                    onchange="loadCockpit()"
                    style="margin: 0; width: 135px"
                  />
                </div>
                <div style="min-width: 150px">
                  <label>M√©dico</label>
                  <select
                    id="mc-filtro-prof"
                    onchange="loadCockpit()"
                    style="margin: 0"
                  >
                    <option value="">Todos</option>
                  </select>
                </div>
                <div style="min-width: 140px">
                  <label>Status</label>
                  <select
                    id="mc-filtro-st"
                    onchange="loadCockpit()"
                    style="margin: 0"
                  >
                    <option value="todos" selected>Todos</option>
                    <option value="espera">Aguardando</option>
                    <option value="finalizados">Finalizados</option>
                  </select>
                </div>
                <button
                  class="btn btn-p"
                  onclick="loadCockpit()"
                  title="Atualizar Lista"
                >
                  üîÑ
                </button>
              </div>
            </div>
            <div id="mc-lista">
              <p style="text-align: center; padding: 40px; color: #666">
                Carregando agenda...
              </p>
            </div>
          </div>

          <div id="atend-main" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <button class="btn btn-s" onclick="closeAtend()">
                ‚¨Ö Voltar ao Painel
              </button>
              <h2
                id="atend-pac-name"
                style="color: var(--primary); margin: 0"
              ></h2>
            </div>

            <div
              class="card"
              style="background: #374151; border-left: 5px solid #ef4444"
            >
              <div class="row">
                <div class="col">
                  <label style="color: #ef4444; font-weight: bold"
                    >‚ö† ALERGIAS</label
                  >
                  <input
                    id="at-alergias"
                    placeholder="Nenhuma alergia registrada"
                    style="background: #1f2937; border: 1px solid #ef4444"
                  />
                </div>
                <div class="col">
                  <label style="color: #f59e0b; font-weight: bold"
                    >üíä USO CONT√çNUO</label
                  >
                  <input
                    id="at-meds-uso"
                    readonly
                    style="background: #1f2937; color: #ccc; border: none"
                  />
                </div>
              </div>
            </div>

            <div
              class="card"
              style="background: linear-gradient(to right, #1f2937, #111827)"
            >
              <h4
                style="
                  color: var(--muted);
                  margin-bottom: 10px;
                  text-transform: uppercase;
                  font-size: 0.8rem;
                "
              >
                Sinais Vitais do Dia
              </h4>
              <div class="row">
                <div class="col">
                  <label>Peso (kg)</label
                  ><input
                    type="number"
                    id="at-peso"
                    step="0.1"
                    placeholder="0.0"
                  />
                </div>
                <div class="col">
                  <label>Altura (m)</label
                  ><input
                    type="number"
                    id="at-altura"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>
                <div class="col">
                  <label>PA (mmHg)</label
                  ><input
                    type="text"
                    id="at-pa"
                    placeholder="120x80"
                    class="mask-pa"
                  />
                </div>
                <div class="col">
                  <label>Temp (¬∞C)</label
                  ><input
                    type="number"
                    id="at-temp"
                    step="0.1"
                    placeholder="36.5"
                  />
                </div>
                <div class="col">
                  <label>Sat O2 (%)</label
                  ><input type="number" id="at-sat" placeholder="98" />
                </div>
              </div>
            </div>
            <div class="row" style="margin-top: 20px">
              <div class="col" style="flex: 1"></div>

              <div
                class="col"
                style="
                  width: 320px;
                  flex: none;
                  display: flex;
                  flex-direction: column;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 5px;
                  "
                >
                  <label style="color: var(--primary); font-weight: bold"
                    >üßç Mapa Corporal</label
                  >
                  <button
                    class="btn btn-s"
                    onclick="limparMapaCorporal()"
                    style="font-size: 0.7rem"
                  >
                    üóëÔ∏è Limpar
                  </button>
                </div>

                <div
                  id="body-map-container"
                  style="
                    position: relative;
                    width: 300px;
                    height: 400px;
                    background: #000 url('https://i.imgur.com/3q1S95V.png')
                      no-repeat center center;
                    background-size: contain;
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    cursor: crosshair;
                    overflow: hidden;
                  "
                  onclick="adicionarPontoMapa(event)"
                ></div>
                <small
                  style="
                    color: var(--muted);
                    text-align: center;
                    margin-top: 5px;
                  "
                  >Clique no corpo para adicionar observa√ß√£o</small
                >
              </div>
            </div>

            <div class="dash-content" style="grid-template-columns: 1fr 280px">
              <div class="card">
                <div
                  class="row"
                  style="align-items: center; margin-bottom: 5px"
                >
                  <label style="flex: 1">üìù Evolu√ß√£o Cl√≠nica</label>
                  <button class="btn-modelo" onclick="abrirModelos('evolucao')">
                    üìÇ Modelo
                  </button>
                </div>
                <div style="margin-bottom: 15px">
                  <label style="color: var(--primary); font-weight: bold"
                    >Queixa Principal (QP)</label
                  >
                  <input
                    id="at-qp"
                    placeholder="Ex: Dor de cabe√ßa h√° 3 dias..."
                    style="border-left: 4px solid var(--primary)"
                  />
                </div>

                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 10px;
                  "
                >
                  <div>
                    <div
                      class="row"
                      style="align-items: center; margin-bottom: 5px"
                    >
                      <label style="font-weight: bold; color: #3b82f6"
                        >S - Subjetivo</label
                      >
                      <button
                        class="btn-modelo"
                        onclick="abrirModelos('subjetivo')"
                      >
                        üìÇ
                      </button>
                    </div>
                    <textarea
                      id="at-s"
                      rows="4"
                      placeholder="O que o paciente relata..."
                      style="border-left: 4px solid #3b82f6"
                    ></textarea>
                  </div>
                  <div>
                    <div
                      class="row"
                      style="align-items: center; margin-bottom: 5px"
                    >
                      <label style="font-weight: bold; color: #ef4444"
                        >O - Objetivo</label
                      >
                      <button
                        class="btn-modelo"
                        onclick="abrirModelos('objetivo')"
                      >
                        üìÇ
                      </button>
                    </div>
                    <textarea
                      id="at-o"
                      rows="4"
                      placeholder="Exame f√≠sico, sinais vitais..."
                      style="border-left: 4px solid #ef4444"
                    ></textarea>
                  </div>
                  <div>
                    <div
                      class="row"
                      style="align-items: center; margin-bottom: 5px"
                    >
                      <label style="font-weight: bold; color: #f59e0b"
                        >A - Avalia√ß√£o</label
                      >
                      <button
                        class="btn-modelo"
                        onclick="abrirModelos('avaliacao')"
                      >
                        üìÇ
                      </button>
                    </div>
                    <textarea
                      id="at-a"
                      rows="3"
                      placeholder="Hip√≥teses diagn√≥sticas..."
                      style="border-left: 4px solid #f59e0b"
                    ></textarea>
                  </div>
                  <div>
                    <div
                      class="row"
                      style="align-items: center; margin-bottom: 5px"
                    >
                      <label style="font-weight: bold; color: #10b981"
                        >P - Plano</label
                      >
                      <button
                        class="btn-modelo"
                        onclick="abrirModelos('plano')"
                      >
                        üìÇ
                      </button>
                    </div>
                    <textarea
                      id="at-p"
                      rows="3"
                      placeholder="Tratamento, exames, orienta√ß√µes..."
                      style="border-left: 4px solid #10b981"
                    ></textarea>
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Diagn√≥stico (CID)</label
                    ><input id="atend-cid" placeholder="Busque o c√≥digo..." />
                  </div>
                  <div class="col">
                    <label>Conduta</label
                    ><select id="at-conduta">
                      <option value="">Selecione...</option>
                      <option>Alta</option>
                      <option>Retorno</option>
                      <option>Encaminhamento</option>
                    </select>
                  </div>
                  <div class="col">
                    <label>Retorno</label
                    ><input id="at-retorno" placeholder="Ex: 30 dias" />
                  </div>
                </div>

                <div
                  class="row"
                  style="
                    align-items: center;
                    margin-bottom: 5px;
                    margin-top: 15px;
                  "
                >
                  <label style="flex: 1">üíä Prescri√ß√£o M√©dica</label>
                  <button class="btn-modelo" onclick="abrirModelos('receita')">
                    üìÇ Modelo
                  </button>
                </div>
                <textarea id="at-pres" rows="5"></textarea>

                <div
                  class="row"
                  style="
                    align-items: center;
                    margin-bottom: 5px;
                    margin-top: 15px;
                  "
                >
                  <label style="flex: 1">üî¨ Pedido de Exames</label>
                  <button class="btn-modelo" onclick="abrirModelos('exame')">
                    üìÇ Modelo
                  </button>
                </div>
                <textarea id="at-exm" rows="4"></textarea>

                <div
                  style="
                    margin-top: 20px;
                    border-top: 1px solid var(--border);
                    padding-top: 10px;
                  "
                >
                  <label>üìé Fotos e Anexos</label>
                  <input
                    type="file"
                    id="file-upload"
                    style="display: none"
                    multiple
                    onchange="handleFiles(this.files)"
                  />
                  <div
                    class="anexo-box"
                    onclick="document.getElementById('file-upload').click()"
                    ondrop="dropHandler(event)"
                    ondragover="dragOverHandler(event)"
                  >
                    Clique ou Arraste arquivos aqui
                  </div>
                  <div id="lista-anexos" class="thumb-lista"></div>
                </div>

                <div
                  style="
                    text-align: right;
                    border-top: 1px solid var(--border);
                    padding-top: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 20px;
                  "
                >
                  <select id="atend-pac-sel" style="display: none"></select>
                  <select id="at-prof" style="width: auto; margin: 0"></select>
                  <div>
                    <button class="btn btn-s" onclick="imprimirReceita()">
                      üñ®Ô∏è Imprimir
                    </button>
                    <button
                      class="btn btn-p"
                      onclick="saveAtend()"
                      style="padding: 10px 30px; font-size: 1rem"
                    >
                      üíæ SALVAR CONSULTA
                    </button>
                  </div>
                </div>
              </div>

              <div class="card" style="max-height: 800px; overflow-y: auto">
                <h3
                  style="
                    position: sticky;
                    top: 0;
                    background: var(--bg-card);
                    padding-bottom: 10px;
                    border-bottom: 1px solid var(--border);
                    z-index: 5;
                  "
                >
                  üìú Hist√≥rico
                </h3>
                <div
                  id="at-hist"
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    margin-top: 10px;
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div id="v-financeiro" class="view" style="display: none">
          <div class="grid" style="margin-bottom: 20px">
            <div class="card" style="border-left: 4px solid #10b981">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Concretizado (Pago)
              </h4>
              <h2 style="color: #10b981" id="fin-total-pago">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #f59e0b">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Pendente (Aberto)
              </h4>
              <h2 style="color: #f59e0b" id="fin-total-pendente">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #ef4444">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Vencido (Atrasado)
              </h4>
              <h2 style="color: #ef4444" id="fin-total-vencido">R$ 0,00</h2>
            </div>
            <div class="card" style="border-left: 4px solid #3b82f6">
              <h4 style="color: var(--muted); font-size: 0.8rem">
                Balan√ßo Previsto
              </h4>
              <h2 style="color: #3b82f6" id="fin-total-geral">R$ 0,00</h2>
            </div>
          </div>

          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--border);
                padding-bottom: 15px;
              "
            >
              <div class="tabs" style="border: none; margin: 0">
                <div
                  class="tab active"
                  onclick="tabFin('receber', this)"
                  style="font-weight: 600"
                >
                  ‚¨áÔ∏è A Receber
                </div>
                <div
                  class="tab"
                  onclick="tabFin('pagar', this)"
                  style="font-weight: 600"
                >
                  ‚¨ÜÔ∏è A Pagar
                </div>
                <div
                  class="tab"
                  onclick="tabFin('caixa', this)"
                  style="font-weight: 600"
                >
                  üèß Livro Caixa
                </div>
              </div>

              <div style="display: flex; gap: 10px; align-items: center">
                <select
                  id="fin-mes"
                  onchange="loadFin()"
                  style="width: 140px; margin: 0"
                >
                  <option value="1">Janeiro</option>
                  <option value="2">Fevereiro</option>
                  <option value="3">Mar√ßo</option>
                  <option value="4">Abril</option>
                  <option value="5">Maio</option>
                  <option value="6">Junho</option>
                  <option value="7">Julho</option>
                  <option value="8">Agosto</option>
                  <option value="9">Setembro</option>
                  <option value="10">Outubro</option>
                  <option value="11">Novembro</option>
                  <option value="12">Dezembro</option>
                </select>
                <select
                  id="fin-ano"
                  onchange="loadFin()"
                  style="width: 100px; margin: 0"
                >
                  <option value="2024">2024</option>
                  <option value="2025" selected>2025</option>
                  <option value="2026">2026</option>
                </select>
                <button class="btn btn-p" onclick="modFin()">
                  + Novo Lan√ßamento
                </button>
              </div>
            </div>

            <div style="overflow-x: auto">
              <table id="t-fin-table" style="min-width: 800px">
                <thead id="t-fin-head"></thead>
                <tbody id="t-fin"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-relatorios" class="view" style="display: none">
          <div class="card">
            <div
              class="no-print"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--border);
                padding-bottom: 15px;
              "
            >
              <h2 style="margin: 0">üìä Central de Relat√≥rios</h2>
              <div style="display: flex; gap: 10px; align-items: center">
                <select id="rel-tipo" style="margin: 0; width: 180px">
                  <option value="agendamentos">Agendamentos</option>
                  <option value="financeiro">Financeiro Detalhado</option>
                  <option value="profissionais">Produtividade M√©dica</option>
                  <option value="repasse">üí∞ Repasse M√©dico</option>
                  <option value="fechamento">üîí Fechamento de Caixa</option>
                  <option value="convenios">Utiliza√ß√£o Conv√™nios</option>
                  <option value="pacientes">Base de Pacientes</option>
                  <option value="aniversariantes">Aniversariantes</option>
                </select>
                <input
                  type="date"
                  id="rel-ini"
                  style="margin: 0; width: 140px"
                />
                <span style="color: var(--muted)">at√©</span>
                <input
                  type="date"
                  id="rel-fim"
                  style="margin: 0; width: 140px"
                />

                <button class="btn btn-p" onclick="gerarRel()">üîç Gerar</button>
                <button class="btn btn-s" onclick="imprimirRelatorio()">
                  üñ®Ô∏è
                </button>
                <button class="btn btn-s" onclick="exportarCSV()">
                  üì• Excel
                </button>
              </div>
            </div>

            <div
              id="rel-header-print"
              style="display: none; text-align: center; margin-bottom: 20px"
            >
              <h2 id="print-title">Relat√≥rio</h2>
              <p id="print-period"></p>
              <hr />
            </div>

            <div
              id="rel-kpi-area"
              class="grid"
              style="
                margin-bottom: 20px;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
              "
            ></div>

            <div
              id="rel-chart-container"
              style="height: 300px; margin-bottom: 30px; display: none"
            >
              <canvas id="rel-chart"></canvas>
            </div>

            <div id="printable-area">
              <table id="rel-tab" style="width: 100%; font-size: 0.9rem">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="v-cadastros" class="view" style="display: none">
          <div class="card">
            <div class="tabs">
              <div class="tab active" onclick="loadAux('especialidades', this)">
                Especialidades
              </div>
              <div class="tab" onclick="loadAux('convenios', this)">
                Conv√™nios
              </div>
              <div class="tab" onclick="loadAux('salas', this)">Salas</div>
              <div class="tab" onclick="loadAux('procedimentos', this)">
                Procedimentos
              </div>
            </div>
            <div
              id="aux-simple-ctrl"
              style="display: flex; gap: 10px; flex-wrap: wrap"
            >
              <input
                type="text"
                id="aux-nome"
                placeholder="Novo item..."
                style="flex: 1; min-width: 200px"
              />
              <button class="btn btn-p" onclick="salvAux()">Adicionar</button>

              <button
                class="btn btn-i"
                style="background: #8b5cf6"
                onclick="abrirMatrizPrecos()"
              >
                üí∞ Matriz de Pre√ßos (Excel)
              </button>
            </div>
            <div id="aux-conv-ctrl" style="display: none; margin-bottom: 10px">
              <button class="btn btn-p" onclick="modConv()">
                + Novo Conv√™nio
              </button>
            </div>
            <table>
              <tbody id="t-aux"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div id="m-wifi-tv" class="overlay">
      <div class="modal" style="text-align: center; max-width: 450px">
        <div class="modal-head">
          <h2>üì° Conectar TV Wi-Fi</h2>
          <button class="btn btn-d" onclick="closeM('m-wifi-tv')">X</button>
        </div>
        <p style="color: var(--muted); margin-bottom: 15px">
          Para usar a TV sem cabos, certifique-se que ela est√° no mesmo Wi-Fi
          deste computador.
        </p>
        <div
          style="
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
          "
        >
          <p style="font-size: 0.9rem; color: var(--muted)">
            Abra o navegador da TV e digite:
          </p>
          <h2
            id="tv-url-display"
            style="
              color: var(--primary);
              font-size: 1.8rem;
              margin: 10px 0;
              letter-spacing: 1px;
            "
          >
            Carregando...
          </h2>
        </div>
        <div
          style="
            background: white;
            padding: 10px;
            display: inline-block;
            border-radius: 8px;
          "
        >
          <img
            id="tv-qr"
            src=""
            alt="QR Code"
            width="200"
            height="200"
            style="display: none"
          />
        </div>
      </div>
    </div>

    <div id="m-conta" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>üë§ Minha Conta</h2>
          <button class="btn btn-d" onclick="closeM('m-conta')">X</button>
        </div>

        <div class="tabs" style="margin-top: 10px">
          <div class="tab active" onclick="subTab(this,'c-dados')">
            Dados da Cl√≠nica
          </div>
          <div class="tab" onclick="subTab(this,'c-senha')">Seguran√ßa</div>
          <div class="tab" onclick="subTab(this,'c-users'); loadUsers()">
            Usu√°rios
          </div>
        </div>

        <div id="c-dados" class="tab-content active">
          <label>Nome da Cl√≠nica</label><input id="conf-nome" />
          <label>CNPJ</label><input id="conf-cnpj" /> <label>Endere√ßo</label
          ><input id="conf-end" /> <label>Telefone</label
          ><input id="conf-tel" class="mask-tel" />
          <label>Mensagem do Rodap√© da TV</label>
          <textarea
            id="conf-msg-tv"
            rows="2"
            placeholder="Ex: Bem-vindo! Mantenha o sil√™ncio..."
          ></textarea>
          <button
            class="btn btn-p"
            style="width: 100%; margin-top: 10px"
            onclick="salvarConfig()"
          >
            Salvar Dados
          </button>
        </div>

        <div id="c-senha" class="tab-content">
          <label>Senha Antiga</label
          ><input
            type="password"
            id="senha-antiga"
            placeholder="Sua senha atual"
          />
          <label>Nova Senha</label
          ><input type="password" id="senha-nova" placeholder="Nova senha" />
          <label>Confirmar Nova Senha</label
          ><input
            type="password"
            id="senha-confirma"
            placeholder="Repita a nova senha"
          />
          <button
            class="btn btn-p"
            style="width: 100%; margin-top: 10px"
            onclick="salvarNovaSenha()"
          >
            Alterar Senha
          </button>
        </div>

        <div id="c-users" class="tab-content">
          <div
            style="
              background: #111827;
              padding: 15px;
              border: 1px solid #374151;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          >
            <p style="color: #f59e0b; font-weight: bold; font-size: 0.9rem">
              üîó ACESSO EM REDE
            </p>
            <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 5px">
              Para acessar o sistema em outro computador, permane√ßa com ele
              rodando aqui e no outro computador acesse:
            </p>
            <h3
              id="link-rede-display"
              style="color: #10b981; user-select: text"
            >
              Carregando...
            </h3>
            <small style="color: #6b7280"
              >CUIDADO PRA N√ÉO QUEBRAR O SISTEMA: N√£o feche a janela preta neste
              computador principal.</small
            >
          </div>

          <div
            style="
              background: var(--bg-input);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
            "
          >
            <h4 style="margin-bottom: 10px; color: var(--primary)">
              Novo Usu√°rio
            </h4>
            <p style="color: #f59e0b; font-size: 0.8rem; margin-bottom: 10px">
              ‚ö† OBS: Ao criar usu√°rio que n√£o seja admin, escolha abaixo as
              telas que ele pode ter acesso.
            </p>

            <div
              style="
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
              "
            >
              <input
                id="u-new-user"
                placeholder="Login (ex: recepcionista)"
                style="margin: 0; flex: 1"
              />
              <input
                id="u-new-pass"
                type="password"
                placeholder="Senha"
                style="margin: 0; flex: 1"
              />
              <select id="u-new-role" style="margin: 0; width: 120px">
                <option value="user">Comum</option>
                <option value="admin">Admin</option>
              </select>
            </div>

            <div
              style="
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid var(--border);
                border-radius: 6px;
              "
            >
              <label style="color: white; margin-bottom: 5px"
                >Liberar Telas:</label
              >
              <div style="display: flex; gap: 15px; flex-wrap: wrap">
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="agenda"
                    checked
                  />
                  Agenda
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="pacientes"
                    checked
                  />
                  Pacientes
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="financeiro"
                  />
                  Financeiro
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="relatorios"
                  />
                  Relat√≥rios
                </label>
                <label
                  style="
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    color: #ddd;
                  "
                >
                  <input
                    type="checkbox"
                    class="perm-check"
                    value="profissionais"
                  />
                  Profissionais
                </label>
              </div>
            </div>

            <button class="btn btn-p" onclick="addUser()" style="width: 100%">
              + Criar Usu√°rio
            </button>
          </div>

          <table style="width: 100%">
            <thead>
              <tr>
                <th>Usu√°rio</th>
                <th>Tipo</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="lista-usuarios"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="m-fin" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Financeiro</h2>
          <button class="btn btn-d" onclick="closeM('m-fin')">X</button>
        </div>
        <label>Tipo</label
        ><select id="f-tipo" onchange="toggleFin()">
          <option value="receber">Receita</option>
          <option value="pagar">Despesa</option>
        </select>
        <div id="d-pac">
          <label>Paciente</label
          ><select id="f-pac"></select>
        </div>
        <div id="d-forn" style="display: none">
          <label>Fornecedor</label><input id="f-forn" />
        </div>
        <div class="row">
          <div class="col"><label>Desc</label><input id="f-desc" /></div>
          <div class="col">
            <label>Valor</label><input type="number" id="f-val" step="0.01" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Venc</label
            ><input type="date" id="f-venc" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Parc</label><input type="number" id="f-parc" value="1" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Categoria <span style="color: red">*</span></label
            ><input id="f-cat" />
          </div>
          <div class="col"><label>Centro Custo</label><input id="f-cc" /></div>
          <div class="col">
            <label>Forma</label
            ><select id="f-forma">
              <option>Dinheiro</option>
              <option>Pix</option>
              <option>Cart√£o</option>
            </select>
          </div>
        </div>
        <button class="btn btn-p" style="width: 100%" onclick="saveFin()">
          Salvar Lan√ßamento
        </button>
      </div>
    </div>
    <div id="m-transf" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Reagendar</h2>
          <button class="btn btn-d" onclick="closeM('m-transf')">X</button>
        </div>
        <input type="hidden" id="tr-id" /><input
          type="hidden"
          id="tr-pac-nome"
        /><input type="hidden" id="tr-pac-tel" /><label>Profissional</label
        ><select id="tr-prof"></select>
        <div class="row">
          <div class="col">
            <label>Data</label
            ><input type="date" id="tr-data" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Hora</label
            ><input type="time" id="tr-hora" style="color-scheme: dark" />
          </div>
        </div>
        <div style="text-align: right; margin-top: 10px">
          <button class="btn btn-p" onclick="confTransf()">Confirmar</button>
        </div>
      </div>
    </div>
    <div id="m-fim" class="overlay">
      <div class="modal" style="max-width: 500px">
        <div class="modal-head">
          <h2>üèÅ Finalizar Atendimento</h2>
          <button class="btn btn-d" onclick="closeM('m-fim')">X</button>
        </div>
        <input type="hidden" id="fim-id" />

        <input type="hidden" id="fim-pac-id" />
        <input type="hidden" id="fim-prof-id" />
        <div
          style="
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
          "
        >
          <h3 style="color: var(--primary); margin-bottom: 10px">
            üí∏ Checkout Financeiro
          </h3>

          <div class="row">
            <div class="col">
              <label>Valor Final (R$)</label>
              <input
                type="number"
                id="fim-valor"
                step="0.01"
                style="font-weight: bold; color: #10b981"
              />
            </div>
            <div class="col">
              <label>Status</label>
              <select id="fim-status-fin" onchange="togglePagamento()">
                <option value="Pago">‚úÖ Pago Agora</option>
                <option value="Pendente">‚è≥ Pendente / Conv√™nio</option>
              </select>
            </div>
          </div>

          <div class="row" id="fim-div-forma">
            <div class="col">
              <label>Forma de Pagamento</label>
              <select id="fim-forma">
                <option value="Dinheiro">üíµ Dinheiro</option>
                <option value="Pix">üí† Pix</option>
                <option value="Cart√£o Cr√©dito">üí≥ Cart√£o Cr√©dito</option>
                <option value="Cart√£o D√©bito">üí≥ Cart√£o D√©bito</option>
                <option value="Conv√™nio">üè• Conv√™nio</option>
              </select>
            </div>
          </div>
        </div>

        <label>
          <input type="checkbox" id="fim-retorno" onchange="toggleRetorno()" />
          Agendar Retorno?
        </label>

        <div
          id="fim-area-retorno"
          style="
            display: none;
            margin-top: 10px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
          "
        >
          <div class="row">
            <div class="col">
              <label>Data Retorno</label>
              <input type="date" id="fim-data" style="color-scheme: dark" />
            </div>
            <div class="col">
              <label>Hora</label>
              <input type="time" id="fim-hora" style="color-scheme: dark" />
            </div>
          </div>
        </div>

        <button
          class="btn btn-p"
          onclick="confFim()"
          style="width: 100%; margin-top: 20px; font-size: 1.1rem"
        >
          Confirmar e Baixar
        </button>
      </div>
    </div>
    <div id="m-hist-detalhe" class="overlay" style="z-index: 5000">
      <div
        class="modal"
        style="
          max-width: 900px;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          class="modal-head"
          style="
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 15px;
          "
        >
          <div>
            <h2 style="color: var(--primary)" id="h-data">27/11/2025</h2>
            <small style="color: var(--muted)" id="h-prof"
              >Dr. Fulano - CRM 12345</small
            >
          </div>
          <button class="btn btn-d" onclick="closeM('m-hist-detalhe')">
            X
          </button>
        </div>

        <div style="overflow-y: auto; padding-right: 5px">
          <div
            class="row"
            style="
              background: var(--bg-input);
              padding: 10px;
              border-radius: 6px;
              margin-bottom: 15px;
            "
          >
            <div class="col">
              <div class="label-read">Peso</div>
              <strong id="h-peso">--</strong> kg
            </div>
            <div class="col">
              <div class="label-read">Altura</div>
              <strong id="h-altura">--</strong> m
            </div>
            <div class="col">
              <div class="label-read">PA</div>
              <strong id="h-pa">--</strong>
            </div>
            <div class="col">
              <div class="label-read">Temp</div>
              <strong id="h-temp">--</strong> ¬∞C
            </div>
            <div class="col">
              <div class="label-read">Sat</div>
              <strong id="h-sat">--</strong> %
            </div>
          </div>

          <div style="margin-bottom: 15px">
            <div class="label-read" style="color: var(--primary)">
              Queixa Principal
            </div>
            <div
              id="h-qp"
              style="font-size: 1.1rem; font-weight: bold; margin-bottom: 10px"
            ></div>

            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div>
                <div class="label-read" style="color: #3b82f6">
                  S - Subjetivo
                </div>
                <div
                  id="h-s"
                  class="soap-box"
                  style="border-color: #3b82f6"
                ></div>
              </div>
              <div>
                <div class="label-read" style="color: #ef4444">
                  O - Objetivo
                </div>
                <div
                  id="h-o"
                  class="soap-box"
                  style="border-color: #ef4444"
                ></div>
              </div>
              <div>
                <div class="label-read" style="color: #f59e0b">
                  A - Avalia√ß√£o
                </div>
                <div
                  id="h-a"
                  class="soap-box"
                  style="border-color: #f59e0b"
                ></div>
              </div>
              <div>
                <div class="label-read" style="color: #10b981">P - Plano</div>
                <div
                  id="h-p"
                  class="soap-box"
                  style="border-color: #10b981"
                ></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div style="flex: 1">
              <div class="label-read">Prescri√ß√£o / Receita</div>
              <div
                id="h-pres"
                class="soap-box"
                style="min-height: 80px; font-family: monospace"
              ></div>

              <div class="label-read" style="margin-top: 10px">
                Exames Solicitados
              </div>
              <div
                id="h-exm"
                class="soap-box"
                style="min-height: 60px; font-family: monospace"
              ></div>
            </div>

            <div
              style="
                width: 300px;
                margin-left: 10px;
                border-left: 1px solid var(--border);
                padding-left: 10px;
              "
            >
              <div class="label-read">üìé Anexos / Fotos deste dia</div>
              <div id="h-anexos-list" class="thumb-lista"></div>
            </div>
          </div>

          <div
            style="
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px solid var(--border);
            "
          >
            <div
              id="area-retificacao"
              style="
                display: none;
                background: #331111;
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 10px;
                border: 1px solid #ef4444;
              "
            >
              <h4
                style="
                  color: #ef4444;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  margin-bottom: 5px;
                "
              >
                ‚öñÔ∏è Aten√ß√£o: Lei do Prontu√°rio (Lei 13.787/18)
              </h4>
              <p style="font-size: 0.85rem; color: #ffcccc; margin: 0 0 10px 0">
                Pela legisla√ß√£o vigente, prontu√°rios devem ser guardados por
                <strong>20 anos</strong>. √â proibido excluir registros
                originais. Caso haja erro, fa√ßa uma
                <strong>Retifica√ß√£o</strong> abaixo.
              </p>

              <textarea
                id="txt-retificacao"
                rows="3"
                placeholder="Descreva o motivo da corre√ß√£o (Ex: Erro de digita√ß√£o na dosagem...)"
                style="
                  width: 100%;
                  background: #fff;
                  color: #000;
                  padding: 10px;
                  border-radius: 4px;
                  border: none;
                "
              ></textarea>

              <div style="text-align: right; margin-top: 10px">
                <button
                  class="btn btn-s"
                  onclick="el('area-retificacao').style.display='none'"
                >
                  Cancelar
                </button>
                <button
                  class="btn btn-d"
                  onclick="confirmarRetificacao()"
                  style="background: #ef4444; border: none"
                >
                  üíæ Gravar Retifica√ß√£o
                </button>
              </div>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <button
                class="btn btn-s"
                style="
                  color: #f59e0b;
                  border: 1px solid #f59e0b;
                  background: transparent;
                "
                onclick="el('area-retificacao').style.display='block'"
              >
                ‚ö†Ô∏è Retificar / Corrigir
              </button>

              <div style="text-align: right">
                <div
                  style="margin-bottom: 5px; font-size: 0.85rem; color: #aaa"
                >
                  <span>Conduta:</span>
                  <strong id="h-conduta" style="color: white">--</strong> |
                  <span>Retorno:</span>
                  <strong id="h-retorno" style="color: white">--</strong>
                </div>
                <button class="btn btn-p" id="btn-copiar-receita">
                  üìã Copiar Receita
                </button>
              </div>
            </div>

            <div
              id="h-lista-retificacoes"
              style="margin-top: 15px; white-space: pre-wrap; font-size: 0.9rem"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <div id="m-pac" class="overlay">
      <div
        class="modal"
        style="
          max-width: 800px;
          padding: 0;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          max-height: 90vh;
        "
      >
        <div
          class="modal-head"
          style="
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin: 0;
          "
        >
          <h2 style="margin: 0">üë§ Cadastro de Paciente</h2>
          <button class="btn btn-d" onclick="closeM('m-pac')">X</button>
        </div>

        <div style="padding: 25px; overflow-y: auto">
          <input type="hidden" id="p-id" />

          <div class="profile-header">
            <div
              class="profile-pic-area"
              onclick="document.getElementById('p-foto-upload').click()"
            >
              <img
                id="p-foto-preview"
                class="profile-pic"
                src=""
                onerror="this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png'"
              />
              <div class="profile-edit-badge">üì∑</div>
            </div>
            <div class="profile-info" style="flex: 1">
              <div class="modern-input">
                <label>Nome Completo do Paciente</label>
                <input
                  id="p-nome"
                  placeholder="Digite o nome completo..."
                  style="font-size: 1.1rem; font-weight: bold"
                />
              </div>
            </div>
            <input
              type="file"
              id="p-foto-upload"
              style="display: none"
              accept="image/*"
              onchange="uploadFotoPaciente()"
            />
            <input type="hidden" id="p-foto-path" />
          </div>

          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px">
            <div>
              <div class="form-section">
                <div class="section-title">üìÑ Documenta√ß√£o & Pessoal</div>
                <div class="input-grid cols-3">
                  <div class="modern-input">
                    <label>CPF</label>
                    <input
                      id="p-cpf"
                      class="mask-cpf"
                      placeholder="000.000.000-00"
                    />
                  </div>
                  <div class="modern-input">
                    <label>RG</label>
                    <input id="p-rg" placeholder="Numera√ß√£o" />
                  </div>
                  <div class="modern-input">
                    <label>Data Nasc.</label>
                    <input type="date" id="p-nasc" style="color-scheme: dark" />
                  </div>
                  <div class="modern-input">
                    <label>Sexo</label>
                    <select id="p-sexo">
                      <option value="M">Masculino</option>
                      <option value="F">Feminino</option>
                      <option value="O">Outro</option>
                    </select>
                  </div>
                  <div class="modern-input">
                    <label>Telefone / WhatsApp</label>
                    <input
                      id="p-tel1"
                      class="mask-tel"
                      placeholder="(00) 00000-0000"
                    />
                  </div>
                  <div class="modern-input">
                    <label>Email</label>
                    <input id="p-email" placeholder="email@exemplo.com" />
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="section-title">üë®‚Äçüë©‚Äçüë¶ Filia√ß√£o / Respons√°veis</div>
                <div class="input-grid cols-2">
                  <div class="modern-input">
                    <label>Nome da M√£e</label>
                    <input id="p-mae" />
                  </div>
                  <div class="modern-input">
                    <label>Tel. M√£e</label>
                    <input id="p-tel-mae" class="mask-tel" />
                  </div>
                  <div class="modern-input">
                    <label>Nome do Pai</label>
                    <input id="p-pai" />
                  </div>
                  <div class="modern-input">
                    <label>Tel. Pai</label>
                    <input id="p-tel-pai" class="mask-tel" />
                  </div>
                </div>
              </div>

              <div class="form-section">
                <div class="section-title">üìç Endere√ßo</div>
                <div class="modern-input">
                  <input
                    id="p-end"
                    placeholder="Rua, N√∫mero, Bairro, Cidade..."
                  />
                </div>
              </div>
            </div>

            <div>
              <div class="form-section">
                <div class="section-title">üè• Dados Cl√≠nicos</div>

                <div class="modern-input" style="margin-bottom: 10px">
                  <label>Conv√™nio</label>
                  <select id="p-conv" style="width: 100%"></select>
                </div>

                <div class="modern-input" style="margin-bottom: 10px">
                  <label>Medicamentos em Uso</label>
                  <input id="p-meds" placeholder="Separar por v√≠rgula" />
                </div>

                <div class="modern-input" style="margin-bottom: 10px">
                  <label>Observa√ß√µes / Alergias</label>
                  <textarea
                    id="p-obs"
                    rows="6"
                    placeholder="Anota√ß√µes importantes sobre o paciente..."
                  ></textarea>
                </div>

                <button
                  type="button"
                  class="btn btn-i"
                  onclick="verHistoricoPaciente(val('p-id'))"
                  style="width: 100%; margin-top: 10px"
                >
                  üìú Hist√≥rico
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          style="
            padding: 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            text-align: right;
          "
        >
          <button
            class="btn btn-p"
            style="padding: 12px 30px; font-size: 1rem"
            onclick="savePac()"
          >
            üíæ SALVAR CADASTRO
          </button>
        </div>
      </div>
    </div>
    <div id="m-prof" class="overlay">
      <div
        class="modal"
        style="
          max-width: 700px;
          padding: 0;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          max-height: 90vh;
        "
      >
        <div
          class="modal-head"
          style="
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin: 0;
          "
        >
          <h2 style="margin: 0">üë®‚Äç‚öïÔ∏è Cadastro de Profissional</h2>
          <button class="btn btn-d" onclick="closeM('m-prof')">X</button>
        </div>

        <input type="hidden" id="pr-id" />

        <div style="padding: 25px; overflow-y: auto">
          <div class="profile-header">
            <div
              class="profile-pic-area"
              onclick="document.getElementById('pr-foto-upload').click()"
            >
              <img
                id="pr-foto-preview"
                class="profile-pic"
                src=""
                onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'"
              />
              <div class="profile-edit-badge">üì∑</div>
            </div>
            <div class="profile-info" style="flex: 1">
              <div class="modern-input">
                <label>Nome Completo do Profissional</label>
                <input
                  id="pr-nome"
                  placeholder="Dr. Nome Sobrenome"
                  style="font-size: 1.1rem; font-weight: bold"
                />
              </div>
            </div>
            <input
              type="file"
              id="pr-foto-upload"
              style="display: none"
              accept="image/*"
              onchange="uploadFotoProfissional()"
            />
            <input type="hidden" id="pr-foto-path" />
          </div>

          <div
            class="tabs"
            style="margin-bottom: 20px; border-bottom: 1px solid var(--border)"
          >
            <div class="tab active" onclick="subTab(this,'pr-dados')">
              Dados Gerais
            </div>
            <div class="tab" onclick="subTab(this,'pr-end')">Endere√ßo</div>
            <div class="tab" onclick="subTab(this,'pr-fin')">Financeiro</div>
          </div>

          <div id="pr-dados" class="tab-content active">
            <div class="input-grid cols-2" style="margin-bottom: 15px">
              <div class="modern-input">
                <label>Especialidade</label>
                <select id="pr-esp"></select>
              </div>
              <div class="modern-input">
                <label>CRM / Registro</label>
                <input id="pr-crm" />
              </div>
            </div>

            <div class="input-grid cols-3" style="margin-bottom: 15px">
              <div class="modern-input">
                <label>CPF</label>
                <input id="pr-cpf" class="mask-cpf" />
              </div>
              <div class="modern-input">
                <label>Nascimento</label>
                <input type="date" id="pr-nasc" style="color-scheme: dark" />
              </div>
              <div class="modern-input">
                <label>Telefone</label>
                <input id="pr-tel" class="mask-tel" />
              </div>
            </div>

            <div class="modern-input" style="margin-bottom: 15px">
              <label>Email</label>
              <input id="pr-email" />
            </div>

            <div class="form-section" style="margin-top: 20px">
              <div class="section-title">‚öôÔ∏è Configura√ß√µes de Agenda</div>
              <div class="input-grid cols-2">
                <div class="modern-input">
                  <label>Valor da Consulta Padr√£o (R$)</label>
                  <input
                    type="number"
                    id="pr-valor"
                    step="0.01"
                    placeholder="0.00"
                    style="color: #10b981; font-weight: bold"
                  />
                </div>
                <div class="modern-input">
                  <label>Dias de Atendimento</label>
                  <input id="pr-dias" placeholder="Ex: Seg, Qua, Sex" />
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-title">‚úíÔ∏è Assinatura Digital</div>
              <div
                class="upload-area"
                onclick="document.getElementById('pr-assinatura-upload').click()"
              >
                <div style="font-size: 2rem; margin-bottom: 10px">üì§</div>
                <p style="margin: 0; color: white">
                  Clique para enviar imagem da assinatura
                </p>
                <small id="ass-status" style="color: var(--muted)"
                  >Fundo transparente recomendado (PNG)</small
                >
              </div>
              <input
                type="file"
                id="pr-assinatura-upload"
                onchange="uploadAssinatura()"
                style="display: none"
              />
              <input type="hidden" id="pr-assinatura-path" />
            </div>
          </div>

          <div id="pr-end" class="tab-content">
            <div class="modern-input" style="margin-bottom: 15px">
              <label>Logradouro (Rua, Av, etc)</label>
              <input id="pr-rua" />
            </div>
            <div class="input-grid cols-2">
              <div class="modern-input">
                <label>Bairro</label>
                <input id="pr-bairro" />
              </div>
              <div class="modern-input">
                <label>Cidade / UF</label>
                <input id="pr-cid" />
              </div>
            </div>
          </div>

          <div id="pr-fin" class="tab-content">
            <div class="form-section">
              <div class="section-title">üè¶ Dados Banc√°rios (Para Repasse)</div>
              <div class="input-grid cols-3">
                <div class="modern-input">
                  <label>Banco</label>
                  <input id="pr-banco" />
                </div>
                <div class="modern-input">
                  <label>Ag√™ncia</label>
                  <input id="pr-ag" />
                </div>
                <div class="modern-input">
                  <label>Conta Corrente</label>
                  <input id="pr-cc" />
                </div>
              </div>
              <div class="input-grid cols-2" style="margin-top: 15px">
                <div class="modern-input">
                  <label>Chave Pix</label>
                  <input id="pr-pix" />
                </div>
                <div class="modern-input">
                  <label>Comiss√£o (%)</label>
                  <input type="number" id="pr-comissao" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          style="
            padding: 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            text-align: right;
          "
        >
          <button
            class="btn btn-p"
            style="width: 100%; padding: 12px; font-size: 1.1rem"
            onclick="saveProf()"
          >
            Salvar Profissional
          </button>
        </div>
      </div>
    </div>
    <div id="m-conv" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Conv√™nio</h2>
          <button class="btn btn-d" onclick="closeM('m-conv')">X</button>
        </div>
        <input type="hidden" id="cv-id" />
        <div class="row">
          <div class="col"><label>Nome</label><input id="cv-nome" /></div>
          <div class="col"><label>ANS</label><input id="cv-ans" /></div>
        </div>
        <div class="row">
          <div class="col"><label>CNPJ</label><input id="cv-cnpj" /></div>
          <div class="col">
            <label>Prazo</label><input type="number" id="cv-prazo" />
          </div>
        </div>
        <div class="row">
          <div class="col"><label>Email</label><input id="cv-email" /></div>
          <div class="col"><label>Site</label><input id="cv-site" /></div>
        </div>
        <div
          style="
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border);
            border-radius: 6px;
          "
        >
          <label>üìé Anexar Tabela de Pre√ßos (PDF/Excel)</label>
          <div style="display: flex; gap: 10px; align-items: center">
            <input
              type="file"
              id="cv-arquivo-upload"
              style="margin: 0"
              onchange="uploadTabelaConvenio()"
            />
            <input type="hidden" id="cv-arquivo-path" />
            <button
              id="btn-ver-tabela"
              class="btn btn-s"
              style="display: none"
              onclick="verTabelaConvenio()"
            >
              üëÅÔ∏è Ver
            </button>
          </div>
          <small id="cv-status-upload" style="color: var(--muted)"
            >Nenhum arquivo selecionado</small
          >
        </div>
        <button class="btn btn-p" style="width: 100%" onclick="saveConv()">
          Salvar
        </button>
      </div>
    </div>
    <div id="m-ag" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>Agendar</h2>
          <button class="btn btn-d" onclick="closeM('m-ag')">X</button>
        </div>
        <label>Paciente</label
        ><select id="a-pac"></select
        ><label>Profissional</label
        ><select id="a-prof"></select>
        <div class="row">
          <div class="col">
            <label>Valor R$</label>
            <input type="number" id="a-valor" step="0.01" />
          </div>
          <div class="col">
            <label>Data</label
            ><input type="date" id="a-data" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Hora</label
            ><input type="time" id="a-hora" style="color-scheme: dark" />
          </div>
          <div class="col">
            <label>Dur</label><input type="number" id="a-dur" value="30" />
          </div>
        </div>
        <label>Sala</label
        ><select id="a-sala"></select
        ><button class="btn btn-p" style="width: 100%" onclick="saveAg()">
          Agendar
        </button>
      </div>
    </div>
    <div id="m-baixa" class="overlay">
      <div class="modal" style="width: 400px">
        <div class="modal-head">
          <h2>Baixar</h2>
          <button class="btn btn-d" onclick="closeM('m-baixa')">X</button>
        </div>
        <input type="hidden" id="b-id" /><label>Valor Pago</label
        ><input type="number" id="b-val" step="0.01" /><button
          class="btn btn-p"
          style="width: 100%; margin-top: 10px"
          onclick="confBaixa()"
        >
          Confirmar
        </button>
      </div>
    </div>
    <div id="m-dia" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2 id="dia-titulo"></h2>
          <button class="btn btn-d" onclick="closeM('m-dia')">X</button>
        </div>
        <div id="dia-lista"></div>
        <div style="margin-top: 20px; text-align: right">
          <button class="btn btn-p" onclick="modAgDia()">+ Novo</button>
        </div>
      </div>
    </div>
    <div id="m-leitura" class="overlay" style="z-index: 3000">
      <div
        class="modal"
        style="
          padding: 0;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          max-height: 85vh;
        "
      >
        <div
          id="conteudo-leitura"
          style="
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
          "
        ></div>
      </div>
    </div>
    <div id="m-modelos" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>üìÇ Modelos de Texto</h2>
          <button class="btn btn-d" onclick="closeM('m-modelos')">X</button>
        </div>
        <input type="hidden" id="mod-tipo-atual" />
        <div style="display: flex; gap: 10px; margin-bottom: 15px">
          <select
            id="lista-modelos-salvos"
            style="flex: 1"
            onchange="carregarConteudoModelo()"
          ></select>
          <button class="btn btn-d" onclick="deletarModelo()">üóëÔ∏è</button>
        </div>
        <label>Nome do Modelo</label
        ><input id="novo-modelo-nome" placeholder="Ex: P√≥s-operat√≥rio" />
        <label>Conte√∫do</label
        ><textarea id="novo-modelo-conteudo" rows="10"></textarea>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
          "
        >
          <button class="btn btn-p" onclick="salvarModelo()">üíæ Salvar</button>
          <button class="btn btn-i" onclick="usarModelo()">‚úÖ USAR ESTE</button>
        </div>
      </div>
    </div>
    <div id="m-proc-detalhe" class="overlay">
      <div class="modal">
        <div class="modal-head">
          <h2>üõ†Ô∏è Configurar Procedimento</h2>
          <button class="btn btn-d" onclick="closeM('m-proc-detalhe')">
            X
          </button>
        </div>
        <input type="hidden" id="px-id" />

        <div class="row">
          <div class="col">
            <label>Nome do Procedimento</label><input id="px-nome" />
          </div>
          <div class="col">
            <label>C√≥d. TUSS/Interno</label><input id="px-codigo" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Tempo Padr√£o (min)</label
            ><input type="number" id="px-tempo" value="30" />
          </div>
          <div class="col">
            <label>Valor Particular (R$)</label
            ><input type="number" id="px-valor" step="0.01" />
          </div>
          <div class="col">
            <label>Repasse M√©dico (R$)</label
            ><input type="number" id="px-repasse" step="0.01" />
          </div>
        </div>

        <div
          style="
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
          "
        >
          <h4 style="color: var(--info); margin-bottom: 10px">
            üè• Pre√ßos por Conv√™nio
          </h4>
          <div
            style="
              max-height: 250px;
              overflow-y: auto;
              background: var(--bg-input);
              padding: 10px;
              border-radius: 6px;
            "
          >
            <table style="margin: 0">
              <thead>
                <tr>
                  <th>Conv√™nio</th>
                  <th width="150">Valor (R$)</th>
                </tr>
              </thead>
              <tbody id="px-lista-precos"></tbody>
            </table>
          </div>
        </div>

        <button
          class="btn btn-p"
          style="width: 100%; margin-top: 15px; padding: 12px"
          onclick="saveProcCompleto()"
        >
          üíæ SALVAR TUDO
        </button>
      </div>
    </div>
    <div id="m-matriz" class="overlay">
      <div
        class="modal"
        style="
          max-width: 95%;
          height: 90vh;
          display: flex;
          flex-direction: column;
          padding: 0;
        "
      >
        <div
          class="modal-head"
          style="
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin: 0;
          "
        >
          <div>
            <h2 style="margin: 0; color: var(--primary)">
              üí∞ Gerenciador de Tabelas
            </h2>
            <small style="color: var(--muted)"
              >Edite os valores como em uma planilha. As altera√ß√µes ficam
              laranja at√© salvar.</small
            >
          </div>
          <div>
            <button class="btn btn-p" onclick="salvarMatriz()">
              üíæ SALVAR ALTERA√á√ïES
            </button>
            <button class="btn btn-d" onclick="closeM('m-matriz')">X</button>
          </div>
        </div>

        <div
          style="
            flex: 1;
            overflow: auto;
            background: #111827;
            position: relative;
          "
        >
          <table
            style="width: 100%; border-collapse: separate; border-spacing: 0"
          >
            <thead
              id="matriz-head"
              style="position: sticky; top: 0; z-index: 10"
            ></thead>
            <tbody id="matriz-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="toast">Notifica√ß√£o</div>
    <div id="print-receita"></div>

    <script>
      let janelaTV = null;
      const API = "/api";
      let curFin = "receber",
        curAux = "especialidades",
        calendar = null,
        curChart = null,
        refreshTimer = null,
        currentAgId = null,
        clinicConfig = {};
      let timelineVisible = false,
        agendaTimelineVisible = false;
      const ICON_WA =
        '<svg class="wa-icon" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>';
      const el = (id) => document.getElementById(id),
        val = (id) => (el(id) ? el(id).value : "");
      const req = async (u, m = "GET", d = null, s = false) => {
        try {
          const o = {
            method: m,
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include", // üî• FOR√áA ENVIO DE COOKIES
            cache: "no-cache",
          };
          if (d) o.body = JSON.stringify(d);

          const r = await fetch(API + u, o);

          // Se der 401 e n√£o for a rota de login
          if (
            r.status === 401 &&
            !s &&
            !u.includes("/login") &&
            !u.includes("/check_auth")
          ) {
            console.warn("‚ö†Ô∏è Sess√£o expirou na requisi√ß√£o:", u);

            // Tenta verificar auth
            const authCheck = await fetch(API + "/check_auth", {
              method: "GET",
              credentials: "include",
              cache: "no-cache",
            });

            if (!authCheck.ok) {
              console.error("‚ùå Sess√£o realmente expirou, recarregando...");
              location.reload();
              return null;
            }
          }

          if (r.status === 401 && !s) return null;
          return await r.json();
        } catch (e) {
          if (!s) {
            console.error("Erro na requisi√ß√£o:", e);
            showToast("Erro: " + e, "erro");
          }
          return null;
        }
      };
      function showToast(m, t = "s") {
        const x = el("toast");
        x.innerText = m;
        x.style.backgroundColor = t === "erro" ? "#EF4444" : "#10B981";
        x.className = "show";
        setTimeout(() => (x.className = ""), 3000);
      }
      function mascaraCPF(i) {
        let v = i.value
          .replace(/\D/g, "")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        i.value = v;
      }
      function mascaraTel(i) {
        let v = i.value
          .replace(/\D/g, "")
          .replace(/^(\d{2})(\d)/, "($1) $2")
          .replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
      }
      document.addEventListener("input", (e) => {
        if (e.target.classList.contains("mask-cpf")) mascaraCPF(e.target);
        if (e.target.classList.contains("mask-tel")) mascaraTel(e.target);
      });

      document.addEventListener("input", (e) => {
        if (e.target.classList.contains("mask-cpf")) mascaraCPF(e.target);
        if (e.target.classList.contains("mask-tel")) mascaraTel(e.target);
      });

      // --- COLE AQUI O C√ìDIGO NOVO ---
      if (el("a-prof")) {
        el("a-prof").addEventListener("change", function () {
          const opt = this.options[this.selectedIndex];
          // Verifica se tem op√ß√£o selecionada e se tem valor no dataset
          if (opt && opt.dataset.valor) {
            // Preenche o campo de valor (se ele existir)
            if (el("a-valor")) el("a-valor").value = opt.dataset.valor;
          }
        });
      }

      const fill = async (id, u, labelTodos = null) => {
        const l = await req(u);
        if (el(id)) {
          const optionsHtml = (l || [])
            .map(
              (i) =>
                `<option value="${i.id}" data-tel="${
                  i.telefone_principal || ""
                }" data-valor="${i.valor_padrao || 0}">${i.nome}</option>`
            )
            .join("");

          // Se passar um texto para labelTodos, adiciona ele como primeira op√ß√£o
          if (labelTodos) {
            el(id).innerHTML =
              `<option value="">${labelTodos}</option>` + optionsHtml;
          } else {
            el(id).innerHTML = optionsHtml;
          }
        }
      };

      function calcularTempoEspera(dataHoraInicio, status) {
        if (status === "Cancelado" || status === "Finalizado") return null;
        const inicio = new Date(dataHoraInicio.replace(" ", "T"));
        const agora = new Date();
        const minutos = Math.floor((agora - inicio) / 60000);
        if (minutos < 0) return null;
        let classe = "tempo-ok",
          icone = "‚è±Ô∏è";
        if (minutos > 30) {
          classe = "tempo-alerta";
          icone = "‚ö†Ô∏è";
        }
        if (minutos > 60) {
          classe = "tempo-critico";
          icone = "üö®";
        }
        return { minutos, classe, icone };
      }
      function formatarTempo(minutos) {
        if (minutos < 60) return `${minutos}min`;
        const horas = Math.floor(minutos / 60);
        const mins = minutos % 60;
        return `${horas}h ${mins}min`;
      }

      let tvWindow = null;

      function abrirJanelaTV() {
        if (tvWindow == null || tvWindow.closed) {
          // Abre SOMENTE UMA VEZ
          tvWindow = window.open("/tv", "JanelaTV", "width=1000,height=700");
        } else {
          // S√≥ foca na janela existente
          tvWindow.focus();
        }
      }
      async function inativarPac(id) {
        if (
          confirm(
            "Tem certeza? O sistema verificar√° se √© poss√≠vel excluir ou se deve apenas arquivar."
          )
        ) {
          const res = await req("/pacientes/deletar/" + id, "DELETE");
          if (res) {
            if (res.msg) showToast(res.msg); // Mostra "Arquivado" ou "Exclu√≠do"
            if (res.erro) alert(res.erro);
            loadPac("");
          }
        }
      }

      async function abrirModalTV() {
        el("m-wifi-tv").style.display = "flex";
        let ip = clinicConfig.ip_rede || "http://localhost:5000";
        if (ip.endsWith("/")) ip = ip.slice(0, -1);
        const urlTV = `${ip}/tv`;
        el("tv-url-display").innerText = urlTV.replace("http://", "");
        const qrImg = el("tv-qr");
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
          urlTV
        )}`;
        qrImg.style.display = "inline-block";
      }

      async function chamarPaciente(id, nome) {
        showToast(`üì¢ Chamando ${nome} no painel...`);

        // Chama a rota espec√≠fica que atualiza o carimbo de tempo
        await req("/agenda/chamar_painel", "POST", { id: id });

        loadEspera(); // Atualiza a tela local
      }

      let searchTimeout;
      async function searchPacientes(termo) {
        clearTimeout(searchTimeout);
        const results = el("search-results");
        if (termo.length < 2) {
          results.style.display = "none";
          loadPac("");
          return;
        }
        searchTimeout = setTimeout(async () => {
          const lista = await req("/pacientes?filtro=" + termo);
          if (!lista || lista.length === 0) {
            results.innerHTML =
              '<div style="padding:15px; text-align:center; color:var(--muted)">Nenhum resultado</div>';
            results.style.display = "block";
            el("t-pac").innerHTML =
              '<tr><td colspan="5" style="text-align:center; color:var(--muted)">Nenhum paciente encontrado</td></tr>';
            return;
          }
          results.innerHTML = lista
            .slice(0, 5)
            .map((p) => {
              const nomeHighlight = p.nome.replace(
                new RegExp(termo, "gi"),
                (match) => `<span class="search-highlight">${match}</span>`
              );
              // CORRE√á√ÉO AQUI:
              return `<div class="search-result-item" onclick='editPac(${escapeDados(
                p
              )})'><strong>${nomeHighlight}</strong><br><small style="color:var(--muted)">CPF: ${
                p.cpf || "N/A"
              } | Tel: ${p.telefone_principal || "N/A"}</small></div>`;
            })
            .join("");
          results.style.display = "block";
          loadPac(termo);
        }, 300);
      }
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-wrapper")) {
          el("search-results").style.display = "none";
        }
      });

      function toggleTimeline() {
        timelineVisible = !timelineVisible;
        el("timeline-view").style.display = timelineVisible ? "block" : "none";
        el("espera-lista").style.display = timelineVisible ? "none" : "grid";
        if (timelineVisible) {
          fill("timeline-prof-filter", "/profissionais");
          loadTimeline();
        }
      }
      function toggleAgendaView() {
        agendaTimelineVisible = !agendaTimelineVisible;
        el("agenda-timeline").style.display = agendaTimelineVisible
          ? "block"
          : "none";
        el("agenda-table").style.display = agendaTimelineVisible
          ? "none"
          : "block";
        if (agendaTimelineVisible) loadAgendaTimeline();
      }

      async function loadTimeline() {
        const profId = val("timeline-prof-filter");
        const lista = await req(
          "/sala_espera" + (profId ? "?prof_id=" + profId : "")
        );
        const horas = {};
        for (let h = 7; h <= 20; h++) {
          horas[h] = [];
        }
        (lista || []).forEach((a) => {
          const hora = parseInt(a.data_hora_inicio.substring(11, 13));
          if (horas[hora]) horas[hora].push(a);
        });
        el("timeline-content").innerHTML = Object.keys(horas)
          .map((h) => {
            const eventos = horas[h];
            return `<div class="timeline-hour">${h}:00</div><div class="timeline-slot">${
              eventos.length
                ? eventos
                    .map(
                      (e) =>
                        `<div class="timeline-event" onclick="verDetalhesAgendamento(${
                          e.id
                        })"><div class="timeline-event-name">${
                          e.paciente_nome
                        }</div><div class="timeline-event-prof">üë®‚Äç‚öïÔ∏è ${
                          e.profissional_nome
                        } | ${e.data_hora_inicio.substring(11, 16)}</div></div>`
                    )
                    .join("")
                : '<div class="timeline-empty">Hor√°rio livre</div>'
            }</div>`;
          })
          .join("");
      }

      async function loadAgendaTimeline() {
        const i = val("ag-ini"),
          f = val("ag-fim"),
          p = val("ag-filter-prof");
        const lista = await req(`/agenda?inicio=${i}&fim=${f}&prof_id=${p}`);
        const horas = {};
        for (let h = 7; h <= 20; h++) {
          horas[h] = [];
        }
        (lista || []).forEach((a) => {
          const hora = parseInt(a.data_hora_inicio.substring(11, 13));
          if (horas[hora]) horas[hora].push(a);
        });
        el("agenda-timeline-content").innerHTML =
          `<div class="timeline-grid">` +
          Object.keys(horas)
            .map((h) => {
              const eventos = horas[h];
              return `<div class="timeline-hour">${h}:00</div><div class="timeline-slot">${
                eventos.length
                  ? eventos
                      .map(
                        (e) =>
                          // CORRE√á√ÉO AQUI:
                          `<div class="timeline-event" onclick='editAg(${escapeDados(
                            e
                          )})'><div class="timeline-event-name">${
                            e.paciente
                          }</div><div class="timeline-event-prof">üë®‚Äç‚öïÔ∏è ${
                            e.profissional
                          } | ${e.data_hora_inicio.substring(11, 16)} | ${
                            e.status
                          }</div></div>`
                      )
                      .join("")
                  : '<div class="timeline-empty">Hor√°rio livre</div>'
              }</div>`;
            })
            .join("") +
          `</div>`;
      }

      function verDetalhesAgendamento(id) {
        showToast("Clique em A√ß√µes no card para gerenciar", "s");
      }

      async function checkAuth() {
        // Adicionei parametro true para evitar loop infinito
        const u = await req("/check_auth", "GET", null, true);
        if (u && u.user) {
          el("login-screen").style.display = "none";
          el("app-screen").style.display = "flex";
          await loadConfig();

          // --- NOVO: Aplica as permiss√µes vindas do backend ---
          aplicarPermissoes(u.perms, u.role);

          // --- NOVO: Mostra o link de rede no modal ---
          if (clinicConfig && clinicConfig.ip_rede) {
            el("link-rede-display").innerText = clinicConfig.ip_rede;
          } else {
            // Fallback caso config ainda n√£o tenha carregado 100%
            req("/config").then((c) => {
              if (c && c.ip_rede) el("link-rede-display").innerText = c.ip_rede;
            });
          }
          // ----------------------------------------------------

          nav("dashboard", document.querySelector("nav button"));
        } else {
          el("login-screen").style.display = "flex";
          el("app-screen").style.display = "none";
        }
      }
      async function doLogin() {
        const btn = el("btn-entrar");
        btn.innerText = "Entrando...";
        btn.disabled = true;

        const res = await req(
          "/login",
          "POST",
          { username: val("login-user"), password: val("login-pass") },
          true
        );

        if (res && res.msg === "Logado") {
          console.log("‚úÖ Login bem-sucedido!");

          // üî• FOR√áA O NAVEGADOR A SALVAR O COOKIE
          document.cookie =
            "clinicasys_logged=true; max-age=31536000; path=/; SameSite=Lax";

          // Aguarda 500ms para garantir que o cookie foi salvo
          await new Promise((resolve) => setTimeout(resolve, 500));

          // Verifica se realmente est√° autenticado
          const authCheck = await req("/check_auth", "GET", null, true);
          if (authCheck && authCheck.user) {
            console.log("‚úÖ Sess√£o verificada:", authCheck.user);
            checkAuth();
          } else {
            alert(
              "Erro: Login realizado mas sess√£o n√£o foi criada. Tente novamente."
            );
            btn.innerText = "Entrar";
            btn.disabled = false;
          }
        } else {
          alert(
            "Erro: " +
              (res && res.erro ? res.erro : "Usu√°rio ou senha incorretos")
          );
          btn.innerText = "Entrar";
          btn.disabled = false;
        }
      }
      async function doLogout() {
        await req("/logout", "POST");
        location.reload();
      }
      async function loadConfig() {
        clinicConfig = await req("/config");
        if (clinicConfig.nome_clinica)
          el("header-title").innerText = clinicConfig.nome_clinica;
      }
      function abrirModalConta() {
        el("m-conta").style.display = "flex";
        if (clinicConfig) {
          el("conf-nome").value = clinicConfig.nome_clinica || "";
          el("conf-cnpj").value = clinicConfig.cnpj || "";
          el("conf-end").value = clinicConfig.endereco || "";
          el("conf-tel").value = clinicConfig.telefone || "";
          // Carrega a mensagem
          el("conf-msg-tv").value = clinicConfig.mensagem_tv || "";
        }
      }

      async function salvarConfig() {
        if (
          await req("/config/salvar", "POST", {
            nome: val("conf-nome"),
            cnpj: val("conf-cnpj"),
            end: val("conf-end"),
            tel: val("conf-tel"),
            // ADICIONE ESTA LINHA ABAIXO:
            msg_tv: val("conf-msg-tv"),
          })
        ) {
          showToast("Salvo! A TV atualizar√° em breve.");
          loadConfig();
          closeM("m-conta");
        }
      }

      async function salvarNovaSenha() {
        if (val("senha-nova") != val("senha-confirma"))
          return showToast("Senhas diferem", "erro");
        if (
          await req("/mudar_senha", "POST", {
            antiga: val("senha-antiga"),
            nova: val("senha-nova"),
          })
        ) {
          showToast("Senha alterada!");
          closeM("m-conta");
        }
      }

      function nav(v, btn) {
        // Esconde todas as views
        document
          .querySelectorAll(".view")
          .forEach((x) => (x.style.display = "none"));

        // Mostra a view selecionada
        if (el("v-" + v)) el("v-" + v).style.display = "block";

        // Atualiza menu
        document
          .querySelectorAll("nav button")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");

        // Limpa timer anterior se houver
        if (refreshTimer) {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }

        // L√≥gicas espec√≠ficas de cada tela
        if (v == "dashboard") {
          loadDash();
          setTimeout(initCalendar, 100);
        }

        if (v == "espera") {
          loadEspera();
          refreshTimer = setInterval(loadEspera, 15000);
        }

        if (v == "pacientes") loadPac("");
        if (v == "profissionais") loadProf();
        if (v == "cadastros")
          loadAux(
            "especialidades",
            document.querySelector("#v-cadastros .tab")
          );

        if (v == "agenda") {
          const h = new Date().toISOString().split("T")[0];
          if (!val("ag-ini")) el("ag-ini").value = h;
          if (!val("ag-fim")) el("ag-fim").value = h;
          loadAgenda();
        }

        if (v == "atendimento") {
          const h = new Date().toISOString().split("T")[0];
          if (!val("mc-ini")) el("mc-ini").value = h;
          if (!val("mc-fim")) el("mc-fim").value = h;

          loadCockpit();
          refreshTimer = setInterval(loadCockpit, 10000);
        }

        if (v == "financeiro")
          tabFin("receber", document.querySelector("#v-financeiro .tab"));

        if (v == "relatorios") {
          el("rel-ini").valueAsDate = new Date();
          el("rel-fim").valueAsDate = new Date();
        }
      }
      function closeM(id) {
        el(id).style.display = "none";
      }
      function subTab(btn, cid) {
        const m = btn.closest(".modal") || btn.closest(".card");
        m.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        btn.classList.add("active");
        m.querySelectorAll(".tab-content").forEach((c) =>
          c.classList.remove("active")
        );
        el(cid).classList.add("active");
      }

      const _hoje = new Date();
      const _localIso = new Date(
        _hoje.getTime() - _hoje.getTimezoneOffset() * 60000
      )
        .toISOString()
        .split("T")[0];
      let selectedDashDate = _localIso;

      // 1. Atualize a fun√ß√£o loadDash (Dashboard Principal)
      async function loadDash() {
        const d = await req("/dashboard_stats");
        if (d) {
          el("d-hoje").innerText = d.hoje;
          el("d-mes").innerText = d.mes;
          el("d-fat").innerText = "R$ " + d.faturamento;
          el("d-pend").innerText = d.pendencias;

          // Atualiza Gr√°fico
          const ctx = el("chart");
          if (curChart) {
            curChart.destroy();
            curChart = null;
          }
          if (ctx && d.grafico) {
            curChart = new Chart(ctx, {
              type: "doughnut", // Mudei para doughnut para variar, fica bonito ao lado do calendario
              data: {
                labels: d.grafico.map((i) => i.nome),
                datasets: [
                  {
                    data: d.grafico.map((i) => i.total),
                    backgroundColor: [
                      "#10B981",
                      "#3B82F6",
                      "#F59E0B",
                      "#EC4899",
                      "#8B5CF6",
                    ],
                  },
                ],
              },
              options: { maintainAspectRatio: false }, // Importante para caber na div
            });
          }
        }

        // Carrega o filtro de profissionais na grid
        fill("dash-filter-prof", "/profissionais", "Todos Profissionais");

        // Carrega a grid de hoje
        loadDashGrid();
      }

      // 2. Atualize o Calend√°rio para N√ÉO abrir modal, e sim atualizar a grid
      function initCalendar() {
        if (calendar) return;
        calendar = new FullCalendar.Calendar(el("calendar"), {
          initialView: "dayGridMonth",
          locale: "pt-br",
          height: "100%",
          headerToolbar: {
            left: "prev,next",
            center: "title",
            right: "today",
          },
          // Busca os contadores (Ex: "3 agend.")
          events: async (info, successCallback) => {
            // Pega o valor do filtro atual
            const profId = val("dash-filter-prof");
            // Envia para o backend
            const dados = await req("/agenda/resumo_qtd?prof_id=" + profId);
            successCallback(dados || []);
          },
          // Clique no dia vazio
          dateClick: (info) => {
            selecionarDiaDash(info.dateStr, info.dayEl);
          },
          // Clique na bolinha do contador
          eventClick: (info) => {
            // CORRE√á√ÉO: Garante que pegamos s√≥ a data YYYY-MM-DD, sem hora
            let dataEvento = info.event.startStr;
            if (dataEvento.includes("T")) dataEvento = dataEvento.split("T")[0];

            selecionarDiaDash(dataEvento, null);
          },
        });
        calendar.render();
      }

      // Fun√ß√£o auxiliar para pintar o dia selecionado e carregar a grid
      function selecionarDiaDash(dataIso, elementoHtml) {
        selectedDashDate = dataIso;

        // Limpa sele√ß√£o visual anterior
        document
          .querySelectorAll(".fc-daygrid-day")
          .forEach((el) => (el.style.backgroundColor = ""));

        // Pinta o novo dia (se tivermos o elemento direto)
        if (elementoHtml) {
          elementoHtml.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
        } else {
          // Se veio do clique no evento, buscamos o dia pelo atributo data-date
          const diaEl = document.querySelector(
            `.fc-daygrid-day[data-date='${dataIso}']`
          );
          if (diaEl) diaEl.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
        }

        // Carrega a tabela detalhada l√° embaixo
        loadDashGrid();
      }

      // 3. NOVA FUN√á√ÉO: Carrega a Grid Completa
      async function loadDashGrid() {
        const dataDisplay = selectedDashDate.split("-").reverse().join("/");
        el("dash-date-display").innerText = dataDisplay;

        el("dash-grid-body").innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:20px;">Carregando...</td></tr>';

        const profId = val("dash-filter-prof");

        // Busca tudo do dia
        const lista = await req(
          `/agenda?inicio=${selectedDashDate}&fim=${selectedDashDate}&prof_id=${profId}`
        );

        // Filtro do Dropdown de Status
        const statusFilter = val("dash-filter-status");

        // CORRE√á√ÉO: Por padr√£o, esconde os cancelados para bater com o n√∫mero do calend√°rio
        // Se o usu√°rio quiser ver cancelados, ele teria que filtrar especificamente (ou removemos da grid padr√£o)
        let listaFiltrada = lista || [];

        if (statusFilter) {
          listaFiltrada = listaFiltrada.filter(
            (a) => a.status === statusFilter
          );
        } else {
          // Se n√£o tem filtro selecionado, mostra S√ì OS ATIVOS (para bater com o calend√°rio)
          listaFiltrada = listaFiltrada.filter((a) => a.status !== "Cancelado");
        }

        if (listaFiltrada.length === 0) {
          el("dash-grid-body").innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--muted)">Nenhum agendamento ativo para este dia.</td></tr>';
          return;
        }

        el("dash-grid-body").innerHTML = listaFiltrada
          .map((a) => {
            // Cores dos status
            let badgeClass = "st-agendado";
            if (a.status === "Confirmado") badgeClass = "st-confirmado";
            if (a.status === "Finalizado") badgeClass = "st-finalizado";
            if (a.status === "Em Atendimento") badgeClass = "st-atendimento";
            if (a.status === "Cancelado") badgeClass = "st-cancelado"; // Caso filtre manualmente

            return `
        <tr style="transition:0.2s; cursor:pointer; border-left: 4px solid ${getCorStatus(
          a.status
        )}">
            <td style="font-weight:bold; font-size:1.1rem">${a.data_hora_inicio.substring(
              11,
              16
            )}</td>
            <td>
                <div style="font-weight:bold">${a.paciente}</div>
            </td>
            <td>${a.profissional}</td>
            <td><span class="status-badge ${badgeClass}">${a.status}</span></td>
            <td style="font-size:0.85rem; color:var(--muted)">
                ${a.sala_nome ? "üö™ " + a.sala_nome : ""} <br>
                ${a.tipo ? "üè∑Ô∏è " + a.tipo : ""}
            </td>
            <td>
                <div class="grid-actions">
                    <button class="btn btn-s" title="Editar/Ver" onclick='editAg(${escapeDados(
                      a
                    )})'>üëÅÔ∏è</button>
                    <button class="btn btn-i" title="Reagendar" onclick='dashReagendar(${escapeDados(
                      a
                    )})'>üîÑ</button>
                    <button class="btn btn-d" title="Cancelar" onclick="delAg(${
                      a.id
                    })">‚ùå</button>
                </div>
            </td>
        </tr>`;
          })
          .join("");
      }

      // Fun√ß√£o Auxiliar para cor da borda
      function getCorStatus(s) {
        if (s === "Confirmado") return "#3B82F6";
        if (s === "Finalizado") return "#10B981";
        if (s === "Cancelado") return "#EF4444";
        return "transparent";
      }

      // Atalho para criar agendamento j√° na data selecionada
      function modAgDash() {
        modAg();
        el("a-data").value = selectedDashDate;
      }

      // Atalho para Reagendar vindo da Dashboard
      function dashReagendar(a) {
        // Precisamos buscar telefone se n√£o vier no objeto 'a'
        // Mas vamos abrir o modal com o que temos
        openTransf(a.id, a.profissional_id, a.data_hora_inicio, a.paciente, "");
      }
      async function loadDashGrid() {
        const dataDisplay = selectedDashDate.split("-").reverse().join("/");
        el("dash-date-display").innerText = dataDisplay;

        el("dash-grid-body").innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:20px;">Carregando...</td></tr>';

        const profId = val("dash-filter-prof");
        // Reutilizamos a rota de agenda que j√° filtra por data e profissional
        const lista = await req(
          `/agenda?inicio=${selectedDashDate}&fim=${selectedDashDate}&prof_id=${profId}`
        );

        // Filtro de Status no Front-end (pra ser r√°pido)
        const statusFilter = val("dash-filter-status");
        const listaFiltrada = statusFilter
          ? lista.filter((a) => a.status === statusFilter)
          : lista;

        if (!listaFiltrada || listaFiltrada.length === 0) {
          el("dash-grid-body").innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--muted)">Nenhum agendamento para este dia/filtro.</td></tr>';
          return;
        }

        el("dash-grid-body").innerHTML = listaFiltrada
          .map((a) => {
            // Define classes de cor para o badge
            let badgeClass = "st-agendado";
            if (a.status === "Confirmado") badgeClass = "st-confirmado";
            if (a.status === "Finalizado") badgeClass = "st-finalizado";
            if (a.status === "Cancelado") badgeClass = "st-cancelado";
            if (a.status === "Em Atendimento") badgeClass = "st-atendimento";

            // Cria link do WhatsApp se tiver telefone
            // Nota: O backend precisa retornar telefone do paciente na rota /agenda (vamos assumir que sim, ou voc√™ ajusta o backend)
            // Se n√£o tiver telefone vindo na rota agenda, teria que ajustar o backend.py na rota list_ag

            return `
        <tr style="transition:0.2s; cursor:pointer; border-left: 4px solid ${getCorStatus(
          a.status
        )}">
            <td style="font-weight:bold; font-size:1.1rem">${a.data_hora_inicio.substring(
              11,
              16
            )}</td>
            <td>
                <div style="font-weight:bold">${a.paciente}</div>
            </td>
            <td>${a.profissional}</td>
            <td><span class="status-badge ${badgeClass}">${a.status}</span></td>
            <td style="font-size:0.85rem; color:var(--muted)">
                ${a.sala_nome ? "üö™ " + a.sala_nome : ""} <br>
                ${a.tipo ? "üè∑Ô∏è " + a.tipo : ""}
            </td>
            <td>
                <div class="grid-actions">
                    <button class="btn btn-s" title="Editar/Ver" onclick='editAg(${escapeDados(
                      a
                    )})'>üëÅÔ∏è</button>
                    <button class="btn btn-i" title="Reagendar" onclick='dashReagendar(${escapeDados(
                      a
                    )})'>üîÑ</button>
                    <button class="btn btn-d" title="Cancelar" onclick="delAg(${
                      a.id
                    })">‚ùå</button>
                </div>
            </td>
        </tr>
        `;
          })
          .join("");
      }

      // Fun√ß√£o Auxiliar para cor da borda
      function getCorStatus(s) {
        if (s === "Confirmado") return "#3B82F6";
        if (s === "Finalizado") return "#10B981";
        if (s === "Cancelado") return "#EF4444";
        return "transparent";
      }

      // Atalho para criar agendamento j√° na data selecionada
      function modAgDash() {
        modAg();
        el("a-data").value = selectedDashDate;
      }

      // Atalho para Reagendar vindo da Dashboard
      function dashReagendar(a) {
        // Precisamos buscar telefone se n√£o vier no objeto 'a'
        // Mas vamos abrir o modal com o que temos
        openTransf(a.id, a.profissional_id, a.data_hora_inicio, a.paciente, "");
      }
      async function verDia(data) {
        el("m-dia").style.display = "flex";

        const partes = data.split("-");
        el("dia-titulo").innerText = `Agenda de ${partes[2]}/${partes[1]}`;
        el("dia-titulo").dataset.date = data;

        el("dia-lista").innerHTML =
          "<p style='color:var(--muted);text-align:center'>Carregando...</p>";

        const l = await req(`/agenda?inicio=${data}&fim=${data}`);

        if (!l || l.length === 0) {
          el("dia-lista").innerHTML =
            '<p style="color:var(--muted);text-align:center;padding:20px">Nenhum agendamento neste dia.</p>';
        } else {
          el("dia-lista").innerHTML = l
            .map(
              (a) => `
            <div style="background:var(--bg-input); padding:10px; margin-bottom:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary)">
                <div>
                    <strong style="font-size:1.1rem; color:white">${a.data_hora_inicio.substring(
                      11,
                      16
                    )}</strong> 
                    <span style="margin-left:10px">${a.paciente}</span>
                    <div style="font-size:0.8rem; color:var(--muted)">üë®‚Äç‚öïÔ∏è ${
                      a.profissional
                    } | ${a.status}</div>
                </div>
                <button class="btn btn-s" onclick='closeM("m-dia"); editAg(${escapeDados(
                  a
                )})'>‚úé</button>
            </div>
        `
            )
            .join("");
        }
      }
      function modAgDia() {
        const d = el("dia-titulo").dataset.date;
        closeM("m-dia");
        modAg();
        el("a-data").value = d;
      }

      async function loadEspera() {
        const l = await req("/sala_espera");
        const li = el("espera-lista");
        if (!l || !l.length) {
          li.innerHTML =
            '<div style="padding:40px;text-align:center;color:var(--muted)">Vazio</div>';
          return;
        }

        li.innerHTML = l
          .map((a) => {
            const h =
              a.data_hora_inicio.length >= 16
                ? a.data_hora_inicio.substring(11, 16)
                : "--:--";
            const d =
              a.data_hora_inicio.substring(8, 10) +
              "/" +
              a.data_hora_inicio.substring(5, 7);
            const st = a.status || "Agendado";

            let b = "border-agendado";
            if (st == "Cancelado") b = "border-cancelado";
            else if (st == "Finalizado") b = "border-finalizado";
            else if (st == "Em Atendimento") b = "border-atendimento";
            else if (st == "Em Espera") b = "border-espera";
            else if (st == "Confirmado") b = "border-confirmado";

            // Prote√ß√£o para telefone
            const w = a.paciente_tel
              ? `<a href="https://api.whatsapp.com/send?phone=55${a.paciente_tel.replace(
                  /\D/g,
                  ""
                )}" target="_blank" style="margin-left:5px">${ICON_WA}</a>`
              : "";

            const tempo = calcularTempoEspera(a.data_hora_inicio, st);
            const tempoHtml = tempo
              ? `<div class="tempo-espera ${tempo.classe}">${
                  tempo.icone
                } Aguardando ${formatarTempo(tempo.minutos)}</div>`
              : "";

            // Prote√ß√£o contra aspas simples no NOME (Isso quebrava o bot√£o antes)
            const nomeSafe = a.paciente_nome.replace(/'/g, "\\'");

            // Bot√£o de A√ß√£o Principal (Chamar/Rechamar)
            let btnAcao = "";
            if (["Agendado", "Confirmado", "Em Espera"].includes(st)) {
              btnAcao = `<button class="btn-chamar" onclick="chamarPaciente(${a.id}, '${nomeSafe}')">üì£ CHAMAR</button>`;
            } else if (st === "Em Atendimento") {
              btnAcao = `
                 <div style="display:flex; gap:5px; flex-direction:column; margin-top:10px">
                    <button class="btn btn-p" onclick="irParaAtendimento(${a.id}, ${a.paciente_id})">ü©∫ Abrir Prontu√°rio</button>
                    <button class="btn btn-s" style="background:#f59e0b; border:none; font-weight:bold; color:white;" onclick="chamarPaciente(${a.id}, '${nomeSafe}')">üîî RECHAMAR</button>
                 </div>`;
            }

            // Prote√ß√£o dos dados para a fun√ß√£o processarAcao
            const pNomeParam = a.paciente_nome.replace(/'/g, "&#39;"); // Aspas viram c√≥digo HTML seguro
            const pTelParam = (a.paciente_tel || "").replace(/'/g, ""); // Remove aspas do telefone

            return `<div class="espera-card ${b}">
            <div class="ec-header"><span class="ec-time">${h}</span><span class="ec-status-badge">${st}</span></div>
            <div class="ec-date">${d}</div>
            <div class="ec-body"><h3>${
              a.paciente_nome
            }</h3><div class="ec-prof">üìû ${
              a.paciente_tel || "--"
            } ${w}</div><div class="ec-prof">üë®‚Äç‚öïÔ∏è ${
              a.profissional_nome || "-"
            }</div><div class="ec-room">üö™ ${
              a.sala_nome || "-"
            }</div>${tempoHtml}</div>
            ${btnAcao}
            <div class="ec-actions">
                <select onchange="processarAcao(this, ${a.id}, ${
              a.paciente_id
            }, ${a.profissional_id || "null"}, '${
              a.data_hora_inicio
            }', '${pNomeParam}', '${pTelParam}', ${
              a.valor || 0
            })" style="width:100%;background:var(--bg-card);color:white;border:1px solid var(--border);padding:5px;border-radius:4px">
                <optgroup label="A√ß√µes"><option value="" selected disabled>Outras A√ß√µes...</option><option value="Confirmado">‚úÖ Confirmar</option><option value="Em Espera">üèÉ Chegou</option><option value="Em Atendimento">ü©∫ Atender (Sem chamar)</option><option value="Finalizado">üèÅ Finalizar</option><option value="TRANSFERIR">üîÑ Reagendar/Transferir</option><option value="Cancelado">‚ùå Cancelar</option></optgroup>
            </select> 
            </div>
        </div>`;
          })
          .join("");
      }

      async function processarAcao(s, aid, pid, prid, dh, pn, pt, valor) {
        const ac = s.value;

        // 1. Caso de Transfer√™ncia/Reagendamento
        if (ac == "TRANSFERIR") {
          openTransf(aid, prid, dh, pn, pt);
          s.value = "";
          return;
        }

        // 2. Caso de Ir para Atendimento Direto (Sem chamar na TV)
        if (ac == "Em Atendimento") {
          // Corre√ß√£o: Passando ID do M√©dico (prid) corretamente
          irParaAtendimento(aid, pid, prid);
          return;
        }

        // 3. Caso de Finalizar (Checkout)
        if (ac == "Finalizado") {
          openFim(aid, valor, pid, prid);
          s.value = "";
          return;
        }

        // 4. Caso de Cancelamento (Com confirma√ß√£o)
        if (ac == "Cancelado") {
          if (!confirm("Tem certeza que deseja cancelar este agendamento?")) {
            s.value = ""; // Reseta o select
            return;
          }
        }

        // 5. MUDAN√áA DE STATUS PADR√ÉO (Confirmado, Em Espera, Cancelado)
        // Aqui ele chama a fun√ß√£o que criamos no passo 1
        await mudarSt(aid, ac);

        // Reseta o select para o visual ficar limpo (opcional, ou loadEspera j√° redesenha)
        s.value = "";
      }

      // --- FUN√á√ïES DO CHECKOUT ---

      function openFim(id, valor, pid, prid) {
        el("m-fim").style.display = "flex";
        el("fim-id").value = id;

        // --- CORRE√á√ÉO DE SEGURAN√áA ---
        // Se por algum motivo o PID vier vazio (undefined), tentamos pegar do atributo do select
        if (!pid || pid === "undefined") {
          console.warn("ID do Paciente perdido, tentando recuperar...");
          // Tenta achar o agendamento na lista global se poss√≠vel (opcional)
        }

        el("fim-pac-id").value = pid; // <--- AQUI QUE ELE GUARDA O ID
        el("fim-prof-id").value = prid;

        // Preenche valor e status
        el("fim-valor").value = valor || 0;
        el("fim-status-fin").value = valor && valor > 0 ? "Pago" : "Pendente";

        // Reseta
        el("fim-retorno").checked = false;
        toggleRetorno();
        togglePagamento();
      }

      function togglePagamento() {
        // Apenas cosm√©tico: Se for Pendente/Conv√™nio, talvez esconder op√ß√µes de pix/dinheiro?
        // Por enquanto vamos deixar tudo vis√≠vel, mas voc√™ pode customizar aqui
      }

      function toggleRetorno() {
        el("fim-area-retorno").style.display = el("fim-retorno").checked
          ? "block"
          : "none";
      }

      async function confFim() {
        const btn = document.querySelector("#m-fim .btn-p");
        btn.disabled = true;
        btn.innerText = "Processando...";

        try {
          // 1. AUTO-RECUPERA√á√ÉO (O Pulo do Gato) üò∫
          // Se o ID do Paciente sumiu, vamos buscar ele agora mesmo no servidor
          if (!val("fim-pac-id") || val("fim-pac-id") == "undefined") {
            console.log("üîÑ Recuperando dados perdidos do agendamento...");

            // Busca a lista atualizada da sala de espera
            const listaRecuperacao = await req("/sala_espera");
            const agendamentoReal = listaRecuperacao.find(
              (x) => x.id == val("fim-id")
            );

            if (agendamentoReal) {
              // Preenche os campos ocultos que estavam vazios
              el("fim-pac-id").value = agendamentoReal.paciente_id;
              el("fim-prof-id").value = agendamentoReal.profissional_id;
            } else {
              // Se n√£o achou na sala de espera, tenta buscar na agenda do dia
              const hoje = new Date().toISOString().split("T")[0];
              const listaAgenda = await req(
                `/agenda?inicio=${hoje}&fim=${hoje}`
              );
              const agendamentoAgenda = listaAgenda.find(
                (x) => x.id == val("fim-id")
              );

              if (agendamentoAgenda) {
                el("fim-pac-id").value = agendamentoAgenda.paciente_id;
                el("fim-prof-id").value = agendamentoAgenda.profissional_id;
              }
            }
          }

          // 2. Envia a finaliza√ß√£o
          await req("/agenda/status", "POST", {
            id: val("fim-id"),
            status: "Finalizado",
            valor_final: val("fim-valor"),
            status_financeiro: val("fim-status-fin"),
            forma_pagamento: val("fim-forma"),
          });

          let dataRetorno = null;

          // 3. Agenda o Retorno (Agora com os IDs recuperados)
          if (el("fim-retorno").checked) {
            const dt = val("fim-data");
            const hr = val("fim-hora");
            // Agora o PID estar√° preenchido pela recupera√ß√£o acima
            const pid = parseInt(val("fim-pac-id"));
            const prid = parseInt(val("fim-prof-id"));

            // Valida√ß√£o final silenciosa (se mesmo recuperando falhar, avisa suave)
            if (!pid)
              throw "N√£o foi poss√≠vel identificar o paciente automaticamente.";

            if (dt && hr) {
              const res = await req("/agenda/salvar", "POST", {
                paciente_id: pid,
                profissional_id: prid || 1, // Se n√£o tiver m√©dico, usa admin/padr√£o
                data: dt,
                hora: hr,
                sala_id: 1,
                tipo: "Retorno",
                duracao: 30,
                obs: "Retorno gerado no checkout",
              });

              if (res && res.msg == "Ok") {
                showToast(
                  "‚úÖ Retorno agendado: " + dt.split("-").reverse().join("/")
                );
                dataRetorno = dt;
              }
            } else {
              showToast(
                "Faltou data para o retorno, mas finalizado.",
                "alerta"
              );
            }
          } else {
            showToast("Finalizado com Sucesso! üí∞");
          }

          // 4. Limpeza
          closeM("m-fim");
          loadEspera();
          loadDash();

          // Vai para a agenda se tiver retorno
          if (dataRetorno) {
            el("ag-ini").value = dataRetorno;
            el("ag-fim").value = dataRetorno;
            nav("agenda", document.querySelector("button[onclick*='agenda']"));
          } else {
            if (typeof loadAgenda === "function") loadAgenda();
          }

          if (calendar) calendar.refetchEvents();
        } catch (e) {
          console.error(e);
          alert("Erro: " + e);
        } finally {
          btn.disabled = false;
          btn.innerText = "Confirmar e Baixar";
        }
      }
      async function startAtend() {
        const pid = val("atend-pac-sel"),
          pr = val("at-prof");
        if (!pid) return showToast("Selecione Paciente", "erro");

        await req(
          "/agenda/iniciar_atendimento_paciente",
          "POST",
          { id: pid, prof_id: pr },
          true
        );

        const pacientes = await req("/pacientes?filtro=");
        const paciente = pacientes.find((p) => p.id == pid);

        if (paciente) {
          el("atend-pac-name").innerText = "Paciente: " + paciente.nome;
          el("at-alergias").value = paciente.alergias || "";
          el("at-meds-uso").value =
            paciente.medicamentos_em_uso || "Nada consta";
        }

        // LIMPEZA COMPLETA DOS CAMPOS ANTIGOS E NOVOS (SOAP)
        [
          "at-peso",
          "at-altura",
          "at-pa",
          "at-temp",
          "at-sat",
          "at-pres",
          "at-exm",
          "atend-cid",
          // Novos Campos SOAP
          "at-qp",
          "at-s",
          "at-o",
          "at-a",
          "at-p",
          "at-conduta",
          "at-retorno",
        ].forEach((i) => {
          if (el(i)) el(i).value = "";
        });

        // Limpa anexos
        anexosAtuais = [];
        renderAnexos();

        el("atend-sel-area").style.display = "none";
        el("atend-main").style.display = "block";
        fill("at-prof", "/profissionais");

        loadHistoricoVisual(pid);
      }
      async function loadHistoricoVisual(pid) {
        const h = await req("/prontuario/" + pid);
        const container = el("at-hist");

        if (!h || h.length === 0) {
          container.innerHTML =
            "<div style='text-align:center; color:#666; padding:20px'>Nenhum hist√≥rico anterior.</div>";
          return;
        }

        container.innerHTML = h
          .map((i) => {
            // Formata√ß√£o inteligente da data
            const d = new Date(i.data_atendimento.replace(" ", "T"));
            const dia = d.toLocaleDateString("pt-BR");
            const hora = d.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            });

            // Resumo inteligente (Pega QP ou Diagn√≥stico ou peda√ßo da Evolu√ß√£o)
            let resumo =
              i.queixa_principal || i.diagnostico || "Atendimento de Rotina";
            if (resumo.length > 40) resumo = resumo.substring(0, 40) + "...";

            // Passamos o objeto inteiro escapado para o clique
            return `
        <div class="timeline-item" onclick='abrirHistoricoFull(${escapeDados(
          i
        )})'>
            <div class="timeline-dot"></div>
            <div class="hist-date">${dia} <span style="font-weight:normal; color:#666">√†s ${hora}</span></div>
            <div class="hist-doc">${i.profissional}</div>
            <div class="hist-resumo">${resumo}</div>
        </div>
        `;
          })
          .join("");
      }

      // 2. ABRE O MODAL "ESPELHO"
      function abrirHistoricoFull(i) {
        // Cabe√ßalho
        el("h-data").innerText = fmtDataHora(i.data_atendimento);
        el("h-prof").innerText = i.profissional;

        // Sinais Vitais
        el("h-peso").innerText = i.peso || "--";
        el("h-altura").innerText = i.altura || "--";
        el("h-pa").innerText = i.pressao || "--";
        el("h-temp").innerText = i.temp || "--";
        el("h-sat").innerText = i.saturacao || "--";

        // SOAP
        el("h-qp").innerText = i.queixa_principal || "N√£o informada";

        // Se for modelo antigo (texto corrido), joga tudo no Subjetivo para n√£o perder
        if (!i.subjetivo && !i.objetivo && i.evolucao_clinica) {
          el("h-s").innerText = i.evolucao_clinica; // Legado
          el("h-o").innerText = "-";
          el("h-a").innerText = "-";
          el("h-p").innerText = "-";
        } else {
          el("h-s").innerText = i.subjetivo || "-";
          el("h-o").innerText = i.objetivo || "-";
          el("h-a").innerText = i.avaliacao || "-";
          el("h-p").innerText = i.plano || "-";
        }

        // Receitas e Exames
        el("h-pres").innerText = i.prescricao || "Sem prescri√ß√£o";
        el("h-exm").innerText = i.exames_solicitados || "Sem exames";
        el("h-conduta").innerText = i.conduta || "--";
        el("h-retorno").innerText = i.retorno || "--";

        // Bot√£o M√°gico: Copiar Receita
        const btnCopy = el("btn-copiar-receita");
        if (i.prescricao) {
          btnCopy.style.display = "inline-block";
          // Usa uma fun√ß√£o an√¥nima para n√£o executar na hora
          btnCopy.onclick = function () {
            el("at-pres").value +=
              (el("at-pres").value ? "\n\n" : "") + i.prescricao;
            showToast("Receita copiada para o atendimento atual!");
            closeM("m-hist-detalhe");
          };
        } else {
          btnCopy.style.display = "none";
        }

        // GALERIA DE ANEXOS (A PARTE IMPORTANTE)
        const galeria = el("h-anexos-list");
        galeria.innerHTML = "";

        if (i.anexos) {
          try {
            const listaAnexos = JSON.parse(i.anexos);
            if (listaAnexos && listaAnexos.length > 0) {
              galeria.innerHTML = listaAnexos
                .map(
                  (a) => `
                    <div class="thumb-item" title="${
                      a.arquivo
                    }" style="width:80px; height:80px">
                        <a href="${a.url}" target="_blank">
                            ${
                              a.arquivo.match(/\.(jpg|jpeg|png|gif)$/i)
                                ? `<img src="${a.url}">`
                                : '<div style="display:flex;justify-content:center;align-items:center;height:100%;font-size:24px;background:#333">üìÑ</div>'
                            }
                        </a>
                    </div>
                `
                )
                .join("");
            } else {
              galeria.innerHTML =
                "<small style='color:#666'>Sem anexos</small>";
            }
          } catch (e) {
            galeria.innerHTML =
              "<small style='color:red'>Erro ao carregar anexos</small>";
          }
        } else {
          galeria.innerHTML = "<small style='color:#666'>Sem anexos</small>";
        }

        el("m-hist-detalhe").style.display = "flex";
      }

      function verDetalheCompleto(i) {
        // Verifica se √© um registro SOAP (novo) ou Texto Simples (antigo)
        let corpoClinico = "";

        if (i.subjetivo || i.objetivo || i.queixa_principal) {
          // √â SOAP! Monta layout bonito
          corpoClinico = `
            ${
              i.queixa_principal
                ? `<div style="margin-bottom:10px; padding:8px; background:#374151; border-radius:4px; border-left:4px solid var(--primary)"><strong>Queixa:</strong> ${i.queixa_principal}</div>`
                : ""
            }
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                <div style="background:#1f2937; padding:10px; border-left:3px solid #3B82F6">
                    <strong style="color:#3B82F6">S (Subjetivo):</strong><br><span style="white-space:pre-wrap">${
                      i.subjetivo || "-"
                    }</span>
                </div>
                <div style="background:#1f2937; padding:10px; border-left:3px solid #EF4444">
                    <strong style="color:#EF4444">O (Objetivo):</strong><br><span style="white-space:pre-wrap">${
                      i.objetivo || "-"
                    }</span>
                </div>
                <div style="background:#1f2937; padding:10px; border-left:3px solid #F59E0B">
                    <strong style="color:#F59E0B">A (Avalia√ß√£o):</strong><br><span style="white-space:pre-wrap">${
                      i.avaliacao || "-"
                    }</span>
                </div>
                <div style="background:#1f2937; padding:10px; border-left:3px solid #10B981">
                    <strong style="color:#10B981">P (Plano):</strong><br><span style="white-space:pre-wrap">${
                      i.plano || "-"
                    }</span>
                </div>
            </div>
            
            <div style="margin-top:15px; display:flex; gap:20px; font-weight:bold; color:#ccc; border-top:1px solid #444; padding-top:10px">
                <span>üì¢ Conduta: ${i.conduta || "-"}</span>
                <span>üìÖ Retorno: ${i.retorno || "-"}</span>
            </div>
          `;
        } else {
          // √â Antigo! Mostra como era
          corpoClinico = `<h4 style="color:#ccc; margin-top:10px">üìù Evolu√ß√£o</h4>
            <p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${i.evolucao_clinica}</p>`;
        }

        const html = `
            <div style="border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px">
                <h3 style="color:var(--primary)">Data: ${
                  i.data_atendimento
                }</h3>
                <small>Profissional: ${i.profissional}</small>
            </div>

            <div style="display:flex; gap:15px; background:#222; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.9rem">
                <span>‚öñ ${i.peso || "--"}kg</span>
                <span>üìè ${i.altura || "--"}m</span>
                <span>‚ù§ ${i.pressao || "--"}mmHg</span>
                <span>üå° ${i.temp || "--"}¬∞C</span>
                <span>ü´ß ${i.saturacao || "--"}%</span>
            </div>

            ${corpoClinico}

            ${
              i.prescricao
                ? `<h4 style="color:#ccc; margin-top:10px">üíä Prescri√ß√£o</h4><p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${i.prescricao}</p>`
                : ""
            }
            ${
              i.exames_solicitados
                ? `<h4 style="color:#ccc; margin-top:10px">üî¨ Exames</h4><p style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap">${i.exames_solicitados}</p>`
                : ""
            }
            
            ${
              i.anexos
                ? `<div style="margin-top:10px; padding:10px; border:1px dashed #555">üìé <strong>Anexos dispon√≠veis no prontu√°rio original</strong></div>`
                : ""
            }

            <div style="margin-top:20px; text-align:right">
                <button class="btn btn-s" onclick="copiarTexto('${
                  i.prescricao ? i.prescricao.replace(/\n/g, "\\n") : ""
                }')">Copiar Receita</button>
            </div>
          `;

        el("conteudo-leitura").innerHTML = html;
        el("m-leitura").style.display = "flex";
      }

      function copiarTexto(t) {
        if (!t) return showToast("Nada para copiar", "erro");
        el("at-pres").value += "\n" + t; // Joga na receita atual
        showToast("Copiado para a receita atual!");
        closeM("m-leitura");
      }
      function verDetalheHist(t) {
        el("conteudo-leitura").innerText = t;
        el("m-leitura").style.display = "flex";
      }
      function closeAtend() {
        el("atend-main").style.display = "none";
        el("atend-sel-area").style.display = "block";
        loadEspera();
      }
      async function saveAtend() {
        const btn = document.querySelector("button[onclick='saveAtend()']");
        const txtOriginal = btn.innerText;

        btn.innerText = "‚è≥ Salvando...";
        btn.disabled = true;

        try {
          const res = await req("/prontuario/salvar", "POST", {
            paciente_id: val("atend-pac-sel") || val("atend-pac-sel"),
            profissional_id: val("at-prof"),

            // DADOS CLINICOS NOVOS (SOAP)
            queixa_principal: val("at-qp"),
            subjetivo: val("at-s"),
            objetivo: val("at-o"),
            avaliacao: val("at-a"),
            plano: val("at-p"),
            conduta: val("at-conduta"),
            retorno: val("at-retorno"),

            // Mant√©m os antigos
            prescricao: val("at-pres"),
            exames: val("at-exm"),
            diagnostico: val("atend-cid"),
            alergias: val("at-alergias"),
            peso: val("at-peso"),
            altura: val("at-altura"),
            pressao: val("at-pa"),
            temp: val("at-temp"),
            saturacao: val("at-sat"),
            anexos: JSON.stringify(anexosAtuais),
          });

          if (res && res.msg) {
            showToast("‚úÖ Prontu√°rio Salvo!");
            closeAtend();
          } else {
            showToast("Erro ao salvar", "erro");
          }
        } catch (e) {
          console.error(e);
          showToast("Erro cr√≠tico", "erro");
        } finally {
          if (btn) {
            btn.innerText = txtOriginal;
            btn.disabled = false;
          }
        }
      }
      async function rechamar(id) {
        showToast("Reenviando sinal para TV...");
        // Truque: Muda para "Em Espera" e logo em seguida para "Em Atendimento"
        // A TV percebe a mudan√ßa e toca o som de novo.
        await req("/agenda/status", "POST", { id: id, status: "Em Espera" });

        setTimeout(async () => {
          await req("/agenda/status", "POST", {
            id: id,
            status: "Em Atendimento",
          });
          loadEspera();
        }, 500); // Espera meio segundo
      }

      function openTransf(id, prid, dh, pn, pt) {
        el("m-transf").style.display = "flex";
        el("tr-id").value = id;
        el("tr-pac-nome").value = pn;
        el("tr-pac-tel").value = pt;
        fill("tr-prof", "/profissionais").then(() => {
          el("tr-prof").value = prid;
        });
        const p = dh.split(" ");
        el("tr-data").value = p[0];
        el("tr-hora").value = p[1].substring(0, 5);
      }
      async function confTransf() {
        const d = val("tr-data");
        const h = val("tr-hora");
        const pid = val("tr-prof");

        if (!d || !h || !pid)
          return showToast("Preencha data, hora e profissional", "erro");

        const res = await req("/agendamento/transferir", "POST", {
          id: val("tr-id"),
          profissional_id: pid,
          data: d,
          hora: h,
        });

        // Verifica se deu erro (ex: Hor√°rio ocupado)
        if (res && res.erro) {
          alert("‚ùå N√£o foi poss√≠vel reagendar:\n" + res.erro);
          return;
        }

        if (res && res.msg == "Ok") {
          showToast("‚úÖ Reagendado com sucesso!");
          closeM("m-transf");
          loadEspera();
          loadAgenda(); // Atualiza agenda tamb√©m se estiver aberta

          // Envia zap se tiver telefone
          if (val("tr-pac-tel")) {
            const profNome =
              el("tr-prof").options[el("tr-prof").selectedIndex].text;
            const dataFmt = d.split("-").reverse().join("/");
            const msg = `Ol√° *${val(
              "tr-pac-nome"
            )}*, seu atendimento foi reagendado para *${dataFmt}* √†s *${h}* com *${profNome}*.`;

            if (confirm("Abrir WhatsApp para avisar o paciente?")) {
              window.open(
                `https://api.whatsapp.com/send?phone=55${val(
                  "tr-pac-tel"
                ).replace(/\D/g, "")}&text=${encodeURIComponent(msg)}`,
                "_blank"
              );
            }
          }
        }
      }

      function openFim(id) {
        el("m-fim").style.display = "flex";
        el("fim-id").value = id;
      }
      function toggleRetorno() {
        el("fim-area-retorno").style.display = el("fim-retorno").checked
          ? "block"
          : "none";
      }

      async function loadProf(termo = "") {
        const l = await req("/profissionais");
        const tbody = el("t-prof");

        if (!l || l.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted)">Nenhum profissional cadastrado.</td></tr>';
          return;
        }

        // --- FILTRO INTELIGENTE (Client-Side) ---
        // Como a lista de m√©dicos √© pequena, filtramos aqui mesmo para ser instant√¢neo
        const filtrados = l.filter((p) => {
          if (!termo) return true; // Se n√£o tem busca, mostra tudo
          const t = termo.toLowerCase();
          return (
            (p.nome && p.nome.toLowerCase().includes(t)) ||
            (p.crm && p.crm.toLowerCase().includes(t)) ||
            (p.esp_nome && p.esp_nome.toLowerCase().includes(t))
          );
        });

        if (filtrados.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted)">Nenhum profissional encontrado para esta busca.</td></tr>';
          return;
        }

        tbody.innerHTML = filtrados
          .map((p) => {
            const fotoUrl = p.foto
              ? `/uploads/${p.foto}`
              : "https://cdn-icons-png.flaticon.com/512/3774/3774299.png";

            const statusBadge = p.ativo
              ? `<span class="badge-status status-on">Ativo</span>`
              : `<span class="badge-status status-off">Inativo</span>`;

            const zapLink = p.telefone
              ? `<a href="https://api.whatsapp.com/send?phone=55${p.telefone.replace(
                  /\D/g,
                  ""
                )}" target="_blank" style="text-decoration:none; color:#25D366; font-weight:bold; font-size:0.8rem">üì± ${
                  p.telefone
                }</a>`
              : `<span style="color:var(--muted); font-size:0.8rem">--</span>`;

            return `
            <tr class="prof-row">
                <td style="padding: 12px 20px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <img src="${fotoUrl}" class="prof-avatar-small">
                        <div class="prof-main-info">
                            <span class="prof-name">${p.nome}</span>
                            <span class="prof-sub">
                                <span class="color-dot" style="background:${
                                  p.cor_agenda || "#ccc"
                                }"></span>
                                Agenda
                            </span>
                        </div>
                    </div>
                </td>

                <td>
                    <div style="font-weight:600; color:#ddd">${
                      p.esp_nome || "Geral"
                    }</div> 
                    <div style="font-size:0.8rem; color:var(--muted)">CRM: ${
                      p.crm || "N/A"
                    }</div>
                </td>

                <td>
                    ${zapLink}
                    <div style="font-size:0.75rem; color:var(--muted)">${
                      p.email || ""
                    }</div>
                </td>

                <td>${statusBadge}</td>

                <td style="text-align: right; padding-right: 20px;">
                    <button class="btn btn-s" onclick='editProf(${escapeDados(
                      p
                    )})' title="Editar">‚úèÔ∏è</button>
                    <button class="btn btn-d" onclick="inativarProf(${
                      p.id
                    })" title="Desativar/Excluir">üóëÔ∏è</button>
                </td>
            </tr>`;
          })
          .join("");
      }
      async function inativarProf(id) {
        if (
          confirm(
            "Tem certeza? Se o profissional tiver agenda, ele ser√° apenas inativado."
          )
        ) {
          const res = await req("/profissionais/deletar/" + id, "DELETE");
          if (res) {
            if (res.msg) showToast(res.msg);
            loadProf(); // Recarrega a lista
          }
        }
      }
      function modProf() {
        el("m-prof").style.display = "flex";
        fill("pr-esp", "/auxiliares/especialidades");

        // Reset da Foto
        el("pr-foto-preview").src =
          "https://cdn-icons-png.flaticon.com/512/3774/3774299.png";
        el("pr-foto-path").value = "";

        // Limpa campos texto
        [
          "pr-id",
          "pr-nome",
          "pr-crm",
          "pr-cpf",
          "pr-nasc",
          "pr-email",
          "pr-tel",
          "pr-rua",
          "pr-banco",
          "pr-pix",
          "pr-comissao",
          "pr-ag",
          "pr-cc",
          "pr-bairro",
          "pr-cid",
          "pr-dias",
          "pr-valor",
        ].forEach((i) => {
          if (el(i)) el(i).value = "";
        });

        // Limpa assinatura
        el("pr-assinatura-path").value = "";
        el("ass-status").innerText = "Fundo transparente recomendado (PNG)";
      }
      function editProf(p) {
        modProf(); // Limpa o modal primeiro

        // Preenche os campos b√°sicos
        el("pr-id").value = p.id;
        el("pr-nome").value = p.nome;
        el("pr-crm").value = p.crm;
        el("pr-email").value = p.email || "";
        el("pr-cpf").value = p.cpf || "";
        el("pr-nasc").value = p.data_nascimento || "";
        el("pr-tel").value = p.telefone || "";
        el("pr-valor").value = p.valor_padrao || "";
        el("pr-esp").value = p.especialidade_id || "";
        el("pr-comissao").value = p.comissao || "";
        el("pr-dias").value = p.disponibilidade || ""; // Se for objeto, pode precisar de JSON.stringify
        el("pr-foto-path").value = p.foto || "";
        el("pr-foto-preview").src = p.foto
          ? "/uploads/" + p.foto
          : "https://cdn-icons-png.flaticon.com/512/3774/3774299.png";

        // Preenche Endere√ßo (que vem como texto JSON do banco)
        try {
          if (p.endereco) {
            const end =
              typeof p.endereco === "string"
                ? JSON.parse(p.endereco)
                : p.endereco;
            el("pr-rua").value = end.rua || "";
            el("pr-bairro").value = end.bairro || "";
            el("pr-cid").value = end.cidade || "";
          }
        } catch (e) {}

        // Preenche Banco
        try {
          if (p.dados_bancarios) {
            const bank =
              typeof p.dados_bancarios === "string"
                ? JSON.parse(p.dados_bancarios)
                : p.dados_bancarios;
            el("pr-banco").value = bank.banco || "";
            el("pr-ag").value = bank.ag || "";
            el("pr-cc").value = bank.cc || "";
            el("pr-pix").value = bank.pix || "";
            el("pr-assinatura-path").value = p.assinatura_path || "";
            el("ass-status").innerText = p.assinatura_path
              ? "‚úÖ Assinatura salva"
              : "Nenhuma assinatura";
          }
        } catch (e) {}
      }
      async function saveProf() {
        const btn = document.querySelector("#m-prof .btn-p");
        const txtOriginal = btn.innerText;

        if (!val("pr-nome")) return showToast("Nome √© obrigat√≥rio", "erro");

        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
          // Monta o objeto de endere√ßo
          const endereco = {
            rua: val("pr-rua"),
            bairro: val("pr-bairro"),
            cidade: val("pr-cid"),
          };

          // Monta o objeto banc√°rio
          const banco = {
            banco: val("pr-banco"),
            ag: val("pr-ag"),
            cc: val("pr-cc"),
            pix: val("pr-pix"),
          };

          const res = await req("/profissionais/salvar", "POST", {
            id: val("pr-id"),
            nome: val("pr-nome"),
            crm: val("pr-crm"),
            esp_id: val("pr-esp"),
            email: val("pr-email"),
            cpf: val("pr-cpf"),
            nasc: val("pr-nasc"),
            tel: val("pr-tel"),
            valor_padrao: val("pr-valor"),
            comissao: val("pr-comissao"),
            dias: val("pr-dias"),
            endereco: endereco,
            banco: banco,
            assinatura_path: val("pr-assinatura-path"), // <--- ADICIONE ESTA LINHA AQUI
            foto: val("pr-foto-path"),
          });

          if (res && res.msg) {
            closeM("m-prof");
            loadProf();
            showToast("‚úÖ Profissional Salvo!");
          } else if (res && res.erro) {
            alert("‚ö†Ô∏è " + res.erro);
          }
        } catch (e) {
          console.error(e);
          showToast("Erro de conex√£o", "erro");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      async function loadAux(t, b) {
        curAux = t;
        if (b) {
          document
            .querySelectorAll("#v-cadastros .tab")
            .forEach((x) => x.classList.remove("active"));
          b.classList.add("active");
        }

        // HTML do bot√£o da Matriz (para reutilizar)
        const btnMatriz = `
            <button class="btn btn-i" style="background:#8B5CF6; margin-left:10px;" onclick="abrirMatrizPrecos()">
                üí∞ Matriz de Pre√ßos
            </button>`;

        if (t == "convenios") {
          el("aux-simple-ctrl").style.display = "none";
          el("aux-conv-ctrl").style.display = "block";
          const l = await req("/convenios");
          el("t-aux").innerHTML = l
            .map(
              (c) =>
                `<tr><td>${
                  c.nome
                }</td><td><button class="btn btn-s" onclick='editConv(${escapeDados(
                  c
                )})'>‚úé</button> <button class="btn btn-d" onclick="delConv(${
                  c.id
                })">X</button></td></tr>`
            )
            .join("");
        } else {
          el("aux-simple-ctrl").style.display = "flex";
          el("aux-conv-ctrl").style.display = "none";

          // --- CORRE√á√ÉO AQUI: INCLU√çMOS O btnMatriz NO HTML DIN√ÇMICO ---
          if (t === "procedimentos") {
            el("aux-simple-ctrl").innerHTML =
              `<button class="btn btn-p" onclick="abrirProcDetalhe()" style="flex:1">+ Novo Procedimento Avan√ßado</button>` +
              btnMatriz;
          } else {
            // Volta ao normal para salas/especialidades
            el("aux-simple-ctrl").innerHTML =
              `<input type="text" id="aux-nome" placeholder="Novo item..." style="flex:1; min-width:200px" /><button class="btn btn-p" onclick="salvAux()">Adicionar</button>` +
              btnMatriz;
          }

          const l = await req("/auxiliares/" + t);
          el("t-aux").innerHTML = l
            .map((i) => {
              if (t === "procedimentos") {
                return `<tr><td>${i.nome}</td><td style="text-align:right">
                      <button class="btn btn-s" onclick="abrirProcDetalhe(${i.id})">üõ†Ô∏è Detalhes</button> 
                      <button class="btn btn-d" onclick="delAux(${i.id})">X</button>
                  </td></tr>`;
              } else {
                return `<tr><td>${i.nome}</td><td style="text-align:right"><button class="btn btn-d" onclick="delAux(${i.id})">X</button></td></tr>`;
              }
            })
            .join("");
        }
      }
      function modConv() {
        el("m-conv").style.display = "flex";
        ["cv-id", "cv-nome"].forEach((i) => (el(i).value = ""));
      }
      function editConv(c) {
        modConv(); // Abre o modal e limpa os campos

        // Preenche os campos de texto
        el("cv-id").value = c.id;
        el("cv-nome").value = c.nome;
        el("cv-ans").value = c.registro_ans || "";
        el("cv-cnpj").value = c.cnpj || "";
        el("cv-prazo").value = c.prazo_pagamento || "";
        el("cv-email").value = c.email || "";
        el("cv-site").value = c.site || "";

        // --- L√ìGICA DO ARQUIVO DA TABELA ---
        el("cv-arquivo-path").value = c.arquivo_tabela || "";

        if (c.arquivo_tabela) {
          el("cv-status-upload").innerText = "‚úÖ Arquivo salvo anteriormente";
          el("btn-ver-tabela").style.display = "block";
        } else {
          el("cv-status-upload").innerText = "Nenhum arquivo selecionado";
          el("btn-ver-tabela").style.display = "none";
        }
      }
      async function saveConv() {
        if (
          await req("/convenios/salvar", "POST", {
            id: val("cv-id"),
            nome: val("cv-nome"),
            ans: val("cv-ans"),
            cnpj: val("cv-cnpj"),
            prazo: val("cv-prazo"),
            email: val("cv-email"),
            site: val("cv-site"),
            tabela: val("cv-arquivo-path"), // <--- LINHA NOVA: Envia o arquivo
          })
        ) {
          closeM("m-conv");
          loadAux("convenios");
          showToast("Conv√™nio Salvo!");
        }
      }
      async function delConv(id) {
        if (confirm("Apagar?")) {
          await req(`/auxiliares/convenios/deletar/${id}`, "DELETE");
          loadAux("convenios");
        }
      }
      async function salvAux() {
        if (
          await req(`/auxiliares/${curAux}/salvar`, "POST", {
            nome: val("aux-nome"),
          })
        ) {
          el("aux-nome").value = "";
          loadAux(curAux);
        }
      }
      async function delAux(id) {
        if (confirm("Apagar?")) {
          await req(`/auxiliares/${curAux}/deletar/${id}`, "DELETE");
          loadAux(curAux);
        }
      }

      async function loadPac(f) {
        // Feedback visual enquanto carrega
        el("t-pac").innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--muted)">Carregando...</td></tr>';

        // Busca no servidor (mantemos isso pois podem ter milhares de pacientes)
        const l = await req("/pacientes?filtro=" + f);
        const tbody = el("t-pac");

        if (!l || l.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted)">Nenhum paciente encontrado.</td></tr>';
          return;
        }

        tbody.innerHTML = l
          .map((p) => {
            // 1. Foto do Paciente
            const fotoUrl = p.foto
              ? `/uploads/${p.foto}`
              : "https://cdn-icons-png.flaticon.com/512/847/847969.png";

            // 2. C√°lculo da Idade
            let idadeHtml = "";
            if (p.data_nascimento) {
              const dn = new Date(p.data_nascimento);
              const hoje = new Date();
              let anos = hoje.getFullYear() - dn.getFullYear();
              const m = hoje.getMonth() - dn.getMonth();
              if (m < 0 || (m === 0 && hoje.getDate() < dn.getDate())) {
                anos--;
              }
              // Badge de idade
              idadeHtml = `<span style="font-size:0.75rem; color:var(--muted); background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; margin-left:8px">${anos} anos</span>`;
            }

            // 3. Status
            const isAtivo = p.ativo !== 0;
            const statusBadge = isAtivo
              ? `<span class="badge-status status-on">Ativo</span>`
              : `<span class="badge-status status-off">Arquivado</span>`;

            // 4. WhatsApp Link
            const tel = p.telefone_principal || "";
            const zapLink =
              tel.length > 8
                ? `<a href="https://api.whatsapp.com/send?phone=55${tel.replace(
                    /\D/g,
                    ""
                  )}" target="_blank" style="text-decoration:none; color:#25D366; font-weight:bold; font-size:0.8rem; display:flex; align-items:center; gap:4px">üì± ${tel}</a>`
                : `<span style="color:var(--muted); font-size:0.8rem">--</span>`;

            // 5. Data de Cadastro
            const cadastro = p.created_at
              ? p.created_at.substring(0, 10).split("-").reverse().join("/")
              : "-";

            return `
            <tr class="prof-row">
                <td style="padding: 12px 20px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <img src="${fotoUrl}" class="prof-avatar-small">
                        <div class="prof-main-info">
                            <div style="display:flex; align-items:center;">
                                <span class="prof-name">${p.nome}</span>
                                ${idadeHtml}
                            </div>
                            <span class="prof-sub">Cadastro: ${cadastro}</span>
                        </div>
                    </div>
                </td>

                <td>
                    <div style="color:#ddd; font-weight:500">${
                      p.cpf || "CPF n/d"
                    }</div>
                    <div style="font-size:0.8rem; color:var(--muted)">RG: ${
                      p.rg || "-"
                    }</div>
                </td>

                <td>
                    ${zapLink}
                    <div style="font-size:0.75rem; color:var(--muted); margin-top:2px">üìß ${
                      p.email || ""
                    }</div>
                </td>

                <td>${statusBadge}</td>

                <td style="text-align: right; padding-right: 20px; white-space: nowrap;">
                    <button class="btn btn-i" style="padding: 6px 10px; margin-right: 5px;" onclick="verHistoricoPaciente(${
                      p.id
                    })" title="Prontu√°rio/Hist√≥rico">üìú</button>
                    <button class="btn btn-s" onclick='editPac(${escapeDados(
                      p
                    )})' title="Editar">‚úèÔ∏è</button>
                    <button class="btn btn-d" onclick="inativarPac(${
                      p.id
                    })" title="Arquivar">üóëÔ∏è</button>
                </td>
            </tr>`;
          })
          .join("");
      }
      function modPac() {
        el("m-pac").style.display = "flex";
        fill("p-conv", "/auxiliares/convenios");

        // RESET DA FOTO (Adicione esta linha abaixo)
        el("p-foto-preview").src = "";
        el("p-foto-path").value = "";

        // Limpa campos normais
        [
          "p-id",
          "p-nome",
          "p-cpf",
          "p-rg",
          "p-nasc",
          "p-sexo",
          "p-tel1",
          "p-email",
          "p-end",
          "p-meds",
          "p-obs",
        ].forEach((i) => {
          if (el(i)) el(i).value = "";
        });

        // LIMPA OS NOVOS CAMPOS (FILIA√á√ÉO)
        ["p-pai", "p-tel-pai", "p-mae", "p-tel-mae"].forEach((i) => {
          if (el(i)) el(i).value = "";
        });
      }
      function editPac(p) {
        modPac(); // Limpa tudo antes

        // Carrega dados padr√£o
        el("p-id").value = p.id;
        el("p-nome").value = p.nome;
        el("p-cpf").value = p.cpf || "";
        el("p-rg").value = p.rg || "";
        el("p-nasc").value = p.data_nascimento || "";
        el("p-sexo").value = p.sexo || "M";
        el("p-tel1").value = p.telefone_principal || "";
        el("p-email").value = p.email || "";
        el("p-end").value = p.endereco || ""; // Endere√ßo simples
        el("p-conv").value = p.convenio_id || "";
        el("p-meds").value = p.medicamentos_em_uso || "";
        el("p-obs").value = p.observacoes_medicas || "";

        // --- L√ìGICA SEGURA PARA FILIA√á√ÉO ---
        try {
          let resp = {};
          // O backend manda isso como texto JSON. Precisamos converter de volta para Objeto.
          if (
            p.responsavel &&
            p.responsavel !== "null" &&
            p.responsavel !== ""
          ) {
            // Verifica se j√° √© objeto ou se √© string
            resp =
              typeof p.responsavel === "string"
                ? JSON.parse(p.responsavel)
                : p.responsavel;
          }

          // Preenche ou deixa vazio se n√£o existir
          el("p-pai").value = resp.pai || "";
          el("p-tel-pai").value = resp.tel_pai || "";
          el("p-mae").value = resp.mae || "";
          el("p-tel-mae").value = resp.tel_mae || "";
          el("p-foto-path").value = p.foto || "";
          el("p-foto-preview").src = p.foto
            ? "/uploads/" + p.foto
            : "https://cdn-icons-png.flaticon.com/512/847/847969.png";
          el("p-foto-path").value = p.foto || "";
        } catch (e) {
          console.warn("Sem dados de filia√ß√£o anterior ou formato antigo.");
        }

        el("search-results").style.display = "none";
      }
      async function savePac() {
        const btn = document.querySelector("#m-pac .btn-p");
        const txtOriginal = btn.innerText;

        if (!val("p-nome")) return showToast("Nome √© obrigat√≥rio", "erro");

        btn.innerText = "Salvando...";
        btn.disabled = true;

        // AGRUPA FILIA√á√ÉO NUM OBJETO
        const dadosFiliacao = {
          pai: val("p-pai"),
          tel_pai: val("p-tel-pai"),
          mae: val("p-mae"),
          tel_mae: val("p-tel-mae"),
        };

        try {
          const res = await req("/pacientes/salvar", "POST", {
            id: val("p-id"),
            nome: val("p-nome"),
            foto: val("p-foto-path"),
            cpf: val("p-cpf"),
            rg: val("p-rg"),
            nasc: val("p-nasc"),
            sexo: val("p-sexo"),
            tel: val("p-tel1"),
            email: val("p-email"),
            endereco: val("p-end"),
            conv: val("p-conv"),
            meds: val("p-meds"),
            obs: val("p-obs"),

            // Enviamos aqui o objeto novo. O backend vai salvar como JSON no banco.
            responsavel: dadosFiliacao,
            foto: val("p-foto-path"),
          });

          if (res && res.msg) {
            closeM("m-pac");
            loadPac("");
            showToast("‚úÖ Paciente Salvo!");
          } else if (res && res.erro) {
            alert("‚ö†Ô∏è " + res.erro);
          }
        } catch (e) {
          console.error(e);
          showToast("Erro ao salvar", "erro");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      async function loadAgenda() {
        const i = val("ag-ini"),
          f = val("ag-fim"),
          p = val("ag-filter-prof");
        const l = await req(`/agenda?inicio=${i}&fim=${f}&prof_id=${p}`);

        el("t-ag").innerHTML = (l || [])
          .map(
            (a) =>
              `<tr>
            <td>${a.data_hora_inicio.substring(
              8,
              10
            )}/${a.data_hora_inicio.substring(
                5,
                7
              )} <span style="color:var(--primary)">${a.data_hora_inicio.substring(
                11,
                16
              )}</span></td>
            <td><div style="font-weight:bold">${a.paciente}</div></td>
            <td>${a.profissional}</td>
            <td><span class="status-badge st-${a.status
              .toLowerCase()
              .replace(" ", "")}">${a.status}</span></td>
            <td style="text-align:right; white-space:nowrap">
                ${
                  a.status === "Finalizado"
                    ? `<button class="btn-icon" style="background:#607d8b" onclick="imprimirRecibo(${a.id})" title="Recibo PDF">üìÑ</button>`
                    : ""
                }
                <button class="btn-icon btn-s" style="background:#3B82F6" onclick='editAg(${escapeDados(
                  a
                )})' title="Editar">‚úèÔ∏è</button> 
                <button class="btn-icon btn-d" style="background:#EF4444" onclick="delAg(${
                  a.id
                })" title="Excluir">üóëÔ∏è</button>
            </td></tr>`
          )
          .join("");
        if (agendaTimelineVisible) loadAgendaTimeline();
      }
      function modAg() {
        el("m-ag").style.display = "flex";
        currentAgId = null; // Reseta para modo CRIA√á√ÉO

        // Carrega as listas
        fill("a-pac", "/pacientes");
        fill("a-prof", "/profissionais");
        fill("a-sala", "/auxiliares/salas");

        // --- LIMPEZA COMPLETA (O QUE FALTAVA) ---
        el("a-valor").value = "";
        el("a-dur").value = "30"; // Volta para o padr√£o
        el("a-sala").value = "";
        el("a-hora").value = "";

        // Define a data para hoje ou a data do filtro
        el("a-data").value =
          val("ag-ini") || new Date().toISOString().split("T")[0];
      }
      function editAg(a) {
        modAg(); // Abre o modal e dispara o carregamento das listas (fill)
        currentAgId = a.id;

        // O setTimeout √© necess√°rio para esperar as listas (Selects) carregarem
        setTimeout(() => {
          // 1. Carrega Paciente e Profissional
          el("a-pac").value = a.paciente_id;
          el("a-prof").value = a.profissional_id;

          // 2. Carrega a SALA (Isso √© o que faltava para fixar)
          if (a.sala_id) el("a-sala").value = a.sala_id;

          // 3. Carrega Valor e Dura√ß√£o (Tamb√©m √© importante)
          el("a-valor").value = a.valor || "";
          el("a-dur").value = a.duracao_minutos || 30;
        }, 300); // 300ms para garantir que o dropdown j√° existe

        // 4. Carrega Data e Hora
        const p = a.data_hora_inicio.split(" ");
        el("a-data").value = p[0];
        el("a-hora").value = p[1].substring(0, 5);
      }
      async function delAg(id) {
        if (confirm("Excluir?")) {
          await req("/agenda/deletar/" + id, "DELETE");
          loadAgenda();
          loadDash();
          if (calendar) calendar.refetchEvents();
        }
      }
      async function saveAg() {
        const btn = document.querySelector("#m-ag .btn-p");
        const txtOriginal = btn.innerText;

        const pid = val("a-pac");
        const prid = val("a-prof");
        const dt = val("a-data");
        const hr = val("a-hora");

        if (!pid || !prid || !dt || !hr)
          return showToast("Preencha tudo", "erro");

        btn.innerText = "Agendando...";
        btn.disabled = true;

        try {
          const resp = await req("/agenda/salvar", "POST", {
            id: currentAgId,
            paciente_id: pid,
            profissional_id: prid,
            data: dt,
            hora: hr,
            sala_id: val("a-sala"),
            duracao: val("a-dur"),
            valor: val("a-valor"),
          });

          if (resp && resp.msg === "Ok") {
            closeM("m-ag");
            loadAgenda();
            loadDash();
            if (calendar) calendar.refetchEvents();
            showToast("‚úÖ Agendado!");

            // L√≥gica do WhatsApp (s√≥ se for novo)
            if (!currentAgId) {
              const o = el("a-pac").options[el("a-pac").selectedIndex];
              if (o.dataset.tel && confirm("Enviar Whats de confirma√ß√£o?")) {
                const m = `Ol√° *${
                  o.text
                }*, seu agendamento foi confirmado para *${dt
                  .split("-")
                  .reverse()
                  .join("/")}* √†s *${hr}*!`;
                window.open(
                  `https://api.whatsapp.com/send?phone=55${o.dataset.tel.replace(
                    /\D/g,
                    ""
                  )}&text=${encodeURIComponent(m)}`,
                  "_blank"
                );
              }
            }
          } else if (resp && resp.erro) {
            alert("‚ö†Ô∏è " + resp.erro); // Ex: Hor√°rio indispon√≠vel
          }
        } catch (e) {
          console.error(e);
          showToast("Erro ao agendar", "erro");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      async function irParaAtendimento(agId, pacId, profId) {
        nav(
          "atendimento",
          document.querySelector("button[onclick*='atendimento']")
        );

        // Delay pequeno para garantir que a tela trocou antes de carregar os dados
        setTimeout(() => {
          startAtend(pacId, profId);
        }, 300);
      }
      function escapeDados(obj) {
        if (!obj) return "{}";
        // Transforma em string e troca aspas simples e duplas por c√≥digos HTML
        return JSON.stringify(obj)
          .replace(/'/g, "&#39;")
          .replace(/"/g, "&quot;");
      }
      const hojeFin = new Date();
      setTimeout(() => {
        if (el("fin-mes")) el("fin-mes").value = hojeFin.getMonth() + 1;
        if (el("fin-ano")) el("fin-ano").value = hojeFin.getFullYear();
      }, 500);

      // --- FUN√á√ÉO 1: TROCAR ABAS ---
      function tabFin(t, b) {
        curFin = t;
        if (b) {
          document
            .querySelectorAll(".tab")
            .forEach((x) => x.classList.remove("active"));
          b.classList.add("active");
        }
        loadFin();
      }
      let currentHistId = null; // Para saber qual ID estamos editando

      async function confirmarRetificacao() {
        const texto = val("txt-retificacao");
        if (!texto) return alert("Escreva a justificativa.");

        if (
          !confirm(
            "Confirma a grava√ß√£o desta nota de retifica√ß√£o?\nEla ficar√° vis√≠vel permanentemente."
          )
        )
          return;

        const res = await req("/prontuario/retificar", "POST", {
          id: currentHistId,
          justificativa: texto,
        });

        if (res && res.msg) {
          showToast("‚úÖ Retificado com sucesso!");
          el("area-retificacao").style.display = "none";
          el("txt-retificacao").value = "";
          closeM("m-hist-detalhe");
          // Recarrega a lista para atualizar
          const pid = val("atend-pac-sel"); // Pega ID do paciente atual
          if (pid) loadHistoricoVisual(pid);
        }
      }

      // --- FUN√á√ÉO 2: CARREGAR DADOS E CALCULAR TOTAIS ---
      async function loadFin() {
        const mes = val("fin-mes");
        const ano = val("fin-ano");

        // Feedback visual
        el("t-fin").innerHTML =
          '<tr><td colspan="7" style="text-align:center; padding:20px">‚è≥ Calculando dados...</td></tr>';

        // Busca dados
        const lista = await req(`/financeiro/${curFin}?mes=${mes}&ano=${ano}`);
        if (!lista) return;

        // --- C√ÅLCULO DE KPIS (TOTAIS) ---
        let pago = 0,
          pendente = 0,
          vencido = 0,
          total = 0;
        const hojeStr = new Date().toISOString().split("T")[0];

        lista.forEach((i) => {
          const valor = parseFloat(i.valor_total || i.valor);

          if (curFin === "caixa") {
            if (i.tipo === "Entrada") total += valor;
            else total -= valor;
            pago += valor;
          } else {
            const valorPago = parseFloat(i.valor_pago || 0);
            if (i.status === "Pago" || i.status === "Recebido") {
              pago += valorPago;
            } else {
              pendente += valor - valorPago;
              if (i.data_vencimento < hojeStr) vencido += valor - valorPago;
            }
            total += valor;
          }
        });

        // --- ATUALIZA CARDS ---
        if (el("fin-total-pago")) {
          if (curFin === "caixa") {
            el("fin-total-pago").innerText = moeda(pago);
            el("fin-total-pago").parentElement.querySelector("h4").innerText =
              "Movimenta√ß√£o";
            el("fin-total-pendente").innerText = "---";
            el("fin-total-vencido").innerText = "---";
            el("fin-total-geral").innerText = moeda(total);
            el("fin-total-geral").style.color =
              total >= 0 ? "#10B981" : "#EF4444";
            el("fin-total-geral").parentElement.querySelector("h4").innerText =
              "Saldo do Per√≠odo";
          } else {
            el("fin-total-pago").innerText = moeda(pago);
            el("fin-total-pago").parentElement.querySelector("h4").innerText =
              curFin === "receber" ? "Recebido" : "Pago";
            el("fin-total-pendente").innerText = moeda(pendente);
            el("fin-total-vencido").innerText = moeda(vencido);
            el("fin-total-geral").innerText = moeda(total);
            el("fin-total-geral").style.color = "#3B82F6";
            el("fin-total-geral").parentElement.querySelector("h4").innerText =
              "Total Previsto";
          }
        }

        // --- GERA TABELA ---
        let cabecalho = "";
        let corpo = "";

        if (curFin == "caixa") {
          cabecalho = `<tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Usu√°rio</th><th style="text-align:right">Valor</th></tr>`;
          corpo = lista
            .map((i) => {
              const corValor = i.tipo === "Entrada" ? "#10B981" : "#EF4444";
              const sinal = i.tipo === "Entrada" ? "+" : "-";
              return `<tr><td>${fmtDataHora(
                i.data_hora
              )}</td><td><span class="status-badge" style="background:${
                i.tipo === "Entrada" ? "#D1FAE5" : "#FEE2E2"
              }; color:${corValor}">${i.tipo}</span></td><td>${
                i.descricao
              }</td><td style="color:var(--muted); font-size:0.8rem">${
                i.usuario || "-"
              }</td><td style="text-align:right; font-weight:bold; color:${corValor}">${sinal} ${moeda(
                i.valor
              )}</td></tr>`;
            })
            .join("");
        } else {
          const labelPessoa = curFin === "receber" ? "Paciente" : "Fornecedor";
          cabecalho = `<tr><th>Vencimento</th><th>${labelPessoa}</th><th>Descri√ß√£o</th><th>Categoria</th><th>Status</th><th style="text-align:right">Valor</th><th>A√ß√£o</th></tr>`;
          corpo = lista
            .map((i) => {
              const isVencido =
                i.status !== "Pago" &&
                i.status !== "Recebido" &&
                i.data_vencimento < hojeStr;
              let corStatus = "#3B82F6";
              if (i.status === "Pago" || i.status === "Recebido")
                corStatus = "#10B981";
              if (isVencido) corStatus = "#EF4444";
              let badgeText = i.status;
              if (isVencido) badgeText = "ATRASADO";
              const styleRow = isVencido
                ? "background:rgba(239, 68, 68, 0.1)"
                : "";

              return `<tr style="${styleRow}"><td style="font-weight:${
                isVencido ? "bold" : "normal"
              }; color:${isVencido ? "#EF4444" : "var(--text)"}">${fmtData(
                i.data_vencimento
              )}</td><td><strong>${
                i.pessoa || i.descricao
              }</strong></td><td style="color:var(--muted)">${
                i.descricao
              }</td><td><span class="status-badge" style="background:var(--bg-input)">${
                i.categoria || "-"
              }</span></td><td><span class="status-badge" style="background:${corStatus}; color:white">${badgeText}</span>${
                i.parcelas > 1
                  ? `<small style="margin-left:5px">(${i.parcela_atual}/${i.parcelas})</small>`
                  : ""
              }</td><td style="text-align:right; font-weight:bold">${moeda(
                i.valor_total
              )}</td><td>${
                i.status != "Pago" && i.status != "Recebido"
                  ? `<button class="btn btn-s" style="color:#10B981; border:1px solid #10B981" onclick="baixa(${i.id},${i.valor_total})" title="Baixar/Pagar">üí≤ Baixar</button>`
                  : `<span style="color:#10B981">‚úî Conclu√≠do</span>`
              }</td></tr>`;
            })
            .join("");
        }

        if (el("t-fin-head")) el("t-fin-head").innerHTML = cabecalho;
        el("t-fin").innerHTML =
          corpo ||
          '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--muted)">Nenhum lan√ßamento neste per√≠odo.</td></tr>';
      }

      // --- FUN√á√ÉO 3: ABRIR MODAL (Estava escondida antes) ---
      function modFin() {
        el("m-fin").style.display = "flex";
        ["f-desc", "f-val", "f-cat", "f-cc", "f-forn"].forEach((id) => {
          if (el(id)) el(id).value = "";
        });
        el("f-parc").value = "1";
        el("f-venc").value = new Date().toISOString().split("T")[0];
        fill("f-pac", "/pacientes");
        toggleFin();
      }

      // --- FUN√á√ÉO 4: ALTERNAR CAMPOS DO MODAL ---
      function toggleFin() {
        const t = val("f-tipo");
        el("d-pac").style.display = t == "receber" ? "block" : "none";
        el("d-forn").style.display = t == "pagar" ? "block" : "none";
      }
      function baixa(id, v) {
        el("m-baixa").style.display = "flex";
        el("b-id").value = id;
        el("b-val").value = v;
      }

      async function confBaixa() {
        if (
          await req("/financeiro/baixar", "POST", {
            id: val("b-id"),
            valor_pago: val("b-val"),
            tipo: curFin,
          })
        ) {
          closeM("m-baixa");
          loadFin();
          loadDash();
        }
      }
      async function saveFin() {
        const btn = document.querySelector("#m-fin .btn-p");
        const txtOriginal = btn.innerText;

        // Valida√ß√£o antes de bloquear
        if (
          !val("f-desc") ||
          !val("f-val") ||
          !val("f-venc") ||
          !val("f-cat")
        ) {
          return showToast(
            "Preencha: Descri√ß√£o, Valor, Vencimento e Categoria",
            "erro"
          );
        }

        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
          const tipo = val("f-tipo");
          const payload = {
            tipo: tipo,
            desc: val("f-desc"),
            valor: val("f-val"),
            venc: val("f-venc"),
            cat: val("f-cat"),
            cc: val("f-cc"),
            forma: val("f-forma"),
            parc: val("f-parc") || 1,
            paciente_id: tipo === "receber" ? val("f-pac") : null,
            fornecedor: tipo === "pagar" ? val("f-forn") : null,
          };

          const res = await req("/financeiro/salvar", "POST", payload);

          if (res && res.msg === "Ok") {
            showToast("‚úÖ Lan√ßamento salvo!");
            closeM("m-fin");
            loadFin();
            loadDash();
          } else if (res && res.erro) {
            alert("‚ö†Ô∏è " + res.erro);
          }
        } catch (e) {
          console.error(e);
          alert("Erro de sistema: " + e);
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      async function imprimirRecibo(id) {
        const btn = event.target.closest("button"); // Garante pegar o bot√£o mesmo se clicar no √≠cone
        const iconOriginal = btn.innerHTML;

        try {
          btn.innerHTML = "‚è≥";
          btn.disabled = true;

          // 1. Baixa o PDF para a mem√≥ria do navegador
          const res = await fetch(API + "/recibo/" + id, {
            credentials: "include",
          });

          if (res.status === 401) {
            alert("Sess√£o expirada.");
            return;
          }
          if (!res.ok) {
            alert("Erro ao gerar recibo.");
            return;
          }

          const blob = await res.blob();

          // 2. Converte para Base64 para poder enviar ao Python
          var reader = new FileReader();
          reader.readAsDataURL(blob);

          reader.onloadend = async function () {
            // Remove o cabe√ßalho "data:application/pdf;base64,"
            var base64data = reader.result.split(",")[1];

            // 3. Chama o Python para abrir a janela de Salvar
            // Verifica se o pywebview est√° ativo
            if (window.pywebview && window.pywebview.api) {
              const resultado = await window.pywebview.api.salvar_pdf(
                `Recibo_${id}.pdf`,
                base64data
              );
              if (resultado !== "Cancelado") {
                showToast(resultado);
              }
            } else {
              // Fallback caso esteja testando no navegador comum
              console.warn(
                "PyWebview n√£o detectado. Usando download navegador."
              );
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = `Recibo_${id}.pdf`;
              document.body.appendChild(link);
              link.click();
            }

            // Restaura o bot√£o
            btn.innerHTML = iconOriginal;
            btn.disabled = false;
          };
        } catch (e) {
          console.error(e);
          alert("Erro de conex√£o.");
          btn.innerHTML = iconOriginal;
          btn.disabled = false;
        }
      }

      let relChartInstance = null; // Vari√°vel global para o gr√°fico

      async function gerarRel() {
        const t = val("rel-tipo"),
          i = val("rel-ini"),
          f = val("rel-fim");
        const btn = document.querySelector("button[onclick='gerarRel()']");
        const txtOriginal = btn.innerText;
        btn.innerText = "‚è≥ Gerando...";
        btn.disabled = true;

        try {
          const dados = await req("/relatorios/gerar", "POST", {
            tipo: t,
            inicio: i,
            fim: f,
          });
          el("print-title").innerText =
            el("rel-tipo").options[el("rel-tipo").selectedIndex].text;
          el("print-period").innerText = `Per√≠odo: ${i
            .split("-")
            .reverse()
            .join("/")} a ${f.split("-").reverse().join("/")}`;
          el("rel-kpi-area").innerHTML = "";
          const thead = el("rel-tab").querySelector("thead");
          const tbody = el("rel-tab").querySelector("tbody");
          thead.innerHTML = "";
          tbody.innerHTML = "";
          el("rel-chart-container").style.display = "none";

          if (!dados || !dados.lista || dados.lista.length === 0) {
            tbody.innerHTML =
              "<tr><td colspan='5' style='text-align:center; padding:20px'>Nenhum dado encontrado.</td></tr>";
            return;
          }

          const lista = dados.lista;
          const res = dados.resumo || {};
          let head = "",
            body = "";

          if (t === "financeiro") {
            renderKPIs([
              { label: "Receitas", val: moeda(res.receita), color: "#10B981" },
              { label: "Despesas", val: moeda(res.despesa), color: "#EF4444" },
              {
                label: "Saldo L√≠quido",
                val: moeda(res.saldo),
                color: res.saldo >= 0 ? "#3B82F6" : "#EF4444",
              },
              {
                label: "Margem",
                val:
                  res.receita > 0
                    ? Math.round((res.saldo / res.receita) * 100) + "%"
                    : "0%",
                color: "#F59E0B",
              },
            ]);
            renderChart(
              "bar",
              ["Receita", "Despesa"],
              [res.receita, res.despesa],
              ["#10B981", "#EF4444"],
              "Balan√ßo Financeiro"
            );
            head = `<tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Tipo</th><th style="text-align:right">Valor</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr style="border-left: 4px solid ${
                    x.tipo === "Receita" ? "#10B981" : "#EF4444"
                  }"><td>${fmtData(x.data)}</td><td>${
                    x.descricao
                  }</td><td><span class="status-badge" style="background:var(--bg-input)">${
                    x.categoria
                  }</span></td><td>${
                    x.tipo
                  }</td><td style="text-align:right; font-weight:bold; color:${
                    x.tipo === "Receita" ? "#10B981" : "#EF4444"
                  }">${moeda(x.valor)}</td></tr>`
              )
              .join("");
          } else if (t === "repasse") {
            renderKPIs([
              {
                label: "Faturamento Bruto",
                val: moeda(res.total_produzido),
                color: "#3B82F6",
              },
              {
                label: "Total a Repassar",
                val: moeda(res.total_repasse),
                color: "#EF4444",
              },
              {
                label: "Lucro Cl√≠nica",
                val: moeda(res.lucro_bruto),
                color: "#10B981",
              },
            ]);
            head = `<tr><th>Profissional</th><th>Comiss√£o (%)</th><th>Qtd. Atend.</th><th>Produzido</th><th style="text-align:right">A Pagar (Repasse)</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td><strong>${x.nome}</strong></td><td>${
                    x.comissao
                  }%</td><td>${x.qtd_atendimentos}</td><td>${moeda(
                    x.total_produzido
                  )}</td><td style="text-align:right; color:#EF4444; font-weight:bold">${moeda(
                    x.valor_repasse
                  )}</td></tr>`
              )
              .join("");
          } else if (t === "fechamento") {
            renderKPIs([
              {
                label: "Total Entradas",
                val: moeda(res.total_entradas),
                color: "#10B981",
              },
              {
                label: "Total Sa√≠das",
                val: moeda(res.total_saidas),
                color: "#EF4444",
              },
              {
                label: "Saldo do Dia",
                val: moeda(res.saldo_periodo),
                color: res.saldo_periodo >= 0 ? "#3B82F6" : "#EF4444",
              },
            ]);
            renderChart(
              "pie",
              lista.map((x) => x.forma_pagamento || "Outros"),
              lista.map((x) => x.total),
              ["#10B981", "#3B82F6", "#F59E0B", "#8B5CF6", "#EF4444"],
              "Entradas por Forma de Pagamento"
            );
            head = `<tr><th>Forma de Pagamento</th><th style="text-align:right">Total Arrecadado</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td>${
                    x.forma_pagamento || "N√£o especificado"
                  }</td><td style="text-align:right; font-weight:bold">${moeda(
                    x.total
                  )}</td></tr>`
              )
              .join("");
          } else if (t === "agendamentos") {
            const ticketMedio =
              res.total_qtd > 0 ? res.total_valor / res.total_qtd : 0;
            renderKPIs([
              {
                label: "Total Agendamentos",
                val: res.total_qtd,
                color: "#3B82F6",
              },
              {
                label: "Valor Estimado",
                val: moeda(res.total_valor),
                color: "#10B981",
              },
              {
                label: "Ticket M√©dio",
                val: moeda(ticketMedio),
                color: "#F59E0B",
              },
            ]);
            renderChart(
              "doughnut",
              res.labels,
              res.data,
              ["#F59E0B", "#3B82F6", "#10B981", "#EF4444", "#8B5CF6"],
              "Status dos Agendamentos"
            );
            head = `<tr><th>Data/Hora</th><th>Paciente</th><th>Profissional</th><th>Status</th><th style="text-align:right">Valor</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td>${fmtDataHora(x.data_hora_inicio)}</td><td>${
                    x.paciente
                  }</td><td>${
                    x.profissional
                  }</td><td><span class="status-badge st-${x.status
                    .toLowerCase()
                    .replace(" ", "")}">${
                    x.status
                  }</span></td><td style="text-align:right">${moeda(
                    x.valor
                  )}</td></tr>`
              )
              .join("");
          } else if (t === "profissionais") {
            renderKPIs([
              {
                label: "Top Performance",
                val: lista.length > 0 ? lista[0].profissional : "---",
                color: "#8B5CF6",
              },
              {
                label: "Total Atendimentos",
                val: lista.reduce((a, b) => a + b.atendimentos, 0),
                color: "#3B82F6",
              },
            ]);
            renderChart(
              "bar",
              res.labels,
              res.data_fat,
              "#8B5CF6",
              "Faturamento Estimado por M√©dico (R$)"
            );
            head = `<tr><th>Profissional</th><th>Agendados</th><th>Realizados</th><th style="text-align:right">Fat. Estimado</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td><strong>${x.profissional}</strong></td><td>${
                    x.atendimentos
                  }</td><td>${
                    x.finalizados
                  }</td><td style="text-align:right; color:#10B981">${moeda(
                    x.faturamento_est
                  )}</td></tr>`
              )
              .join("");
          } else if (t === "convenios") {
            renderChart(
              "pie",
              res.labels,
              res.data,
              ["#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#EC4899"],
              "Distribui√ß√£o por Conv√™nio"
            );
            head = `<tr><th>Conv√™nio</th><th style="text-align:right">Total Atendimentos</th></tr>`;
            body = lista
              .map(
                (x) =>
                  `<tr><td>${x.convenio}</td><td style="text-align:right">${x.atendimentos}</td></tr>`
              )
              .join("");
          } else {
            head = `<tr>${Object.keys(lista[0])
              .map(
                (k) =>
                  `<th style="text-transform:capitalize">${k.replace(
                    "_",
                    " "
                  )}</th>`
              )
              .join("")}</tr>`;
            body = lista
              .map(
                (r) =>
                  `<tr>${Object.values(r)
                    .map((v) => `<td>${v}</td>`)
                    .join("")}</tr>`
              )
              .join("");
          }

          thead.innerHTML = head;
          tbody.innerHTML = body;
        } catch (e) {
          console.error(e);
          showToast("Erro ao gerar relat√≥rio", "erro");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }

        let alteracoesMatriz = {}; // Guarda o que mudou: 'procID_convID': valor

        function registrarAlteracao(procId, convId, input) {
          const chave = `${procId}_${convId}`;
          alteracoesMatriz[chave] = {
            proc_id: procId,
            conv_id: convId,
            valor: input.value,
          };
          input.classList.add("input-changed");
        }

        // Funcionalidade "Excel": Setas do teclado navegam
        function navegarMatriz(e, input) {
          const td = input.parentElement;
          const tr = td.parentElement;
          const colIndex = Array.from(tr.children).indexOf(td);

          let target = null;

          if (e.key === "ArrowDown") {
            const nextRow = tr.nextElementSibling;
            if (nextRow)
              target = nextRow.children[colIndex].querySelector("input");
          } else if (e.key === "ArrowUp") {
            const prevRow = tr.previousElementSibling;
            if (prevRow)
              target = prevRow.children[colIndex].querySelector("input");
          }

          if (target) {
            e.preventDefault();
            target.focus();
          }
        }
        let pontosMapaCorporal = [];

        function adicionarPontoMapa(event) {
          // Pega as coordenadas relativas ao container da imagem
          const rect = event.target.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          // Pergunta o que √©
          const nota = prompt(
            "O que h√° nesta regi√£o? (Ex: Dor, Ferida, Mancha)"
          );
          if (!nota) return;

          // Salva no array
          const ponto = { x: x, y: y, nota: nota };
          pontosMapaCorporal.push(ponto);

          // Renderiza na tela
          renderizarPonto(ponto);
        }

        function renderizarPonto(p) {
          const container = document.getElementById("body-map-container");

          const div = document.createElement("div");
          div.className = "map-point";
          div.style.position = "absolute";
          div.style.left = p.x - 5 + "px"; // -5 para centralizar o ponto
          div.style.top = p.y - 5 + "px";
          div.style.width = "10px";
          div.style.height = "10px";
          div.style.backgroundColor = "#ef4444"; // Vermelho
          div.style.borderRadius = "50%";
          div.style.boxShadow = "0 0 5px rgba(255,0,0,0.8)";
          div.style.cursor = "pointer";
          div.title = p.nota; // Tooltip nativo

          // Clique no ponto para remover
          div.onclick = function (e) {
            e.stopPropagation(); // N√£o criar outro ponto
            if (confirm('Remover esta marca√ß√£o: "' + p.nota + '"?')) {
              container.removeChild(div);
              pontosMapaCorporal = pontosMapaCorporal.filter(
                (item) => item !== p
              );
            }
          };

          container.appendChild(div);
        }

        function limparMapaCorporal() {
          if (confirm("Limpar todas as marca√ß√µes do corpo?")) {
            pontosMapaCorporal = [];
            document.getElementById("body-map-container").innerHTML = "";
          }
        }

        async function salvarMatriz() {
          const lista = Object.values(alteracoesMatriz);
          if (lista.length === 0)
            return showToast("Nenhuma altera√ß√£o para salvar.");

          const btn = document.querySelector("#m-matriz .btn-p");
          btn.innerText = "Salvando...";
          btn.disabled = true;

          const res = await req("/matriz_precos/salvar", "POST", {
            alteracoes: lista,
          });

          if (res && res.msg) {
            showToast(res.msg);
            alteracoesMatriz = {}; // Limpa mem√≥ria
            // Remove a classe laranja dos inputs salvos
            document
              .querySelectorAll(".input-changed")
              .forEach((i) => i.classList.remove("input-changed"));
          } else {
            alert("Erro ao salvar");
          }

          btn.innerText = "üíæ SALVAR ALTERA√á√ïES";
          btn.disabled = false;
        }
      }
      async function uploadFotoPaciente() {
        const file = el("p-foto-upload").files[0];
        if (file) {
          showToast("Enviando foto...");
          const ret = await uploadGenerico(file);
          if (ret) {
            el("p-foto-path").value = ret.arquivo;
            // CORRE√á√ÉO: Removido o "API +" pois a rota /uploads √© raiz
            el("p-foto-preview").src = ret.url;
          }
        }
      }

      // --- L√ìGICA AVAN√áADA DE PROCEDIMENTOS ---
      async function abrirProcDetalhe(id) {
        el("m-proc-detalhe").style.display = "flex";
        el("px-id").value = id || "";

        // Se for edi√ß√£o, busca dados. Se for novo, limpa tudo.
        if (id) {
          const res = await req("/procedimentos/detalhes/" + id);
          const d = res.dados;
          el("px-nome").value = d.nome;
          el("px-codigo").value = d.codigo_tuss || "";
          el("px-tempo").value = d.tempo_padrao || 30;
          el("px-valor").value = d.valor_padrao || 0;
          el("px-repasse").value = d.repasse || 0;
          renderTabelaPrecos(res.precos);
        } else {
          el("px-nome").value = "";
          el("px-codigo").value = "";
          el("px-tempo").value = "30";
          el("px-valor").value = "";
          el("px-repasse").value = "";
          // Carrega lista de conv√™nios vazia para preencher
          const convs = await req("/convenios");
          const listaVazia = convs.map((c) => ({
            convenio_id: c.id,
            convenio_nome: c.nome,
            valor: "",
          }));
          renderTabelaPrecos(listaVazia);
        }
      }

      function renderTabelaPrecos(lista) {
        el("px-lista-precos").innerHTML = lista
          .map(
            (p) => `
        <tr>
            <td style="padding:5px">${p.convenio_nome}</td>
            <td style="padding:5px">
                <input type="number" step="0.01" class="input-preco-conv" 
                       data-cid="${p.convenio_id}" 
                       value="${p.valor || ""}" 
                       placeholder="0.00"
                       style="margin:0; background:#222; border:1px solid #555">
            </td>
        </tr>
    `
          )
          .join("");
      }

      async function saveProcCompleto() {
        const precos = [];
        // Varre os inputs da tabela para pegar os pre√ßos digitados
        document.querySelectorAll(".input-preco-conv").forEach((i) => {
          if (i.value) {
            precos.push({ convenio_id: i.dataset.cid, valor: i.value });
          }
        });

        const body = {
          id: val("px-id"),
          nome: val("px-nome"),
          codigo: val("px-codigo"),
          tempo: val("px-tempo"),
          valor: val("px-valor"),
          repasse: val("px-repasse"),
          precos_lista: precos,
        };

        if (!body.nome) return showToast("Nome √© obrigat√≥rio", "erro");

        const res = await req("/procedimentos/salvar_completo", "POST", body);
        if (res && res.msg) {
          showToast(res.msg);
          closeM("m-proc-detalhe");
          loadAux("procedimentos"); // Recarrega a lista
        }
      }

      // --- FUN√á√ïES AUXILIARES VISUAIS ---

      function renderKPIs(kpis) {
        const area = el("rel-kpi-area");
        area.innerHTML = kpis
          .map(
            (k) => `
        <div class="card" style="padding:15px; text-align:center; border-left:4px solid ${k.color}; margin-bottom:0">
            <h4 style="color:var(--muted); font-size:0.85rem; margin-bottom:5px">${k.label}</h4>
            <h2 style="color:${k.color}; font-size:1.4rem; margin:0">${k.val}</h2>
        </div>
    `
          )
          .join("");
      }

      function renderChart(type, labels, data, colors, title) {
        const ctx = el("rel-chart").getContext("2d");
        el("rel-chart-container").style.display = "block";

        if (relChartInstance) relChartInstance.destroy();

        relChartInstance = new Chart(ctx, {
          type: type,
          data: {
            labels: labels,
            datasets: [
              {
                label: title,
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              title: { display: true, text: title, color: "#fff" },
            },
          },
        });
      }
      async function uploadFotoProfissional() {
        const file = el("pr-foto-upload").files[0];
        if (file) {
          showToast("Enviando foto...");
          const ret = await uploadGenerico(file);
          if (ret) {
            el("pr-foto-path").value = ret.arquivo;
            el("pr-foto-preview").src = ret.url;
          }
        }
      }

      async function exportarCSV() {
        const t = val("rel-tipo");
        const btn = document.querySelector("button[onclick='exportarCSV()']");
        const originalText = btn.innerText;

        btn.innerText = "‚è≥ Gerando...";
        btn.disabled = true;

        try {
          // 1. Busca os dados do relat√≥rio
          const response = await fetch(`${API}/exportar/${t}`, {
            method: "GET",
            credentials: "include",
          });

          if (response.status === 401) {
            alert("Sess√£o expirada.");
            return;
          }

          const conteudo = await response.text();
          const nomeArquivo = `relatorio_${t}_${
            new Date().toISOString().split("T")[0]
          }.csv`;

          // 2. Tenta usar a janela do Windows (Python)
          if (window.pywebview && window.pywebview.api) {
            // Chama a fun√ß√£o que criamos no passo 1
            const resultado = await window.pywebview.api.salvar_arquivo(
              nomeArquivo,
              conteudo
            );

            if (resultado !== "Cancelado") {
              showToast(resultado); // Mostra notifica√ß√£o verde
            }
          } else {
            // Se cair aqui, √© porque o Python n√£o respondeu, ent√£o baixa direto (Fallback)
            console.warn("PyWebview n√£o detectado, usando download normal.");
            const blob = new Blob([conteudo], {
              type: "text/csv;charset=utf-8;",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error(error);
          alert("Erro: " + error.message);
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }
      async function loadCockpit() {
        // Pega as datas dos inputs
        const ini = val("mc-ini") || new Date().toISOString().split("T")[0];
        const fim = val("mc-fim") || new Date().toISOString().split("T")[0];

        // Carrega filtro de m√©dicos se necess√°rio
        if (el("mc-filtro-prof").options.length <= 1) {
          fill("mc-filtro-prof", "/profissionais", "Todos Profissionais");
        }

        // Busca no backend usando o intervalo de datas
        const lista = await req(`/agenda?inicio=${ini}&fim=${fim}`);
        const espera = await req("/sala_espera"); // Para contagem em tempo real

        if (!lista) return;

        // --- C√ÅLCULO DOS CARDS DE TOPO ---
        // Total: Tudo que n√£o foi cancelado
        const totalPeriodo = lista.filter(
          (a) => a.status !== "Cancelado"
        ).length;

        // Finalizados: Status Finalizado
        const totalFinalizados = lista.filter(
          (a) => a.status === "Finalizado"
        ).length;

        // Aguardando: Soma de Agendado, Confirmado, Em Espera, Em Atendimento
        const totalAguardando = lista.filter((a) =>
          ["Agendado", "Confirmado", "Em Espera", "Em Atendimento"].includes(
            a.status
          )
        ).length;

        el("mc-total").innerText = totalPeriodo;
        el("mc-atendidos").innerText = totalFinalizados;
        el("mc-espera").innerText = totalAguardando;

        // --- FILTRAGEM VISUAL ---
        let displayList = lista;

        // 1. Filtro de M√©dico
        const profFiltro = val("mc-filtro-prof");
        if (profFiltro) {
          displayList = displayList.filter(
            (a) => a.profissional_id == profFiltro
          );
        }

        // 2. Filtro de Status (Dropdown)
        const statusFiltro = val("mc-filtro-st");
        if (statusFiltro === "espera") {
          displayList = displayList.filter((a) =>
            ["Agendado", "Confirmado", "Em Espera", "Em Atendimento"].includes(
              a.status
            )
          );
        } else if (statusFiltro === "finalizados") {
          displayList = displayList.filter((a) => a.status === "Finalizado");
        } else {
          // Se for "todos", removemos apenas os cancelados para n√£o poluir
          displayList = displayList.filter((a) => a.status !== "Cancelado");
        }

        // Ordena√ß√£o: Em Atendimento > Em Espera > Confirmado > Finalizado > Data/Hora
        const pesoSt = {
          "Em Atendimento": 1,
          "Em Espera": 2,
          Confirmado: 3,
          Agendado: 4,
          Finalizado: 5,
        };
        displayList.sort((a, b) => {
          const pesoA = pesoSt[a.status] || 9;
          const pesoB = pesoSt[b.status] || 9;
          if (pesoA !== pesoB) return pesoA - pesoB;
          return a.data_hora_inicio.localeCompare(b.data_hora_inicio);
        });

        const container = el("mc-lista");

        if (displayList.length === 0) {
          container.innerHTML = `
            <div style="text-align:center; padding:50px; color:var(--muted); border:2px dashed var(--border); border-radius:8px; margin-top:20px">
                <div style="font-size:3rem; margin-bottom:10px">üì≠</div>
                <p>Nenhum atendimento encontrado neste per√≠odo com estes filtros.</p>
            </div>`;
          return;
        }

        container.innerHTML = displayList
          .map((a) => {
            const dataFmt =
              a.data_hora_inicio.substring(8, 10) +
              "/" +
              a.data_hora_inicio.substring(5, 7);
            const horaFmt = a.data_hora_inicio.substring(11, 16);

            let classeBorda = "",
              btnAcao = "",
              iconeSt = "üìÖ";

            if (a.status === "Em Espera") {
              classeBorda = "status-wait";
              iconeSt = "‚è≥";
              btnAcao = `<button class="btn btn-p" onclick="iniciarDireto(${a.id}, ${a.paciente_id}, ${a.profissional_id})">ü©∫ CHAMAR</button>`;
            } else if (a.status === "Em Atendimento") {
              classeBorda = "status-active";
              iconeSt = "‚ñ∂Ô∏è";
              btnAcao = `<button class="btn btn-i" onclick="iniciarDireto(${a.id}, ${a.paciente_id}, ${a.profissional_id})">ABRIR PRONTU√ÅRIO</button>`;
            } else if (a.status === "Finalizado") {
              classeBorda = "status-done";
              iconeSt = "‚úÖ";
              btnAcao = `<button class="btn btn-s" onclick="verHistoricoPaciente(${a.paciente_id})">üìú Ver Hist√≥rico</button>`;
            } else {
              btnAcao = `<button class="btn btn-s" style="border:1px solid var(--primary); color:var(--primary)" onclick="iniciarDireto(${a.id}, ${a.paciente_id}, ${a.profissional_id})">Iniciar</button>`;
            }

            // Tenta pegar foto, sen√£o usa placeholder
            const fotoUrl = a.paciente_foto
              ? "/uploads/" + a.paciente_foto
              : "https://cdn-icons-png.flaticon.com/512/847/847969.png";

            return `
        <div class="patient-row ${classeBorda}">
            <div class="p-time">
                <div style="font-size:0.75rem; color:var(--muted)">${dataFmt}</div>
                <div>${horaFmt}</div>
            </div>
            <div class="paciente-foto-wrapper" style="width:40px; height:40px; margin:0 15px 0 0; border-width:1px">
                 <img src="${fotoUrl}">
            </div>
            <div class="p-info">
                <span class="p-name">${a.paciente}</span>
                <div class="p-detail">üë®‚Äç‚öïÔ∏è ${a.profissional} ‚Ä¢ ${
              a.tipo || "Consulta"
            }</div>
                <div class="p-badges">
                    <span class="p-tag">${iconeSt} ${a.status}</span>
                </div>
            </div>
            <div style="text-align:right">${btnAcao}</div>
        </div>`;
          })
          .join("");
      }

      // Fun√ß√£o extra para clicar nos cards e filtrar r√°pido
      function setFiltroRapido(tipo) {
        el("mc-filtro-st").value = tipo;
        loadCockpit();
      }

      // A√ß√µes dos Bot√µes
      async function iniciarDireto(agId, pacId, profId) {
        // Chama startAtend passando os IDs diretamente, sem depender do <select> visual
        await startAtend(pacId, profId);
      }

      // ATEN√á√ÉO: Substitua a fun√ß√£o startAtend inteira por esta:
      async function startAtend(pacIdOverride = null, profIdOverride = null) {
        // 1. Tenta pegar do argumento ou do select
        let pid = pacIdOverride || val("atend-pac-sel");
        let pr = profIdOverride || val("at-prof");

        if (!pid) return showToast("Erro: Paciente n√£o identificado", "erro");

        // 2. Avisa o backend (Muda status para Em Atendimento)
        await req(
          "/agenda/iniciar_atendimento_paciente",
          "POST",
          { id: pid, prof_id: pr },
          true
        );

        // 3. Carrega dados do Paciente
        // Nota: Como n√£o temos o objeto completo aqui, buscamos na API
        const pacientes = await req("/pacientes?filtro=");
        const paciente = pacientes.find((p) => p.id == pid);

        if (paciente) {
          el("atend-pac-name").innerText = "Paciente: " + paciente.nome;
          el("at-alergias").value = paciente.alergias || "";
          el("at-meds-uso").value =
            paciente.medicamentos_em_uso || "Nada consta";

          // Garante que o select oculto tenha o valor correto (para o salvamento funcionar depois)
          if (el("atend-pac-sel")) {
            // Se a op√ß√£o n√£o existir no select, cria ela temporariamente
            if (!el("atend-pac-sel").querySelector(`option[value='${pid}']`)) {
              const opt = document.createElement("option");
              opt.value = pid;
              opt.text = paciente.nome;
              el("atend-pac-sel").add(opt);
            }
            el("atend-pac-sel").value = pid;
          }
        }

        if (pr && el("at-prof")) el("at-prof").value = pr;

        // 4. Limpeza de Campos
        [
          "at-peso",
          "at-altura",
          "at-pa",
          "at-temp",
          "at-sat",
          "at-pres",
          "at-exm",
          "atend-cid",
          "at-qp",
          "at-s",
          "at-o",
          "at-a",
          "at-p",
          "at-conduta",
          "at-retorno",
        ].forEach((i) => {
          if (el(i)) el(i).value = "";
        });

        anexosAtuais = [];
        renderAnexos();

        // 5. TROCA A TELA (Esconde Cockpit, Mostra Prontu√°rio)
        el("atend-sel-area").style.display = "none";
        el("atend-main").style.display = "block";

        // 6. Carrega hist√≥rico lateral
        loadHistoricoVisual(pid);
      }

      async function retomarAtendimento(agId, pacId, profId) {
        iniciarDireto(agId, pacId, profId);
      }

      function exportarListaAtendimentos() {
        const linhas = document.querySelectorAll(".patient-row");
        let csv = "Hora;Paciente;Status;Medico\n";

        linhas.forEach((row) => {
          if (row.style.display !== "none") {
            const hora = row.querySelector(".p-time").innerText;
            const nome = row.querySelector(".p-name").innerText;
            const status = row.querySelector(".p-tag").innerText;
            const detail =
              row.querySelector(".p-detail").innerText.split("‚Ä¢")[1] || "";
            csv += `${hora};${nome};${status};${detail.trim()}\n`;
          }
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "lista_atendimentos_hoje.csv");
        document.body.appendChild(link);
        link.click();
      }
      async function loadUsers() {
        const lista = await req("/usuarios");
        const tbody = el("lista-usuarios");
        if (!lista || lista.erro) {
          tbody.innerHTML =
            "<tr><td colspan='3'>Apenas admin pode ver isso.</td></tr>";
          return;
        }

        tbody.innerHTML = lista
          .map(
            (u) => `
        <tr>
            <td>${u.username}</td>
            <td>${u.role === "admin" ? "üõ°Ô∏è Admin" : "üë§ Usu√°rio"}</td>
            <td>
                ${
                  u.id !== 1
                    ? `<button class="btn btn-d" onclick="delUser(${u.id})">üóëÔ∏è</button>`
                    : ""
                }
            </td>
        </tr>
    `
          )
          .join("");
      }
      async function mudarSt(id, st) {
        // Envia ao backend
        const res = await req("/agenda/status", "POST", {
          id: id,
          status: st,
        });

        if (res && res.msg == "Ok") {
          showToast("Status alterado para: " + st);
          loadEspera(); // Recarrega a tela para mostrar a cor nova

          // Se mudou para "Em Atendimento", talvez queira atualizar o cockpit tamb√©m
          if (st === "Em Atendimento" || st === "Finalizado") {
            // Opcional: Se quiser for√ßar atualiza√ß√£o de outras telas
          }
        } else {
          showToast("Erro ao mudar status", "erro");
        }
      }

      async function addUser() {
        const user = val("u-new-user");
        const pass = val("u-new-pass");
        const role = val("u-new-role");

        // Coleta os checkboxes marcados
        const perms = Array.from(
          document.querySelectorAll(".perm-check:checked")
        ).map((el) => el.value);

        if (!user || !pass)
          return showToast("Preencha usu√°rio e senha", "erro");

        const res = await req("/usuarios/salvar", "POST", {
          username: user,
          password: pass,
          role: role,
          perms: perms, // Envia a lista para o banco
        });

        if (res && res.msg) {
          showToast("Usu√°rio criado com sucesso!");
          el("u-new-user").value = "";
          el("u-new-pass").value = "";
          loadUsers();
        } else {
          alert(res.erro || "Erro ao criar");
        }
      }
      let anexosAtuais = [],
        targetModelo = "";

      // Fun√ß√µes de Upload
      async function uploadGenerico(file) {
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(API + "/upload", {
          method: "POST",
          body: formData,
        });
        return res.ok ? await res.json() : null;
      }
      function dragOverHandler(ev) {
        ev.preventDefault();
      }
      function dropHandler(ev) {
        ev.preventDefault();
        handleFiles(ev.dataTransfer.files);
      }
      async function handleFiles(files) {
        for (let i = 0; i < files.length; i++) {
          showToast(`Enviando ${files[i].name}...`);
          const ret = await uploadGenerico(files[i]);
          if (ret) {
            anexosAtuais.push(ret);
            renderAnexos();
          }
        }
      }
      function renderAnexos() {
        el("lista-anexos").innerHTML = anexosAtuais
          .map(
            (a, idx) => `
        <div class="thumb-item" title="${a.arquivo}">
            <div class="thumb-remove" onclick="anexosAtuais.splice(${idx},1); renderAnexos()">X</div>
            
            <a href="${a.url}" target="_blank">
                ${
                  a.arquivo.match(/\.(jpg|jpeg|png|gif)$/i)
                    ? `<img src="${a.url}">`
                    : '<div style="display:flex;justify-content:center;align-items:center;height:100%;font-size:20px">üìÑ</div>'
                }
            </a>
        </div>`
          )
          .join("");
      }

      // Fun√ß√µes de Modelo
      async function abrirModelos(tipo) {
        // Mapeamento inteligente: tipo do modelo -> ID do textarea
        const mapa = {
          evolucao: "at-s", // Legado
          subjetivo: "at-s",
          objetivo: "at-o",
          avaliacao: "at-a",
          plano: "at-p",
          receita: "at-pres",
          exame: "at-exm",
        };

        targetModelo = mapa[tipo] || "at-s";
        el("mod-tipo-atual").value = tipo;
        el("m-modelos").style.display = "flex";

        const lista = await req(`/modelos?tipo=${tipo}`);
        let html = '<option value="">-- Selecione um Modelo --</option>';
        lista.forEach((m) => {
          html += `<option value="${m.id}" data-conteudo="${escapeDados(
            m.conteudo
          )}">${m.nome}</option>`;
        });
        el("lista-modelos-salvos").innerHTML = html;
        el("novo-modelo-nome").value = "";
        el("novo-modelo-conteudo").value = "";
      }
      function carregarConteudoModelo() {
        const sel = el("lista-modelos-salvos"),
          opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) {
          const div = document.createElement("div");
          div.innerHTML = JSON.parse(
            opt.dataset.conteudo.replace(/&quot;/g, '"')
          );
          el("novo-modelo-conteudo").value = div.innerText;
          el("novo-modelo-nome").value = opt.text;
        }
      }
      async function salvarModelo() {
        const tipo = el("mod-tipo-atual").value;
        const nome = el("novo-modelo-nome").value;
        const conteudo = el("novo-modelo-conteudo").value;
        const id = el("lista-modelos-salvos").value;

        if (!nome || !conteudo) {
          return alert(
            "Erro: Preencha o Nome e o Conte√∫do do modelo antes de salvar."
          );
        }

        const btn = document.querySelector("#m-modelos .btn-p");
        const txtOriginal = btn.innerText;
        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
          const res = await req("/modelos/salvar", "POST", {
            id: id,
            tipo: tipo,
            nome: nome,
            conteudo: conteudo,
          });

          if (res && res.msg) {
            showToast("‚úÖ Modelo Salvo com Sucesso!");
            // Recarrega a lista para mostrar o novo item
            await abrirModelos(tipo);

            // Se foi uma cria√ß√£o nova, limpa os campos para n√£o duplicar sem querer
            if (!id) {
              el("novo-modelo-nome").value = "";
              el("novo-modelo-conteudo").value = "";
            }
          } else {
            alert("Erro ao salvar no banco de dados.");
          }
        } catch (e) {
          console.error(e);
          alert("Erro de conex√£o ao salvar.");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      async function deletarModelo() {
        const id = el("lista-modelos-salvos").value;

        if (!id) return; // Se n√£o tiver nada selecionado, n√£o faz nada

        if (confirm("Tem certeza que deseja apagar este modelo para sempre?")) {
          const res = await req("/modelos/deletar/" + id, "DELETE");

          if (res && res.msg) {
            showToast("üóëÔ∏è Modelo apagado com sucesso!");
            // Recarrega a lista para sumir o item apagado
            await abrirModelos(el("mod-tipo-atual").value);
          } else {
            alert("Erro ao apagar modelo.");
          }
        }
      }
      function usarModelo() {
        const txt = el("novo-modelo-conteudo").value;
        if (targetModelo && txt) {
          const area = el(targetModelo);
          area.value = area.value + (area.value ? "\n\n" : "") + txt;
          closeM("m-modelos");
        }
      }

      // Impress√£o Profissional
      async function imprimirReceita() {
        const pNome = el("atend-pac-name").innerText.replace("Paciente: ", "");
        const pres = val("at-pres"),
          exames = val("at-exm"),
          profId = val("at-prof");
        const profs = await req("/profissionais");
        const profData = profs.find((p) => p.id == profId) || {};
        const nomeClinica = clinicConfig.nome_clinica || "Cl√≠nica M√©dica";
        const endereco = clinicConfig.endereco || "";

        let html = `
        <div class="receita-header"><h1>${nomeClinica}</h1><p>${endereco}</p></div>
        <div class="receita-body"><p><strong>Paciente:</strong> ${pNome}</p><p><strong>Data:</strong> ${new Date().toLocaleDateString()}</p><hr>
        ${
          pres
            ? `<div class="receita-section"><h3>Prescri√ß√£o</h3><pre style="font-family:inherit; white-space:pre-wrap">${pres}</pre></div>`
            : ""
        }
        ${
          exames
            ? `<div class="receita-section"><h3>Exames Solicitados</h3><pre style="font-family:inherit; white-space:pre-wrap">${exames}</pre></div>`
            : ""
        }
        </div>
        <div class="receita-footer">
            ${
              profData.assinatura_path
                ? `<img src="/uploads/${profData.assinatura_path}" class="assinatura-img">`
                : ""
            }
            <div class="linha-ass"></div><p><strong>${
              profData.nome
            }</strong></p><p>${profData.crm ? "CRM: " + profData.crm : ""}</p>
        </div>`;
        el("print-receita").innerHTML = html;
        window.print();
      }

      // Upload de Assinatura no Perfil
      async function uploadAssinatura() {
        const file = el("pr-assinatura-upload").files[0];
        if (file) {
          el("ass-status").innerText = "Enviando...";
          const ret = await uploadGenerico(file);
          if (ret) {
            el("pr-assinatura-path").value = ret.arquivo;
            el("ass-status").innerText = "‚úÖ Imagem carregada!";
          }
        }
      }
      async function uploadTabelaConvenio() {
        const file = el("cv-arquivo-upload").files[0];
        if (file) {
          el("cv-status-upload").innerText = "Enviando...";
          const ret = await uploadGenerico(file);
          if (ret) {
            el("cv-arquivo-path").value = ret.arquivo;
            el("cv-status-upload").innerText = "‚úÖ Arquivo anexado!";
            el("btn-ver-tabela").style.display = "block";
          }
        }
      }

      function verTabelaConvenio() {
        const arq = val("cv-arquivo-path");
        // CORRE√á√ÉO: Removemos "API +" pois a rota √© raiz (/uploads/...)
        if (arq) window.open("/uploads/" + arq, "_blank");
      }
      function imprimirRelatorio() {
        const titulo =
          el("rel-tipo").options[el("rel-tipo").selectedIndex].text;
        const dtIni = val("rel-ini").split("-").reverse().join("/");
        const dtFim = val("rel-fim").split("-").reverse().join("/");
        const htmlTabela = el("printable-area").innerHTML;
        const nomeClinica = clinicConfig.nome_clinica || "Cl√≠nica M√©dica";

        // 1. Verifica se j√° existe o iframe oculto, se n√£o, cria
        let iframe = document.getElementById("print-frame");
        if (!iframe) {
          iframe = document.createElement("iframe");
          iframe.id = "print-frame";
          document.body.appendChild(iframe);
        }

        // 2. Monta o conte√∫do HTML exclusivo para a impress√£o
        // Note que criamos um HTML completo do zero dentro do iframe
        const conteudo = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Impress√£o</title>
              <style>
                  body { font-family: sans-serif; margin: 20px; color: #000; }
                  .header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
                  h1 { margin: 0; font-size: 18pt; }
                  p { margin: 5px 0; font-size: 12pt; }
                  
                  table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                  
                  /* For√ßa bordas e cor preta para o papel */
                  th { 
                      background: #eee; 
                      color: #000; 
                      font-weight: bold; 
                      border: 1px solid #000; 
                      padding: 6px; 
                      text-align: left;
                  }
                  
                  td { 
                      border: 1px solid #000; 
                      padding: 6px; 
                      color: #000; 
                  }
                  
                  /* Remove o visual de "bot√£o/badge" para economizar tinta */
                  .status-badge {
                      border: none;
                      background: transparent;
                      color: #000;
                      font-weight: bold;
                      padding: 0;
                  }
                  
                  .no-print { display: none; }
              </style>
            </head>
            <body>
              <div class="header">
                  <h1>${nomeClinica}</h1>
                  <p>Relat√≥rio: <strong>${titulo}</strong></p>
                  <p><small>Per√≠odo: ${dtIni} at√© ${dtFim}</small></p>
              </div>

              ${htmlTabela}

              <div style="margin-top: 30px; font-size: 8pt; text-align: right; border-top: 1px solid #000; padding-top: 5px;">
                  Gerado em ${new Date().toLocaleString()}
              </div>
            </body>
            </html>
          `;

        // 3. Escreve no Iframe
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(conteudo);
        doc.close();

        // 4. Manda o Iframe imprimir (O sistema principal fica intacto no fundo)
        setTimeout(() => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        }, 500);
      }
      function aplicarPermissoes(permissoes, role) {
        // Converte string JSON para array se necess√°rio
        let userPerms = [];
        try {
          userPerms =
            typeof permissoes === "string"
              ? JSON.parse(permissoes)
              : permissoes;
        } catch (e) {
          userPerms = [];
        }

        // Admin v√™ tudo
        if (role === "admin") {
          document
            .querySelectorAll("nav button")
            .forEach((b) => (b.style.display = "flex"));
          // Garante que o dashboard mostre dinheiro se a API retornar
          return;
        }

        // Usu√°rio Comum: Filtra bot√µes da barra lateral
        document.querySelectorAll("nav button").forEach((btn) => {
          const span = btn.querySelector("span");
          if (!span) return;

          const texto = span.innerText.toLowerCase();
          let permitido = false;

          // Telas b√°sicas sempre liberadas
          if (
            texto.includes("dashboard") ||
            texto.includes("espera") ||
            texto.includes("atendimento") ||
            texto.includes("minha conta") ||
            texto.includes("sair")
          ) {
            permitido = true;
          }
          // Telas condicionais (baseadas nos checkboxes)
          else if (
            texto.includes("pacientes") &&
            userPerms.includes("pacientes")
          )
            permitido = true;
          else if (
            texto.includes("profissionais") &&
            userPerms.includes("profissionais")
          )
            permitido = true;
          else if (texto.includes("agenda") && userPerms.includes("agenda"))
            permitido = true;
          else if (
            texto.includes("financeiro") &&
            userPerms.includes("financeiro")
          )
            permitido = true;
          else if (
            texto.includes("relat√≥rios") &&
            userPerms.includes("relatorios")
          )
            permitido = true;

          // Cadastros, Backup, etc normalmente bloqueados para user comum, a menos que adicione checkbox pra isso
          // Aqui vamos manter bloqueado "Cadastros" para users comuns por seguran√ßa padr√£o
          if (texto.includes("cadastros")) permitido = false;

          btn.style.display = permitido ? "flex" : "none";
        });
      }

      async function delUser(id) {
        if (confirm("Remover acesso deste usu√°rio?")) {
          await req("/usuarios/deletar/" + id, "DELETE");
          loadUsers();
        }
      }
      async function verHistoricoPaciente(id) {
        if (!id) return;

        const btn = event.target.closest("button");
        const txtOriginal = btn ? btn.innerText : "";
        if (btn) {
          btn.innerText = "‚è≥";
          btn.disabled = true;
        }

        try {
          const h = await req("/prontuario/" + id);
          const modalBody = el("conteudo-leitura");

          // 1. Cabe√ßalho Bonito (Agora inclui o bot√£o de fechar)
          const headerHtml = `
            <div style="
                padding: 15px 20px; 
                border-bottom: 1px solid var(--border); 
                background: var(--bg-card); 
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                flex-shrink: 0; /* Garante que o header n√£o encolha */
            ">
                <div>
                    <h2 style="color:var(--primary); margin:0; display:flex; align-items:center; gap:10px; font-size: 1.2rem;">
                        üìÇ Hist√≥rico do Paciente
                    </h2>
                    <p style="color:var(--muted); font-size:0.8rem; margin-top:4px;">
                        ${
                          h && h.length
                            ? `Encontrados <strong>${h.length}</strong> registros.`
                            : "Nenhum registro."
                        }
                    </p>
                </div>
                <button class="btn btn-d" onclick="closeM('m-leitura')">X</button>
            </div>
        `;

          // 2. Montagem da Lista
          let listaHtml = "";

          if (!h || h.length === 0) {
            listaHtml = `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); padding: 40px;">
                <div style="font-size:3rem; margin-bottom:10px; opacity:0.3">üì≠</div>
                <h3>Prontu√°rio Vazio</h3>
                <p>Nenhum atendimento registrado.</p>
            </div>`;
          } else {
            // Nota: Removemos o max-height fixo e usamos flex:1 para ocupar o espa√ßo restante
            listaHtml =
              `<div class="lista-historico-container" style="flex: 1; overflow-y: auto; padding: 15px;">` +
              h
                .map((i) => {
                  const d = new Date(i.data_atendimento.replace(" ", "T"));

                  const dia = d.getDate().toString().padStart(2, "0");
                  const mes = d
                    .toLocaleDateString("pt-BR", { month: "short" })
                    .replace(".", "");
                  const ano = d.getFullYear();
                  const hora = d.toLocaleTimeString("pt-BR", {
                    hour: "2-digit",
                    minute: "2-digit",
                  });

                  let resumo =
                    i.queixa_principal ||
                    i.diagnostico ||
                    "Atendimento Cl√≠nico";
                  if (resumo.length > 50)
                    resumo = resumo.substring(0, 50) + "...";

                  let temAnexo = false;
                  try {
                    if (i.anexos && JSON.parse(i.anexos).length > 0)
                      temAnexo = true;
                  } catch (e) {}
                  const temReceita = !!i.prescricao;

                  return `
                <div class="card-historico" onclick='closeM("m-leitura"); abrirHistoricoFull(${escapeDados(
                  i
                )})'>
                    
                    <div class="card-hist-date">
                        <span class="ch-dia">${dia}</span>
                        <span class="ch-mes">${mes}</span>
                        <span class="ch-ano">${ano}</span>
                    </div>

                    <div class="card-hist-content">
                        <div class="ch-prof">
                            üë®‚Äç‚öïÔ∏è ${
                              i.profissional.split(" ")[0]
                            } <span style="color:var(--muted); font-weight:normal">‚Ä¢ ${hora}h</span>
                        </div>
                        <div class="ch-resumo">${resumo}</div>
                        
                        <div class="ch-tags">
                            ${
                              temReceita
                                ? '<span class="tag-badge" style="color:#60a5fa">üíä Receita</span>'
                                : ""
                            }
                            ${
                              temAnexo
                                ? '<span class="tag-badge" style="color:#f59e0b">üìé Anexos</span>'
                                : ""
                            }
                            ${
                              i.retificacao
                                ? '<span class="tag-badge" style="color:#ef4444">‚ö†Ô∏è Retificado</span>'
                                : ""
                            }
                        </div>
                    </div>

                    <div class="card-hist-arrow">‚ùØ</div>
                </div>
            `;
                })
                .join("") +
              `</div>`;
          }
          let alteracoesMatriz = {};

          async function abrirMatrizPrecos() {
            const btn = event.target;
            // Evita erro se o clique n√£o vier de um bot√£o direto
            if (btn) {
              const txt = btn.innerText;
              btn.innerText = "‚è≥ Carregando...";
            }

            try {
              const dados = await req("/matriz_precos");
              if (!dados) return;

              alteracoesMatriz = {};
              const thead = el("matriz-head");
              const tbody = el("matriz-body");

              // 1. Monta Cabe√ßalho
              let htmlHead = `<tr><th class="th-matriz th-fixo">Procedimento / TUSS</th>`;
              dados.convs.forEach((c) => {
                htmlHead += `<th class="th-matriz">${c.nome}</th>`;
              });
              htmlHead += `</tr>`;
              thead.innerHTML = htmlHead;

              // 2. Monta Corpo
              let htmlBody = "";
              dados.procs.forEach((p) => {
                htmlBody += `<tr>`;
                htmlBody += `<td class="td-matriz th-fixo" style="padding:0 15px; display:flex; align-items:center; height:46px">
                                  <div>
                                      <div style="color:white; font-weight:500">${
                                        p.nome
                                      }</div>
                                      <div style="color:#666; font-size:0.75rem">${
                                        p.codigo_tuss || "Sem c√≥d."
                                      }</div>
                                  </div>
                               </td>`;

                dados.convs.forEach((c) => {
                  const chave = `${p.id}_${c.id}`;
                  const valor = dados.mapa[chave] || "";
                  htmlBody += `<td class="td-matriz">
                                      <input type="number" step="0.01" 
                                             class="input-matriz" 
                                             value="${valor}" 
                                             placeholder="--"
                                             onchange="registrarAlteracao(${p.id}, ${c.id}, this)"
                                             onkeydown="navegarMatriz(event, this)">
                                   </td>`;
                });
                htmlBody += `</tr>`;
              });
              tbody.innerHTML = htmlBody;

              el("m-matriz").style.display = "flex";
            } catch (e) {
              console.error(e);
              alert("Erro ao carregar matriz: " + e);
            } finally {
              if (btn) btn.innerText = "üí∞ Matriz de Pre√ßos";
            }
          }

          function registrarAlteracao(procId, convId, input) {
            const chave = `${procId}_${convId}`;
            alteracoesMatriz[chave] = {
              proc_id: procId,
              conv_id: convId,
              valor: input.value,
            };
            input.classList.add("input-changed");
          }

          function navegarMatriz(e, input) {
            const td = input.parentElement;
            const tr = td.parentElement;
            const colIndex = Array.from(tr.children).indexOf(td);
            let target = null;
            if (e.key === "ArrowDown") {
              const nextRow = tr.nextElementSibling;
              if (nextRow)
                target = nextRow.children[colIndex].querySelector("input");
            } else if (e.key === "ArrowUp") {
              const prevRow = tr.previousElementSibling;
              if (prevRow)
                target = prevRow.children[colIndex].querySelector("input");
            }
            if (target) {
              e.preventDefault();
              target.focus();
            }
          }

          async function salvarMatriz() {
            const lista = Object.values(alteracoesMatriz);
            if (lista.length === 0)
              return showToast("Nenhuma altera√ß√£o para salvar.");

            const btn = document.querySelector("#m-matriz .btn-p");
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const res = await req("/matriz_precos/salvar", "POST", {
              alteracoes: lista,
            });

            if (res && res.msg) {
              showToast(res.msg);
              alteracoesMatriz = {};
              document
                .querySelectorAll(".input-changed")
                .forEach((i) => i.classList.remove("input-changed"));
            } else {
              alert("Erro ao salvar");
            }

            btn.innerText = "üíæ SALVAR ALTERA√á√ïES";
            btn.disabled = false;
          }

          // 3. Aplica ao Modal
          modalBody.innerHTML = headerHtml + listaHtml;
          el("m-leitura").style.display = "flex";
        } catch (e) {
          console.error(e);
          showToast("Erro ao carregar hist√≥rico", "erro");
        } finally {
          if (btn) {
            btn.innerText = txtOriginal;
            btn.disabled = false;
          }
        }
      }
      // Formatadores
      const moeda = (v) =>
        parseFloat(v || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      const fmtData = (d) => (d ? d.split("-").reverse().join("/") : "-");
      const fmtDataHora = (dh) =>
        dh
          ? dh.substring(8, 10) +
            "/" +
            dh.substring(5, 7) +
            " " +
            dh.substring(11, 16)
          : "-";

      // ==================================================
      // üí∞ CORRE√á√ÉO: MATRIZ DE PRE√áOS (ESCOPO GLOBAL)
      // ==================================================

      let matrizCacheAlteracoes = {};

      async function abrirMatrizPrecos() {
        const btn = event ? event.target : null;
        if (btn && btn.tagName === "BUTTON") {
          btn.dataset.originalText = btn.innerText;
          btn.innerText = "‚è≥ Carregando...";
          btn.disabled = true;
        }

        try {
          const dados = await req("/matriz_precos");
          if (!dados) throw "Sem dados";

          matrizCacheAlteracoes = {};
          const thead = el("matriz-head");
          const tbody = el("matriz-body");

          // 1. Monta Cabe√ßalho
          let htmlHead = `<tr><th class="th-matriz th-fixo">Procedimento / TUSS</th>`;
          dados.convs.forEach((c) => {
            htmlHead += `<th class="th-matriz">${c.nome}</th>`;
          });
          htmlHead += `</tr>`;
          thead.innerHTML = htmlHead;

          // 2. Monta Corpo
          let htmlBody = "";
          dados.procs.forEach((p) => {
            htmlBody += `<tr>`;
            htmlBody += `<td class="td-matriz th-fixo" style="padding:0 15px; display:flex; align-items:center; height:46px">
                                  <div>
                                      <div style="color:white; font-weight:500">${
                                        p.nome
                                      }</div>
                                      <div style="color:#666; font-size:0.75rem">${
                                        p.codigo_tuss || "Sem c√≥d."
                                      }</div>
                                  </div>
                               </td>`;

            dados.convs.forEach((c) => {
              const chave = `${p.id}_${c.id}`;
              // Formata valor inicial para R$ 0,00
              let valorRaw = dados.mapa[chave];
              let valorFmt = "";
              if (valorRaw !== undefined && valorRaw !== null) {
                valorFmt =
                  "R$ " +
                  parseFloat(valorRaw).toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  });
              }

              htmlBody += `<td class="td-matriz">
                                      <input type="text" 
                                             class="input-matriz" 
                                             value="${valorFmt}" 
                                             placeholder="--"
                                             onfocus="this.select()"
                                             onchange="registrarAlteracaoGlobal(${p.id}, ${c.id}, this)"
                                             onkeydown="navegarMatrizGlobal(event, this)">
                                   </td>`;
            });
            htmlBody += `</tr>`;
          });
          tbody.innerHTML = htmlBody;

          el("m-matriz").style.display = "flex";
        } catch (e) {
          console.error(e);
          alert(
            "Erro ao carregar matriz. Verifique se o servidor est√° rodando."
          );
        } finally {
          if (btn && btn.tagName === "BUTTON") {
            btn.innerText = btn.dataset.originalText || "üí∞ Matriz de Pre√ßos";
            btn.disabled = false;
          }
        }
      }

      function registrarAlteracaoGlobal(procId, convId, input) {
        // 1. Limpa o valor visual para salvar no banco (R$ 1.200,50 -> 1200.50)
        let texto = input.value;
        // Remove R$, espa√ßos e pontos de milhar, troca v√≠rgula por ponto
        let limpo = texto
          .replace("R$", "")
          .replace(/\s/g, "")
          .replace(/\./g, "")
          .replace(",", ".");

        let valorFloat = parseFloat(limpo);

        if (isNaN(valorFloat)) {
          valorFloat = 0; // Se digitar besteira, vira zero
        }

        // 2. Registra a altera√ß√£o "pura" para o banco
        const chave = `${procId}_${convId}`;
        matrizCacheAlteracoes[chave] = {
          proc_id: procId,
          conv_id: convId,
          valor: valorFloat,
        };

        // 3. Devolve formatado bonito para o usu√°rio (R$)
        input.value =
          "R$ " +
          valorFloat.toLocaleString("pt-BR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

        input.classList.add("input-changed");
      }

      function navegarMatrizGlobal(e, input) {
        const td = input.parentElement;
        const tr = td.parentElement;
        const colIndex = Array.from(tr.children).indexOf(td);
        let target = null;

        if (e.key === "ArrowDown") {
          const nextRow = tr.nextElementSibling;
          if (nextRow)
            target = nextRow.children[colIndex].querySelector("input");
        } else if (e.key === "ArrowUp") {
          const prevRow = tr.previousElementSibling;
          if (prevRow)
            target = prevRow.children[colIndex].querySelector("input");
        }

        if (target) {
          e.preventDefault();
          target.focus();
        }
      }

      async function salvarMatriz() {
        const lista = Object.values(matrizCacheAlteracoes);
        if (lista.length === 0)
          return showToast("Nenhuma altera√ß√£o para salvar.");

        const btn = document.querySelector("#m-matriz .btn-p");
        const txtOriginal = btn.innerText;
        btn.innerText = "Salvando...";
        btn.disabled = true;

        try {
          const res = await req("/matriz_precos/salvar", "POST", {
            alteracoes: lista,
          });

          if (res && res.msg) {
            showToast(res.msg);
            matrizCacheAlteracoes = {};
            document
              .querySelectorAll(".input-changed")
              .forEach((i) => i.classList.remove("input-changed"));
          } else {
            alert("Erro ao salvar");
          }
        } catch (e) {
          console.error(e);
          alert("Erro de conex√£o");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      }
      window.onload = checkAuth;
    </script>
  </body>
</html>
